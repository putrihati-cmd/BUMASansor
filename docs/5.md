PROMPT 2.4: Admin Dashboard & Management (Flutter)
markdownBuatkan Flutter Admin Dashboard lengkap dengan fitur management warung, produk, dan reporting.

REQUIREMENTS:
1. Dashboard overview (omzet, piutang, laba, kas)
2. Warung management (CRUD, credit limit, block/unblock)
3. Product management (CRUD, stock levels)
4. Delivery Order creation
5. Reports & analytics
6. Real-time data dengan auto-refresh

GENERATE FILES:

1. `lib/presentation/screens/admin/admin_dashboard_screen.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:fl_chart/fl_chart.dart';
import '../../providers/dashboard_provider.dart';
import '../../widgets/dashboard_card.dart';
import '../../widgets/chart_widget.dart';

class AdminDashboardScreen extends ConsumerStatefulWidget {
  const AdminDashboardScreen({super.key});

  @override
  ConsumerState createState() => _AdminDashboardScreenState();
}

class _AdminDashboardScreenState extends ConsumerState {
  int _selectedIndex = 0;

  @override
  void initState() {
    super.initState();
    // Load dashboard data
    Future.microtask(() {
      ref.read(dashboardProvider.notifier).loadDashboard();
    });
  }

  void _onNavItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
    
    // Navigate to different screens based on index
    switch (index) {
      case 0:
        // Dashboard (current)
        break;
      case 1:
        // Navigate to Warung Management
        Navigator.pushNamed(context, '/admin/warungs');
        break;
      case 2:
        // Navigate to Product Management
        Navigator.pushNamed(context, '/admin/products');
        break;
      case 3:
        // Navigate to Reports
        Navigator.pushNamed(context, '/admin/reports');
        break;
    }
  }

  @override
  Widget build(BuildContext context) {
    final dashboardState = ref.watch(dashboardProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('Admin Dashboard'),
        actions: [
          IconButton(
            icon: const Icon(Icons.notifications_outlined),
            onPressed: () {
              // Navigate to notifications
            },
          ),
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () {
              ref.read(dashboardProvider.notifier).loadDashboard();
            },
          ),
        ],
      ),
      body: RefreshIndicator(
        onRefresh: () async {
          await ref.read(dashboardProvider.notifier).loadDashboard();
        },
        child: dashboardState.when(
          data: (dashboard) => SingleChildScrollView(
            padding: EdgeInsets.all(16.w),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Today's summary cards
                Text(
                  'Ringkasan Hari Ini',
                  style: TextStyle(
                    fontSize: 18.sp,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 12.h),
                Row(
                  children: [
                    Expanded(
                      child: DashboardCard(
                        title: 'Omzet',
                        value: 'Rp ${dashboard.today.omzet.toStringAsFixed(0)}',
                        icon: Icons.attach_money,
                        color: Colors.green,
                        trend: '+12.5%',
                      ),
                    ),
                    SizedBox(width: 12.w),
                    Expanded(
                      child: DashboardCard(
                        title: 'Laba Bersih',
                        value: 'Rp ${dashboard.today.labaHariIni.toStringAsFixed(0)}',
                        icon: Icons.trending_up,
                        color: Colors.blue,
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 12.h),
                Row(
                  children: [
                    Expanded(
                      child: DashboardCard(
                        title: 'Piutang',
                        value: 'Rp ${dashboard.today.piutangBelumLunas.toStringAsFixed(0)}',
                        icon: Icons.account_balance_wallet,
                        color: Colors.orange,
                        trend: '-5.2%',
                      ),
                    ),
                    SizedBox(width: 12.w),
                    Expanded(
                      child: DashboardCard(
                        title: 'Kas/Bank',
                        value: 'Rp ${dashboard.today.kasBank.toStringAsFixed(0)}',
                        icon: Icons.account_balance,
                        color: Colors.purple,
                      ),
                    ),
                  ],
                ),

                SizedBox(height: 24.h),

                // Chart
                Text(
                  'Omzet & Pengeluaran Bulanan',
                  style: TextStyle(
                    fontSize: 18.sp,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 12.h),
                Card(
                  child: Padding(
                    padding: EdgeInsets.all(16.w),
                    child: SizedBox(
                      height: 200.h,
                      child: MonthlyChart(
                        omzetData: dashboard.chart.omzetBulanan.omzet,
                        pengeluaranData: dashboard.chart.omzetBulanan.pengeluaran,
                        labels: dashboard.chart.omzetBulanan.labels,
                      ),
                    ),
                  ),
                ),

                SizedBox(height: 24.h),

                // Warung stats
                Row(
                  children: [
                    Expanded(
                      child: Card(
                        color: Colors.green[50],
                        child: Padding(
                          padding: EdgeInsets.all(16.w),
                          child: Column(
                            children: [
                              Icon(
                                Icons.store,
                                size: 40.sp,
                                color: Colors.green[700],
                              ),
                              SizedBox(height: 8.h),
                              Text(
                                '${dashboard.warung.totalAktif}',
                                style: TextStyle(
                                  fontSize: 24.sp,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.green[700],
                                ),
                              ),
                              Text(
                                'Warung Aktif',
                                style: TextStyle(
                                  fontSize: 14.sp,
                                  color: Colors.green[700],
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                    SizedBox(width: 12.w),
                    Expanded(
                      child: Card(
                        color: Colors.red[50],
                        child: Padding(
                          padding: EdgeInsets.all(16.w),
                          child: Column(
                            children: [
                              Icon(
                                Icons.block,
                                size: 40.sp,
                                color: Colors.red[700],
                              ),
                              SizedBox(height: 8.h),
                              Text(
                                '${dashboard.warung.totalBlocked}',
                                style: TextStyle(
                                  fontSize: 24.sp,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.red[700],
                                ),
                              ),
                              Text(
                                'Warung Blocked',
                                style: TextStyle(
                                  fontSize: 14.sp,
                                  color: Colors.red[700],
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ],
                ),

                SizedBox(height: 24.h),

                // Top products
                Text(
                  'Produk Terlaris',
                  style: TextStyle(
                    fontSize: 18.sp,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 12.h),
                Card(
                  child: ListView.separated(
                    shrinkWrap: true,
                    physics: const NeverScrollableScrollPhysics(),
                    padding: EdgeInsets.all(16.w),
                    itemCount: dashboard.topProducts.length,
                    separatorBuilder: (context, index) => Divider(height: 24.h),
                    itemBuilder: (context, index) {
                      final product = dashboard.topProducts[index];
                      return Row(
                        children: [
                          Container(
                            width: 40.w,
                            height: 40.w,
                            decoration: BoxDecoration(
                              color: Theme.of(context).primaryColor.withOpacity(0.1),
                              borderRadius: BorderRadius.circular(8.r),
                            ),
                            child: Center(
                              child: Text(
                                '${index + 1}',
                                style: TextStyle(
                                  fontSize: 18.sp,
                                  fontWeight: FontWeight.bold,
                                  color: Theme.of(context).primaryColor,
                                ),
                              ),
                            ),
                          ),
                          SizedBox(width: 12.w),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  product.productName,
                                  style: TextStyle(
                                    fontSize: 14.sp,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                SizedBox(height: 4.h),
                                Text(
                                  '${product.totalSold} terjual',
                                  style: TextStyle(
                                    fontSize: 12.sp,
                                    color: Colors.grey[600],
                                  ),
                                ),
                              ],
                            ),
                          ),
                          Text(
                            'Rp ${product.revenue.toStringAsFixed(0)}',
                            style: TextStyle(
                              fontSize: 14.sp,
                              fontWeight: FontWeight.bold,
                              color: Theme.of(context).primaryColor,
                            ),
                          ),
                        ],
                      );
                    },
                  ),
                ),

                SizedBox(height: 24.h),

                // Quick actions
                Text(
                  'Aksi Cepat',
                  style: TextStyle(
                    fontSize: 18.sp,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 12.h),
                Row(
                  children: [
                    Expanded(
                      child: _buildQuickActionCard(
                        context,
                        'Buat DO',
                        Icons.local_shipping,
                        Colors.blue,
                        () {
                          Navigator.pushNamed(context, '/admin/create-do');
                        },
                      ),
                    ),
                    SizedBox(width: 12.w),
                    Expanded(
                      child: _buildQuickActionCard(
                        context,
                        'Tambah Produk',
                        Icons.add_box,
                        Colors.green,
                        () {
                          Navigator.pushNamed(context, '/admin/add-product');
                        },
                      ),
                    ),
                  ],
                ),
                SizedBox(height: 12.h),
                Row(
                  children: [
                    Expanded(
                      child: _buildQuickActionCard(
                        context,
                        'Verifikasi Bayar',
                        Icons.payment,
                        Colors.orange,
                        () {
                          Navigator.pushNamed(context, '/admin/verify-payments');
                        },
                      ),
                    ),
                    SizedBox(width: 12.w),
                    Expanded(
                      child: _buildQuickActionCard(
                        context,
                        'Laporan',
                        Icons.assessment,
                        Colors.purple,
                        () {
                          Navigator.pushNamed(context, '/admin/reports');
                        },
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          loading: () => const Center(child: CircularProgressIndicator()),
          error: (error, stack) => Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.error_outline, size: 60.sp, color: Colors.red),
                SizedBox(height: 16.h),
                Text('Error: $error'),
                SizedBox(height: 16.h),
                ElevatedButton(
                  onPressed: () {
                    ref.read(dashboardProvider.notifier).loadDashboard();
                  },
                  child: const Text('Retry'),
                ),
              ],
            ),
          ),
        ),
      ),
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _selectedIndex,
        onTap: _onNavItemTapped,
        type: BottomNavigationBarType.fixed,
        items: const [
          BottomNavigationBarItem(
            icon: Icon(Icons.dashboard),
            label: 'Dashboard',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.store),
            label: 'Warung',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.inventory),
            label: 'Produk',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.assessment),
            label: 'Laporan',
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          Navigator.pushNamed(context, '/admin/create-do');
        },
        child: const Icon(Icons.add),
      ),
    );
  }

  Widget _buildQuickActionCard(
    BuildContext context,
    String title,
    IconData icon,
    Color color,
    VoidCallback onTap,
  ) {
    return Card(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12.r),
        child: Padding(
          padding: EdgeInsets.all(16.w),
          child: Column(
            children: [
              Icon(icon, size: 32.sp, color: color),
              SizedBox(height: 8.h),
              Text(
                title,
                style: TextStyle(
                  fontSize: 14.sp,
                  fontWeight: FontWeight.w600,
                ),
                textAlign: TextAlign.center,
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

2. `lib/presentation/screens/admin/warung_management_screen.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import '../../providers/warung_provider.dart';
import '../../widgets/warung_card.dart';
import 'warung_form_screen.dart';

class WarungManagementScreen extends ConsumerStatefulWidget {
  const WarungManagementScreen({super.key});

  @override
  ConsumerState createState() => _WarungManagementScreenState();
}

class _WarungManagementScreenState extends ConsumerState {
  final _searchController = TextEditingController();
  bool _showBlockedOnly = false;

  @override
  void initState() {
    super.initState();
    Future.microtask(() {
      ref.read(warungProvider.notifier).loadWarungs();
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final warungs = ref.watch(warungProvider);
    
    return Scaffold(
      appBar: AppBar(
        title: const Text('Manajemen Warung'),
        actions: [
          IconButton(
            icon: const Icon(Icons.filter_list),
            onPressed: () {
              setState(() {
                _showBlockedOnly = !_showBlockedOnly;
              });
            },
          ),
        ],
      ),
      body: Column(
        children: [
          // Search bar
          Padding(
            padding: EdgeInsets.all(16.w),
            child: TextField(
              controller: _searchController,
              decoration: InputDecoration(
                hintText: 'Cari warung...',
                prefixIcon: const Icon(Icons.search),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                filled: true,
              ),
              onChanged: (value) {
                // TODO: Implement search
              },
            ),
          ),

          // Filter chip
          if (_showBlockedOnly)
            Padding(
              padding: EdgeInsets.symmetric(horizontal: 16.w),
              child: Align(
                alignment: Alignment.centerLeft,
                child: Chip(
                  label: const Text('Warung Blocked'),
                  onDeleted: () {
                    setState(() {
                      _showBlockedOnly = false;
                    });
                  },
                  backgroundColor: Colors.red[100],
                ),
              ),
            ),

          // Warung list
          Expanded(
            child: warungs.when(
              data: (warungList) {
                final filteredList = _showBlockedOnly
                    ? warungList.where((w) => w.isBlocked).toList()
                    : warungList;

                if (filteredList.isEmpty) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.store_outlined,
                          size: 80.sp,
                          color: Colors.grey[300],
                        ),
                        SizedBox(height: 16.h),
                        Text(
                          'Tidak ada warung',
                          style: TextStyle(
                            fontSize: 16.sp,
                            color: Colors.grey[600],
                          ),
                        ),
                      ],
                    ),
                  );
                }

                return RefreshIndicator(
                  onRefresh: () async {
                    await ref.read(warungProvider.notifier).loadWarungs();
                  },
                  child: ListView.separated(
                    padding: EdgeInsets.all(16.w),
                    itemCount: filteredList.length,
                    separatorBuilder: (context, index) => SizedBox(height: 12.h),
                    itemBuilder: (context, index) {
                      return WarungCard(
                        warung: filteredList[index],
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(
                              builder: (context) => WarungFormScreen(
                                warung: filteredList[index],
                              ),
                            ),
                          );
                        },
                        onBlock: () async {
                          final confirm = await showDialog(
                            context: context,
                            builder: (context) => AlertDialog(
                              title: const Text('Konfirmasi'),
                              content: Text(
                                filteredList[index].isBlocked
                                    ? 'Unblock warung ini?'
                                    : 'Block warung ini?',
                              ),
                              actions: [
                                TextButton(
                                  onPressed: () => Navigator.pop(context, false),
                                  child: const Text('Batal'),
                                ),
                                TextButton(
                                  onPressed: () => Navigator.pop(context, true),
                                  child: const Text('Ya'),
                                ),
                              ],
                            ),
                          );

                          if (confirm == true) {
                            if (filteredList[index].isBlocked) {
                              await ref.read(warungProvider.notifier).unblockWarung(
                                    filteredList[index].id,
                                  );
                            } else {
                              await ref.read(warungProvider.notifier).blockWarung(
                                    filteredList[index].id,
                                    'Overdue payment',
                                  );
                            }
                          }
                        },
                      );
                    },
                  ),
                );
              },
              loading: () => const Center(child: CircularProgressIndicator()),
              error: (error, stack) => Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.error_outline, size: 60.sp, color: Colors.red),
                    SizedBox(height: 16.h),
                    Text('Error: $error'),
                    SizedBox(height: 16.h),
                    ElevatedButton(
                      onPressed: () {
                        ref.read(warungProvider.notifier).loadWarungs();
                      },
                      child: const Text('Retry'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => const WarungFormScreen(),
            ),
          );
        },
        icon: const Icon(Icons.add),
        label: const Text('Tambah Warung'),
      ),
    );
  }
}
```

3. `lib/presentation/widgets/dashboard_card.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';

class DashboardCard extends StatelessWidget {
  final String title;
  final String value;
  final IconData icon;
  final Color color;
  final String? trend;

  const DashboardCard({
    super.key,
    required this.title,
    required this.value,
    required this.icon,
    required this.color,
    this.trend,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 2,
      child: Container(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Container(
                  padding: EdgeInsets.all(8.w),
                  decoration: BoxDecoration(
                    color: color.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8.r),
                  ),
                  child: Icon(icon, color: color, size: 24.sp),
                ),
                const Spacer(),
                if (trend != null)
                  Container(
                    padding: EdgeInsets.symmetric(
                      horizontal: 8.w,
                      vertical: 4.h,
                    ),
                    decoration: BoxDecoration(
                      color: trend!.startsWith('+')
                          ? Colors.green[50]
                          : Colors.red[50],
                      borderRadius: BorderRadius.circular(4.r),
                    ),
                    child: Text(
                      trend!,
                      style: TextStyle(
                        fontSize: 12.sp,
                        fontWeight: FontWeight.bold,
                        color: trend!.startsWith('+')
                            ? Colors.green[700]
                            : Colors.red[700],
                      ),
                    ),
                  ),
              ],
            ),
            SizedBox(height: 12.h),
            Text(
              title,
              style: TextStyle(
                fontSize: 12.sp,
                color: Colors.grey[600],
              ),
            ),
            SizedBox(height: 4.h),
            Text(
              value,
              style: TextStyle(
                fontSize: 18.sp,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

4. `lib/presentation/widgets/chart_widget.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';

class MonthlyChart extends StatelessWidget {
  final List omzetData;
  final List pengeluaranData;
  final List labels;

  const MonthlyChart({
    super.key,
    required this.omzetData,
    required this.pengeluaranData,
    required this.labels,
  });

  @override
  Widget build(BuildContext context) {
    return LineChart(
      LineChartData(
        gridData: FlGridData(show: true),
        titlesData: FlTitlesData(
          leftTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              reservedSize: 40.w,
              getTitlesWidget: (value, meta) {
                return Text(
                  '${(value / 1000000).toStringAsFixed(0)}M',
                  style: TextStyle(fontSize: 10.sp),
                );
              },
            ),
          ),
          bottomTitles: AxisTitles(
            sideTitles: SideTitles(
              showTitles: true,
              getTitlesWidget: (value, meta) {
                if (value.toInt() >= 0 && value.toInt() < labels.length) {
                  return Text(
                    labels[value.toInt()],
                    style: TextStyle(fontSize: 10.sp),
                  );
                }
                return const Text('');
              },
            ),
          ),
          rightTitles: const AxisTitles(
            sideTitles: SideTitles(showTitles: false),
          ),
          topTitles: const AxisTitles(
            sideTitles: SideTitles(showTitles: false),
          ),
        ),
        borderData: FlBorderData(show: true),
        lineBarsData: [
          // Omzet line
          LineChartBarData(
            spots: omzetData
                .asMap()
                .entries
                .map((e) => FlSpot(e.key.toDouble(), e.value))
                .toList(),
            isCurved: true,
            color: Colors.green,
            barWidth: 3,
            dotData: const FlDotData(show: true),
            belowBarData: BarAreaData(
              show: true,
              color: Colors.green.withOpacity(0.1),
            ),
          ),
          // Pengeluaran line
          LineChartBarData(
            spots: pengeluaranData
                .asMap()
                .entries
                .map((e) => FlSpot(e.key.toDouble(), e.value))
                .toList(),
            isCurved: true,
            color: Colors.red,
            barWidth: 3,
            dotData: const FlDotData(show: true),
            belowBarData: BarAreaData(
              show: true,
              color: Colors.red.withOpacity(0.1),
            ),
          ),
        ],
      ),
    );
  }
}
```

5. `lib/data/models/dashboard_model.dart`:
```dart
import 'package:freezed_annotation/freezed_annotation.dart';

part 'dashboard_model.freezed.dart';
part 'dashboard_model.g.dart';

@freezed
class DashboardModel with _$DashboardModel {
  const factory DashboardModel({
    required TodaySummary today,
    required ChartData chart,
    required WarungStats warung,
    required StockStats stocks,
    required List topProducts,
  }) = _DashboardModel;

  factory DashboardModel.fromJson(Map json) =>
      _$DashboardModelFromJson(json);
}

@freezed
class TodaySummary with _$TodaySummary {
  const factory TodaySummary({
    required double omzet,
    required double piutangBelumLunas,
    required double labaHariIni,
    required double kasBank,
  }) = _TodaySummary;

  factory TodaySummary.fromJson(Map json) =>
      _$TodaySummaryFromJson(json);
}

@freezed
class ChartData with _$ChartData {
  const factory ChartData({
    required MonthlyChartData omzetBulanan,
  }) = _ChartData;

  factory ChartData.fromJson(Map json) =>
      _$ChartDataFromJson(json);
}

@freezed
class MonthlyChartData with _$MonthlyChartData {
  const factory MonthlyChartData({
    required List labels,
    required List omzet,
    required List pengeluaran,
  }) = _MonthlyChartData;

  factory MonthlyChartData.fromJson(Map json) =>
      _$MonthlyChartDataFromJson(json);
}

@freezed
class WarungStats with _$WarungStats {
  const factory WarungStats({
    required int totalAktif,
    required int totalBlocked,
  }) = _WarungStats;

  factory WarungStats.fromJson(Map json) =>
      _$WarungStatsFromJson(json);
}

@freezed
class StockStats with _$StockStats {
  const factory StockStats({
    required int lowStockCount,
    required double totalValue,
  }) = _StockStats;

  factory StockStats.fromJson(Map json) =>
      _$StockStatsFromJson(json);
}

@freezed
class TopProduct with _$TopProduct {
  const factory TopProduct({
    required String productId,
    required String productName,
    required int totalSold,
    required double revenue,
  }) = _TopProduct;

  factory TopProduct.fromJson(Map json) =>
      _$TopProductFromJson(json);
}
```

ADDITIONAL SCREENS NEEDED:
- warung_form_screen.dart (Add/Edit Warung)
- product_management_screen.dart
- product_form_screen.dart
- create_do_screen.dart (Delivery Order creation)
- verify_payments_screen.dart
- reports_screen.dart

PROVIDERS NEEDED:
- dashboard_provider.dart
- warung_provider.dart
- product_provider.dart
- delivery_order_provider.dart

Berikan implementasi lengkap untuk semua file!

ðŸ”¹ PROMPT 2.5: Kurir Delivery App (Flutter)
markdownBuatkan Flutter Kurir Delivery App dengan fitur:

REQUIREMENTS:
1. List delivery orders yang assigned
2. Detail DO dengan produk & destination
3. Map/Navigation to warung location
4. Delivery confirmation dengan foto & signature
5. Collection/setoran recording
6. Delivery history

GENERATE FILES:

1. `lib/presentation/screens/kurir/delivery_list_screen.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import '../../providers/delivery_provider.dart';
import '../../widgets/delivery_card.dart';
import 'delivery_detail_screen.dart';

class DeliveryListScreen extends ConsumerStatefulWidget {
  const DeliveryListScreen({super.key});

  @override
  ConsumerState createState() => _DeliveryListScreenState();
}

class _DeliveryListScreenState extends ConsumerState
    with SingleTickerProviderStateMixin {
  late TabController _tabController;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    
    Future.microtask(() {
      ref.read(deliveryProvider.notifier).loadDeliveries();
    });
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final deliveries = ref.watch(deliveryProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('Delivery Orders'),
        bottom: TabBar(
          controller: _tabController,
          tabs: const [
            Tab(text: 'Pending'),
            Tab(text: 'On Delivery'),
            Tab(text: 'Completed'),
          ],
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () {
              ref.read(deliveryProvider.notifier).loadDeliveries();
            },
          ),
        ],
      ),
      body: deliveries.when(
        data: (doList) {
          final pendingList = doList.where((d) => d.status == 'ASSIGNED').toList();
          final onDeliveryList = doList.where((d) => d.status == 'ON_DELIVERY').toList();
          final completedList = doList.where((d) => d.status == 'DELIVERED' || d.status == 'CONFIRMED').toList();

          return TabBarView(
            controller: _tabController,
            children: [
              _buildDeliveryList(context, pendingList, 'pending'),
              _buildDeliveryList(context, onDeliveryList, 'on_delivery'),
              _buildDeliveryList(context, completedList, 'completed'),
            ],
          );
        },
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.error_outline, size: 60.sp, color: Colors.red),
              SizedBox(height: 16.h),
              Text('Error: $error'),
              SizedBox(height: 16.h),
              ElevatedButton(
                onPressed: () {
                  ref.read(deliveryProvider.notifier).loadDeliveries();
                },
                child: const Text('Retry'),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildDeliveryList(
    BuildContext context,
    List deliveries,
    String status,
  ) {
    if (deliveries.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.local_shipping_outlined,
              size: 80.sp,
              color: Colors.grey[300],
            ),
            SizedBox(height: 16.h),
            Text(
              'Tidak ada delivery',
              style: TextStyle(
                fontSize: 16.sp,
                color: Colors.grey[600],
              ),
            ),
          ],
        ),
      );
    }

    return RefreshIndicator(
      onRefresh: () async {
        await ref.read(deliveryProvider.notifier).loadDeliveries();
      },
      child: ListView.separated(
        padding: EdgeInsets.all(16.w),
        itemCount: deliveries.length,
        separatorBuilder: (context, index) => SizedBox(height: 12.h),
        itemBuilder: (context, index) {
          final delivery = deliveries[index];
          return DeliveryCard(
            delivery: delivery,
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => DeliveryDetailScreen(
                    delivery: delivery,
                  ),
                ),
              );
            },
          );
        },
      ),
    );
  }
}
```

2. `lib/presentation/screens/kurir/delivery_detail_screen.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:image_picker/image_picker.dart';
import 'package:signature/signature.dart';
import 'dart:io';
import '../../providers/delivery_provider.dart';
import '../../widgets/common/custom_button.dart';
import 'package:url_launcher/url_launcher.dart';

class DeliveryDetailScreen extends ConsumerStatefulWidget {
  final dynamic delivery; // Replace with actual DeliveryOrder model

  const DeliveryDetailScreen({
    super.key,
    required this.delivery,
  });

  @override
  ConsumerState createState() => _DeliveryDetailScreenState();
}

class _DeliveryDetailScreenState extends ConsumerState {
  File? _photoProof;
  final SignatureController _signatureController = SignatureController(
    penStrokeWidth: 3,
    penColor: Colors.black,
  );

  @override
  void dispose() {
    _signatureController.dispose();
    super.dispose();
  }

  Future _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(
      source: ImageSource.camera,
      maxWidth: 1920,
      maxHeight: 1080,
      imageQuality: 85,
    );

    if (pickedFile != null) {
      setState(() {
        _photoProof = File(pickedFile.path);
      });
    }
  }

  Future _openMaps() async {
    final lat = widget.delivery.warung.latitude;
    final lng = widget.delivery.warung.longitude;
    
    if (lat != null && lng != null) {
      final url = 'https://www.google.com/maps/search/?api=1&query=$lat,$lng';
      if (await canLaunchUrl(Uri.parse(url))) {
        await launchUrl(Uri.parse(url));
      }
    }
  }

  Future _startDelivery() async {
    try {
      await ref.read(deliveryProvider.notifier).startDelivery(
        widget.delivery.id,
      );
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Delivery started'),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future _confirmDelivery() async {
    if (_photoProof == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Mohon ambil foto bukti terima'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Show loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(
        child: CircularProgressIndicator(),
      ),
    );

    try {
      // Get signature image
      final signatureImage = await _signatureController.toPngBytes();
      
      await ref.read(deliveryProvider.notifier).confirmDelivery(
        widget.delivery.id,
        _photoProof!,
        signatureImage,
      );

      if (mounted) {
        Navigator.pop(context); // Close loading
        Navigator.pop(context); // Go back to list
        
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Delivery confirmed successfully'),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        Navigator.pop(context); // Close loading
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final delivery = widget.delivery;

    return Scaffold(
      appBar: AppBar(
        title: Text('DO #${delivery.doNumber}'),
      ),
      body: SingleChildScrollView(
        padding: EdgeInsets.all(16.w),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            // Status badge
            Container(
              padding: EdgeInsets.all(12.w),
              decoration: BoxDecoration(
                color: _getStatusColor(delivery.status).withOpacity(0.1),
                borderRadius: BorderRadius.circular(8.r),
                border: Border.all(
                  color: _getStatusColor(delivery.status),
                ),
              ),
              child: Row(
                children: [
                  Icon(
                    _getStatusIcon(delivery.status),
                    color: _getStatusColor(delivery.status),
                  ),
                  SizedBox(width: 8.w),
                  Text(
                    _getStatusText(delivery.status),
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: _getStatusColor(delivery.status),
                    ),
                  ),
                ],
              ),
            ),

            SizedBox(height: 16.h),

            // Warung info
            Card(
              child: Padding(
                padding: EdgeInsets.all(16.w),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(
                          Icons.store,
                          color: Theme.of(context).primaryColor,
                        ),
                        SizedBox(width: 8.w),
                        Text(
                          'Tujuan Pengiriman',
                          style: TextStyle(
                            fontSize: 16.sp,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 12.h),
                    Text(
                      delivery.warung.name,
                      style: TextStyle(
                        fontSize: 18.sp,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(height: 4.h),
                    Text(
                      delivery.warung.ownerName,
                      style: TextStyle(
                        fontSize: 14.sp,
                        color: Colors.grey[600],
                      ),
                    ),
                    SizedBox(height: 8.h),
                    Row(
                      children: [
                        Icon(Icons.phone, size: 16.sp, color: Colors.grey[600]),
                        SizedBox(width: 4.w),
                        Text(
                          delivery.warung.phone,
                          style: TextStyle(color: Colors.grey[600]),
                        ),
                      ],
                    ),
                    SizedBox(height: 4.h),
                    Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Icon(Icons.location_on, size: 16.sp, color: Colors.grey[600]),
                        SizedBox(width: 4.w),
                        Expanded(
                          child: Text(
                            delivery.warung.address,
                            style: TextStyle(color: Colors.grey[600]),
                          ),
                        ),
                      ],
                    ),
                    if (delivery.warung.latitude != null && 
                        delivery.warung.longitude != null) ...[
                      SizedBox(height: 12.h),
                      ElevatedButton.icon(
                        onPressed: _openMaps,
                        icon: const Icon(Icons.map),
                        label: const Text('Buka di Maps'),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.blue,
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            ),

            SizedBox(height: 16.h),

            // Items
            Card(
              child: Padding(
                padding: EdgeInsets.all(16.w),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(
                          Icons.inventory_2,
                          color: Theme.of(context).primaryColor,
                        ),
                        SizedBox(width: 8.w),
                        Text(
                          'Item Pengiriman',
                          style: TextStyle(
                            fontSize: 16.sp,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 12.h),
                    ...delivery.items.map((item) {
                      return Padding(
                        padding: EdgeInsets.only(bottom: 8.h),
                        child: Row(
                          children: [
                            Expanded(
                              child: Text(item.product.name),
                            ),
                            Text(
                              '${item.quantity} ${item.product.unit}',
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: Theme.of(context).primaryColor,
                              ),
                            ),
                          ],
                        ),
                      );
                    }).toList(),
                    Divider(height: 24.h),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          'Total Nilai',
                          style: TextStyle(
                            fontSize: 16.sp,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          'Rp ${delivery.totalAmount.toStringAsFixed(0)}',
                          style: TextStyle(
                            fontSize: 18.sp,
                            fontWeight: FontWeight.bold,
                            color: Theme.of(context).primaryColor,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),

            SizedBox(height: 16.h),

            // Photo proof section (if on delivery)
            if (delivery.status == 'ON_DELIVERY') ...[
              Card(
                child: Padding(
                  padding: EdgeInsets.all(16.w),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Bukti Penerimaan',
                        style: TextStyle(
                          fontSize: 16.sp,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      SizedBox(height: 12.h),
                      if (_photoProof != null)
                        Stack(
                          children: [
                            ClipRRect(
                              borderRadius: BorderRadius.circular(8.r),
                              child: Image.file(
                                _photoProof!,
                                height: 200.h,
                                width: double.infinity,
                                fit: BoxFit.cover,
                              ),
                            ),
                            Positioned(
                              top: 8,
                              right: 8,
                              child: IconButton(
                                onPressed: () {
                                  setState(() {
                                    _photoProof = null;
                                  });
                                },
                                icon: const Icon(Icons.close),
                                style: IconButton.styleFrom(
                                  backgroundColor: Colors.white,
                                  foregroundColor: Colors.black,
                                ),
                              ),
                            ),
                          ],
                        )
                      else
                        OutlinedButton.icon(
                          onPressed: _pickImage,
                          icon: const Icon(Icons.camera_alt),
                          label: const Text('Ambil Foto'),
                          style: OutlinedButton.styleFrom(
                            minimumSize: Size(double.infinity, 50.h),
                          ),
                        ),
                    ],
                  ),
                ),
              ),

              SizedBox(height: 16.h),

              // Signature section
              Card(
                child: Padding(
                  padding: EdgeInsets.all(16.w),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            'Tanda Tangan Penerima',
                            style: TextStyle(
                              fontSize: 16.sp,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          TextButton(
                            onPressed: () {
                              _signatureController.clear();
                            },
                            child: const Text('Clear'),
                          ),
                        ],
                      ),
                      SizedBox(height: 12.h),
                      Container(
                        height: 150.h,
                        decoration: BoxDecoration(
                          border: Border.all(color: Colors.grey[300]!),
                          borderRadius: BorderRadius.circular(8.r),
                        ),
                        child: Signature(
                          controller: _signatureController,
                          backgroundColor: Colors.white,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],

            SizedBox(height: 24.h),

            // Action buttons
            if (delivery.status == 'ASSIGNED')
              CustomButton(
                text: 'Mulai Pengiriman',
                onPressed: _startDelivery,
                icon: Icons.play_arrow,
              )
            else if (delivery.status == 'ON_DELIVERY')
              CustomButton(
                text: 'Konfirmasi Penerimaan',
                onPressed: _confirmDelivery,
                icon: Icons.check_circle,
              )
            else if (delivery.status == 'DELIVERED' || 
                     delivery.status == 'CONFIRMED')
              Container(
                padding: EdgeInsets.all(16.w),
                decoration: BoxDecoration(
                  color: Colors.green[50],
                  borderRadius: BorderRadius.circular(8.r),
                ),
                child: Row(
                  children: [
                    Icon(Icons.check_circle, color: Colors.green[700]),
                    SizedBox(width: 8.w),
                    Expanded(
                      child: Text(
                        'Pengiriman telah selesai',
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          color: Colors.green[700],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
          ],
        ),
      ),
    );
  }

  Color _getStatusColor(String status) {
    switch (status) {
      case 'ASSIGNED':
        return Colors.orange;
      case 'ON_DELIVERY':
        return Colors.blue;
      case 'DELIVERED':
      case 'CONFIRMED':
        return Colors.green;
      default:
        return Colors.grey;
    }
  }

  IconData _getStatusIcon(String status) {
    switch (status) {
      case 'ASSIGNED':
        return Icons.assignment;
      case 'ON_DELIVERY':
        return Icons.local_shipping;
      case 'DELIVERED':
      case 'CONFIRMED':
        return Icons.check_circle;
      default:
        return Icons.info;
    }
  }

  String _getStatusText(String status) {
    switch (status) {
      case 'ASSIGNED':
        return 'Siap Dikirim';
      case 'ON_DELIVERY':
        return 'Dalam Pengiriman';
      case 'DELIVERED':
        return 'Terkirim';
      case 'CONFIRMED':
        return 'Dikonfirmasi';
      default:
        return status;
    }
  }
}
```

3. `lib/presentation/widgets/delivery_card.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:intl/intl.dart';

class DeliveryCard extends StatelessWidget {
  final dynamic delivery;
  final VoidCallback onTap;

  const DeliveryCard({
    super.key,
    required this.delivery,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12.r),
        child: Padding(
          padding: EdgeInsets.all(16.w),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // DO Number and status
              Row(
                children: [
                  Expanded(
                    child: Text(
                      'DO #${delivery.doNumber}',
                      style: TextStyle(
                        fontSize: 16.sp,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  _buildStatusChip(delivery.status),
                ],
              ),

              SizedBox(height: 12.h),

              // Warung info
              Row(
                children: [
                  Icon(
                    Icons.store,
                    size: 20.sp,
                    color: Colors.grey[600],
                  ),
                  SizedBox(width: 8.w),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          delivery.warung.name,
                          style: TextStyle(
                            fontSize: 14.sp,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                        Text(
                          delivery.warung.address,
                          style: TextStyle(
                            fontSize: 12.sp,
                            color: Colors.grey[600],
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                      ],
                    ),
                  ),
                ],
              ),

              SizedBox(height: 12.h),

              // Items count and total
              Row(
                children: [
                  Icon(
                    Icons.inventory_2_outlined,
                    size: 16.sp,
                    color: Colors.grey[600],
                  ),
                  SizedBox(width: 4.w),
                  Text(
                    '${delivery.items.length} item',
                    style: TextStyle(
                      fontSize: 12.sp,
                      color: Colors.grey[600],
                    ),
                  ),
                  const Spacer(),
                  Text(
                    'Rp ${delivery.totalAmount.toStringAsFixed(0)}',
                    style: TextStyle(
                      fontSize: 16.sp,
                      fontWeight: FontWeight.bold,
                      color: Theme.of(context).primaryColor,
                    ),
                  ),
                ],
              ),

              SizedBox(height: 8.h),

              // Date
              Row(
                children: [
                  Icon(
                    Icons.calendar_today,
                    size: 16.sp,
                    color: Colors.grey[600],
                  ),
                  SizedBox(width: 4.w),
                  Text(
                    DateFormat('dd MMM yyyy, HH:mm').format(delivery.createdAt),
                    style: TextStyle(
                      fontSize: 12.sp,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildStatusChip(String status) {
    Color color;
    String text;

    switch (status) {
      case 'ASSIGNED':
        color = Colors.orange;
        text = 'Assigned';
        break;
      case 'ON_DELIVERY':
        color = Colors.blue;
        text = 'On Delivery';
        break;
      case 'DELIVERED':
        color = Colors.green;
        text = 'Delivered';
        break;
      case 'CONFIRMED':
        color = Colors.green[700]!;
        text = 'Confirmed';
        break;
      default:
        color = Colors.grey;
        text = status;
    }

    return Container(
      padding: EdgeInsets.symmetric(
        horizontal: 12.w,
        vertical: 4.h,
      ),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(12.r),
        border: Border.all(color: color),
      ),
      child: Text(
        text,
        style: TextStyle(
          fontSize: 12.sp,
          fontWeight: FontWeight.bold,
          color: color,
        ),
      ),
    );
  }
}
```

ADDITIONAL DEPENDENCIES needed in pubspec.yaml:
```yaml
dependencies:
  signature: ^5.4.0
  url_launcher: ^6.2.2
  permission_handler: ^11.1.0
```

Berikan implementasi lengkap untuk provider dan repository yang dibutuhkan!

ðŸ”¹ PROMPT 2.6: Gudang Stock Management (Flutter)
markdownBuatkan Flutter Gudang Stock Management App dengan fitur:

REQUIREMENTS:
1. Stock overview (all products dengan qty)
2. Receive goods dari supplier (PO receiving)
3. Prepare delivery (DO packing)
4. Stock opname (physical count & adjustment)
5. Stock movement history
6. Low stock alerts

GENERATE FILES:

1. `lib/presentation/screens/gudang/stock_overview_screen.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import '../../providers/stock_provider.dart';
import '../../widgets/stock_card.dart';
import 'receive_goods_screen.dart';
import 'stock_opname_screen.dart';

class StockOverviewScreen extends ConsumerStatefulWidget {
  const StockOverviewScreen({super.key});

  @override
  ConsumerState createState() => _StockOverviewScreenState();
}

class _StockOverviewScreenState extends ConsumerState {
  final _searchController = TextEditingController();
  bool _showLowStockOnly = false;

  @override
  void initState() {
    super.initState();
    Future.microtask(() {
      ref.read(stockProvider.notifier).loadStocks();
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final stocks = ref.watch(stockProvider);
    final lowStockCount = ref.watch(lowStockCountProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('Stock Overview'),
        actions: [
          if (lowStockCount > 0)
            IconButton(
              icon: Badge(
                label: Text('$lowStockCount'),
                child: const Icon(Icons.warning_amber),
              ),
              onPressed: () {
                setState(() {
                  _showLowStockOnly = !_showLowStockOnly;
                });
              },
            ),
          IconButton(
            icon: const Icon(Icons.refresh),
            onPressed: () {
              ref.read(stockProvider.notifier).loadStocks();
            },
          ),
        ],
      ),
      body: Column(
        children: [
          // Search bar
          Padding(
            padding: EdgeInsets.all(16.w),
            child: TextField(
              controller: _searchController,
              decoration: InputDecoration(
                hintText: 'Cari produk...',
                prefixIcon: const Icon(Icons.search),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8.r),
                ),
                filled: true,
              ),
              onChanged: (value) {
                // TODO: Implement search
              },
            ),
          ),

          // Filter chip
          if (_showLowStockOnly)
            Padding(
              padding: EdgeInsets.symmetric(horizontal: 16.w),
              child: Align(
                alignment: Alignment.centerLeft,
                child: Chip(
                  label: const Text('Low Stock'),
                  onDeleted: () {
                    setState(() {
                      _showLowStockOnly = false;
                    });
                  },
                  backgroundColor: Colors.orange[100],
                ),
              ),
            ),

          // Stock list
          Expanded(
            child: stocks.when(
              data: (stockList) {
                final filteredList = _showLowStockOnly
                    ? stockList.where((s) => s.quantity < s.minStock).toList()
                    : stockList;

                if (filteredList.isEmpty) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.inventory_2_outlined,
                          size: 80.sp,
                          color: Colors.grey[300],
                        ),
                        SizedBox(height: 16.h),
                        Text(
                          'Tidak ada stock',
                          style: TextStyle(
                            fontSize: 16.sp,
                            color: Colors.grey[600],
                          ),
                        ),
                      ],
                    ),
                  );
                }

                return RefreshIndicator(
                  onRefresh: () async {
                    await ref.read(stockProvider.notifier).loadStocks();
                  },
                  child: ListView.separated(
                    padding: EdgeInsets.all(16.w),
                    itemCount: filteredList.length,
                    separatorBuilder: (context, index) => SizedBox(height: 12.h),
                    itemBuilder: (context, index) {
                      return StockCard(
                        stock: filteredList[index],
                        onTap: () {
                          _showStockDetail(filteredList[index]);
                        },
                      );
                    },
                  ),
                );
              },
              loading: () => const Center(child: CircularProgressIndicator()),
              error: (error, stack) => Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.error_outline, size: 60.sp, color: Colors.red),
                    SizedBox(height: 16.h),
                    Text('Error: $error'),
                    SizedBox(height: 16.h),
                    ElevatedButton(
                      onPressed: () {
                        ref.read(stockProvider.notifier).loadStocks();
                      },
                      child: const Text('Retry'),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
      floatingActionButton: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          FloatingActionButton(
            heroTag: 'opname',
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => const StockOpnameScreen(),
                ),
              );
            },
            child: const Icon(Icons.fact_check),
          ),
          SizedBox(height: 12.h),
          FloatingActionButton(
            heroTag: 'receive',
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => const ReceiveGoodsScreen(),
                ),
              );
            },
            child: const Icon(Icons.add),
          ),
        ],
      ),
    );
  }

  void _showStockDetail(dynamic stock) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20.r)),
      ),
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.6,
        minChildSize: 0.4,
        maxChildSize: 0.9,
        builder: (context, scrollController) {
          return Container(
            padding: EdgeInsets.all(16.w),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Center(
                  child: Container(
                    width: 40.w,
                    height: 4.h,
                    decoration: BoxDecoration(
                      color: Colors.grey[300],
                      borderRadius: BorderRadius.circular(2.r),
                    ),
                  ),
                ),
                SizedBox(height: 16.h),
                Text(
                  stock.product.name,
                  style: TextStyle(
                    fontSize: 20.sp,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 8.h),
                Text(
                  'Barcode: ${stock.product.barcode}',
                  style: TextStyle(
                    fontSize: 14.sp,
                    color: Colors.grey[600],
                  ),
                ),
                SizedBox(height: 24.h),
                _buildDetailRow('Stok Saat Ini', '${stock.quantity} ${stock.product.unit}'),
                _buildDetailRow('Min. Stock', '${stock.minStock} ${stock.product.unit}'),
                _buildDetailRow('Harga Beli', 'Rp ${stock.product.buyPrice.toStringAsFixed(0)}'),
                _buildDetailRow('Harga Jual', 'Rp ${stock.product.sellPrice.toStringAsFixed(0)}'),
                _buildDetailRow('Margin', '${stock.product.margin.toStringAsFixed(1)}%'),
                SizedBox(height: 24.h),
                Text(
                  'Riwayat Pergerakan',
                  style: TextStyle(
                    fontSize: 16.sp,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 12.h),
                Expanded(
                  child: ListView(
                    controller: scrollController,
                    children: [
                      // TODO: Load stock movement history
                      Center(
                        child: Text(
                          'Coming soon...',
                          style: TextStyle(color: Colors.grey[600]),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }

  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: EdgeInsets.only(bottom: 12.h),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: TextStyle(
              fontSize: 14.sp,
              color: Colors.grey[600],
            ),
          ),
          Text(
            value,
            style: TextStyle(
              fontSize: 14.sp,
              fontWeight: FontWeight.w600,
            ),
          ),
        ],
      ),
    );
  }
}
```

2. `lib/presentation/screens/gudang/receive_goods_screen.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:mobile_scanner/mobile_scanner.dart';
import '../../providers/purchase_order_provider.dart';
import '../../widgets/common/custom_button.dart';

class ReceiveGoodsScreen extends ConsumerStatefulWidget {
  const ReceiveGoodsScreen({super.key});

  @override
  ConsumerState createState() => _ReceiveGoodsScreenState();
}

class _ReceiveGoodsScreenState extends ConsumerState {
  String? _selectedPOId;
  final Map _receivedQuantities = {};

  @override
  void initState() {
    super.initState();
    Future.microtask(() {
      ref.read(purchaseOrderProvider.notifier).loadApprovedPOs();
    });
  }

  void _showBarcodeScanner() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      builder: (context) => SizedBox(
        height: MediaQuery.of(context).size.height * 0.7,
        child: Column(
          children: [
            Padding(
              padding: EdgeInsets.all(16.w),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    'Scan Barcode Produk',
                    style: TextStyle(
                      fontSize: 18.sp,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            Expanded(
              child: MobileScanner(
                onDetect: (capture) {
                  final barcodes = capture.barcodes;
                  if (barcodes.isNotEmpty) {
                    final barcode = barcodes.first.rawValue;
                    if (barcode != null) {
                      Navigator.pop(context);
                      _handleBarcodeScanned(barcode);
                    }
                  }
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _handleBarcodeScanned(String barcode) {
    // TODO: Find product in PO by barcode and increment received quantity
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('Scanned: $barcode'),
      ),
    );
  }

  Future _receiveGoods() async {
    if (_selectedPOId == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Pilih PO terlebih dahulu'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    // Show loading
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => const Center(
        child: CircularProgressIndicator(),
      ),
    );

    try {
      await ref.read(purchaseOrderProvider.notifier).receiveGoods(
        _selectedPOId!,
        _receivedQuantities,
      );

      if (mounted) {
        Navigator.pop(context); // Close loading
        Navigator.pop(context); // Go back
        
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Barang berhasil diterima'),
            backgroundColor: Colors.green,
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        Navigator.pop(context); // Close loading
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Error: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final purchaseOrders = ref.watch(purchaseOrderProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('Terima Barang'),
        actions: [
          IconButton(
            icon: const Icon(Icons.qr_code_scanner),
            onPressed: _showBarcodeScanner,
          ),
        ],
      ),
      body: Column(
        children: [
          // PO Selection
          Padding(
            padding: EdgeInsets.all(16.w),
            child: purchaseOrders.when(
              data: (poList) {
                if (poList.isEmpty) {
                  return Card(
                    child: Padding(
                      padding: EdgeInsets.all(16.w),
                      child: Text(
                        'Tidak ada PO yang disetujui',
                        style: TextStyle(
                          fontSize: 14.sp,
                          color: Colors.grey[600],
                        ),
                      ),
                    ),
                  );
                }

                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Pilih Purchase Order',
                      style: TextStyle(
                        fontSize: 16.sp,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(height: 12.h),
                    DropdownButtonFormField(
                      value: _selectedPOId,
                      decoration: InputDecoration(
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8.r),
                        ),
                        filled: true,
                      ),
                      hint: const Text('Pilih PO...'),
                      items: poList.map((po) {
                        return DropdownMenuItem(
                          value: po.id,
                          child: Text('PO #${po.poNumber} - ${po.supplier.name}'),
                        );
                      }).toList(),
                      onChanged: (value) {
                        setState(() {
                          _selectedPOId = value;
                          _receivedQuantities.clear();
                        });
                      },
                    ),
                  ],
                );
              },
              loading: () => const Center(child: CircularProgressIndicator()),
              error: (error, stack) => Text('Error: $error'),
            ),
          ),

          // PO Items (if PO selected)
          if (_selectedPOId != null)
            Expanded(
              child: purchaseOrders.when(
                data: (poList) {
                  final selectedPO = poList.firstWhere((po) => po.id == _selectedPOId);
                  
                  return ListView.separated(
                    padding: EdgeInsets.all(16.w),
                    itemCount: selectedPO.items.length,
                    separatorBuilder: (context, index) => SizedBox(height: 12.h),
                    itemBuilder: (context, index) {
                      final item = selectedPO.items[index];
                      final receivedQty = _receivedQuantities[item.productId] ?? 0;
                      
                      return Card(
                        child: Padding(
                          padding: EdgeInsets.all(16.w),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                item.product.name,
                                style: TextStyle(
                                  fontSize: 16.sp,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              SizedBox(height: 4.h),
                              Text(
                                'Barcode: ${item.product.barcode}',
                                style: TextStyle(
                                  fontSize: 12.sp,
                                  color: Colors.grey[600],
                                ),
                              ),
                              SizedBox(height: 12.h),
                              Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  Text(
                                    'Qty PO: ${item.quantity} ${item.product.unit}',
                                    style: TextStyle(fontSize: 14.sp),
                                  ),
                                  Row(
                                    children: [
                                      IconButton(
                                        icon: const Icon(Icons.remove),
                                        onPressed: receivedQty > 0
                                            ? () {
                                                setState(() {
                                                  _receivedQuantities[item.productId] =
                                                      receivedQty - 1;
                                                });
                                              }
                                            : null,
                                        iconSize: 20.sp,
                                      ),
                                      Container(
                                        padding: EdgeInsets.symmetric(
                                          horizontal: 16.w,
                                          vertical: 8.h,
                                        ),
                                        decoration: BoxDecoration(
                                          border: Border.all(color: Colors.grey[300]!),
                                          borderRadius: BorderRadius.circular(4.r),
                                        ),
                                        child: Text(
                                          '$receivedQty',
                                          style: TextStyle(
                                            fontSize: 16.sp,
                                            fontWeight: FontWeight.bold,
                                          ),
                                        ),
                                      ),
                                      IconButton(
                                        icon: const Icon(Icons.add),
                                        onPressed: receivedQty < item.quantity
                                            ? () {
                                                setState(() {
                                                  _receivedQuantities[item.productId] =
                                                      receivedQty + 1;
                                                });
                                              }
                                            : null,
                                        iconSize: 20.sp,
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                              if (receivedQty > 0 && receivedQty != item.quantity)
                                Padding(
                                  padding: EdgeInsets.only(top: 8.h),
                                  child: Text(
                                    'Selisih: ${item.quantity - receivedQty} ${item.product.unit}',
                                    style: TextStyle(
                                      fontSize: 12.sp,
                                      color: Colors.orange[700],
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                ),
                            ],
                          ),
                        ),
                      );
                    },
                  );
                },
                loading: () => const Center(child: CircularProgressIndicator()),
                error: (error, stack) => Center(child: Text('Error: $error')),
              ),
            ),
        ],
      ),
      bottomNavigationBar: _selectedPOId != null
          ? SafeArea(
              child: Padding(
                padding: EdgeInsets.all(16.w),
                child: CustomButton(
                  text: 'Terima Barang',
                  onPressed: _receiveGoods,
                  icon: Icons.check_circle,
                ),
              ),
            )
          : null,
    );
  }
}
```

3. `lib/presentation/widgets/stock_card.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';

class StockCard extends StatelessWidget {
  final dynamic stock;
  final VoidCallback onTap;

  const StockCard({
    super.key,
    required this.stock,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final isLowStock = stock.quantity < stock.minStock;
    
    return Card(
      elevation: 2,
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12.r),
        child: Padding(
          padding: EdgeInsets.all(16.w),
          child: Row(
            children: [
              // Product icon/image
              Container(
                width: 60.w,
                height: 60.w,
                decoration: BoxDecoration(
                  color: Colors.grey[200],
                  borderRadius: BorderRadius.circular(8.r),
                ),
                child: Icon(
                  Icons.inventory_2_outlined,
                  size: 30.sp,
                  color: Colors.grey[400],
                ),
              ),
              
              SizedBox(width: 12.w),
              
              // Product info
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      stock.product.name,
                      style: TextStyle(
                        fontSize: 16.sp,
                        fontWeight: FontWeight.bold,
                      ),
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                    SizedBox(height: 4.h),
                    Text(
                      stock.product.barcode,
                      style: TextStyle(
                        fontSize: 12.sp,
                        color: Colors.grey[600],
                      ),
                    ),
                    SizedBox(height: 8.h),
                    Row(
                      children: [
                        Container(
                          padding: EdgeInsets.symmetric(
                            horizontal: 8.w,
                            vertical: 4.h,
                          ),
                          decoration: BoxDecoration(
                            color: isLowStock
                                ? Colors.orange[50]
                                : Colors.green[50],
                            borderRadius: BorderRadius.circular(4.r),
                            border: Border.all(
                              color: isLowStock
                                  ? Colors.orange[700]!
                                  : Colors.green[700]!,
                            ),
                          ),
                          child: Text(
                            '${stock.quantity} ${stock.product.unit}',
                            style: TextStyle(
                              fontSize: 12.sp,
                              fontWeight: FontWeight.bold,
                              color: isLowStock
                                  ? Colors.orange[700]
                                  : Colors.green[700],
                            ),
                          ),
                        ),
                        if (isLowStock) ...[
                          SizedBox(width: 8.w),
                          Icon(
                            Icons.warning_amber,
                            size: 16.sp,
                            color: Colors.orange[700],
                          ),
                          SizedBox(width: 4.w),
                          Text(
                            'Low Stock',
                            style: TextStyle(
                              fontSize: 12.sp,
                              color: Colors.orange[700],
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ],
                    ),
                  ],
                ),
              ),
              
              // Arrow icon
              Icon(
                Icons.arrow_forward_ios,
                size: 16.sp,
                color: Colors.grey[400],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

Berikan implementasi lengkap untuk:
- stock_opname_screen.dart (physical count & adjustment)
- prepare_delivery_screen.dart (packing DO)
- Providers dan repositories yang dibutuhkan

PROMPT 2.7: Offline Sync & Data Persistence (Flutter)
markdownBuatkan Flutter Offline-First System dengan queue synchronization untuk aplikasi BUMAS.

REQUIREMENTS:
1. Local database dengan Hive untuk caching
2. Sync queue untuk transaksi offline
3. Auto-sync saat online
4. Conflict resolution
5. Network connectivity detector
6. Sync status indicator

GENERATE FILES:

1. `lib/data/datasources/local/hive_models.dart`:
```dart
import 'package:hive/hive.dart';

part 'hive_models.g.dart';

@HiveType(typeId: 0)
class SyncQueueItem {
  @HiveField(0)
  final String id;
  
  @HiveField(1)
  final String endpoint;
  
  @HiveField(2)
  final String method; // POST, PUT, DELETE
  
  @HiveField(3)
  final Map data;
  
  @HiveField(4)
  final DateTime createdAt;
  
  @HiveField(5)
  int retryCount;
  
  @HiveField(6)
  String? error;

  SyncQueueItem({
    required this.id,
    required this.endpoint,
    required this.method,
    required this.data,
    required this.createdAt,
    this.retryCount = 0,
    this.error,
  });
}

@HiveType(typeId: 1)
class CachedProduct {
  @HiveField(0)
  final String id;
  
  @HiveField(1)
  final String name;
  
  @HiveField(2)
  final String barcode;
  
  @HiveField(3)
  final double sellPrice;
  
  @HiveField(4)
  final String unit;
  
  @HiveField(5)
  final DateTime cachedAt;

  CachedProduct({
    required this.id,
    required this.name,
    required this.barcode,
    required this.sellPrice,
    required this.unit,
    required this.cachedAt,
  });
}

@HiveType(typeId: 2)
class OfflineSale {
  @HiveField(0)
  final String localId;
  
  @HiveField(1)
  final String warungId;
  
  @HiveField(2)
  final List items;
  
  @HiveField(3)
  final double totalAmount;
  
  @HiveField(4)
  final String paymentMethod;
  
  @HiveField(5)
  final DateTime createdAt;
  
  @HiveField(6)
  bool synced;
  
  @HiveField(7)
  String? serverId;

  OfflineSale({
    required this.localId,
    required this.warungId,
    required this.items,
    required this.totalAmount,
    required this.paymentMethod,
    required this.createdAt,
    this.synced = false,
    this.serverId,
  });
}

@HiveType(typeId: 3)
class OfflineSaleItem {
  @HiveField(0)
  final String productId;
  
  @HiveField(1)
  final int quantity;
  
  @HiveField(2)
  final double price;

  OfflineSaleItem({
    required this.productId,
    required this.quantity,
    required this.price,
  });
}
```

2. `lib/data/sync/sync_service.dart`:
```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:connectivity_plus/connectivity_plus.dart';
import 'package:uuid/uuid.dart';
import '../datasources/local/hive_service.dart';
import '../datasources/local/hive_models.dart';
import '../datasources/remote/sales_remote_datasource.dart';

final syncServiceProvider = Provider((ref) {
  return SyncService();
});

class SyncService {
  final _connectivity = Connectivity();
  bool _isSyncing = false;

  // Listen to connectivity changes
  Stream get connectivityStream =>
      _connectivity.onConnectivityChanged.map((list) => list.first);

  // Add item to sync queue
  Future addToQueue({
    required String endpoint,
    required String method,
    required Map data,
  }) async {
    final queueItem = SyncQueueItem(
      id: const Uuid().v4(),
      endpoint: endpoint,
      method: method,
      data: data,
      createdAt: DateTime.now(),
    );

    await HiveService.syncQueueBox.add(queueItem);
  }

  // Save offline sale
  Future saveOfflineSale(OfflineSale sale) async {
    await HiveService.offlineSalesBox.put(sale.localId, sale);
    return sale.localId;
  }

  // Get pending sync count
  int getPendingSyncCount() {
    return HiveService.syncQueueBox.length + 
           HiveService.offlineSalesBox.values.where((s) => !s.synced).length;
  }

  // Sync all pending data
  Future syncAll() async {
    if (_isSyncing) {
      return SyncResult(
        success: false,
        message: 'Sync already in progress',
      );
    }

    // Check connectivity
    final connectivityResult = await _connectivity.checkConnectivity();
    if (connectivityResult.first == ConnectivityResult.none) {
      return SyncResult(
        success: false,
        message: 'No internet connection',
      );
    }

    _isSyncing = true;

    try {
      int successCount = 0;
      int failedCount = 0;

      // 1. Sync offline sales
      final offlineSales = HiveService.offlineSalesBox.values
          .where((s) => !s.synced)
          .toList();

      for (final sale in offlineSales) {
        try {
          // Convert to API format and send
          final response = await _syncSale(sale);
          
          // Update with server ID
          sale.synced = true;
          sale.serverId = response['id'];
          await sale.save();
          
          successCount++;
        } catch (e) {
          failedCount++;
          print('Failed to sync sale ${sale.localId}: $e');
        }
      }

      // 2. Sync queue items
      final queueItems = HiveService.syncQueueBox.values.toList();
      
      for (int i = 0; i < queueItems.length; i++) {
        final item = queueItems[i];
        
        try {
          await _syncQueueItem(item);
          await HiveService.syncQueueBox.deleteAt(i);
          successCount++;
        } catch (e) {
          item.retryCount++;
          item.error = e.toString();
          await item.save();
          failedCount++;
          
          // Remove if retry count > 5
          if (item.retryCount > 5) {
            await HiveService.syncQueueBox.deleteAt(i);
          }
        }
      }

      return SyncResult(
        success: true,
        message: 'Synced $successCount items, $failedCount failed',
        syncedCount: successCount,
        failedCount: failedCount,
      );
    } finally {
      _isSyncing = false;
    }
  }

  Future<Map> _syncSale(OfflineSale sale) async {
    // TODO: Call actual API
    // final response = await salesApi.createSale(sale);
    // return response;
    
    // Mock response for now
    await Future.delayed(const Duration(seconds: 1));
    return {'id': 'server-${sale.localId}'};
  }

  Future _syncQueueItem(SyncQueueItem item) async {
    // TODO: Call actual API based on method and endpoint
    await Future.delayed(const Duration(milliseconds: 500));
  }

  // Cache products for offline use
  Future cacheProducts(List products) async {
    final now = DateTime.now();
    
    for (final product in products) {
      final cached = CachedProduct(
        id: product.id,
        name: product.name,
        barcode: product.barcode,
        sellPrice: product.sellPrice,
        unit: product.unit,
        cachedAt: now,
      );
      
      await HiveService.cachedProductsBox.put(product.id, cached);
    }
  }

  // Get cached products
  List getCachedProducts() {
    return HiveService.cachedProductsBox.values.toList();
  }

  // Clear old cache (older than 7 days)
  Future clearOldCache() async {
    final sevenDaysAgo = DateTime.now().subtract(const Duration(days: 7));
    
    final oldProducts = HiveService.cachedProductsBox.values
        .where((p) => p.cachedAt.isBefore(sevenDaysAgo))
        .toList();
    
    for (final product in oldProducts) {
      await HiveService.cachedProductsBox.delete(product.id);
    }
  }
}

class SyncResult {
  final bool success;
  final String message;
  final int syncedCount;
  final int failedCount;

  SyncResult({
    required this.success,
    required this.message,
    this.syncedCount = 0,
    this.failedCount = 0,
  });
}
```

3. `lib/presentation/providers/sync_provider.dart`:
```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:connectivity_plus/connectivity_plus.dart';
import '../../data/sync/sync_service.dart';

// Connectivity state
final connectivityProvider = StreamProvider((ref) {
  final syncService = ref.watch(syncServiceProvider);
  return syncService.connectivityStream;
});

// Is online
final isOnlineProvider = Provider((ref) {
  final connectivity = ref.watch(connectivityProvider);
  return connectivity.when(
    data: (result) => result != ConnectivityResult.none,
    loading: () => false,
    error: (_, __) => false,
  );
});

// Pending sync count
final pendingSyncCountProvider = Provider((ref) {
  final syncService = ref.watch(syncServiceProvider);
  return syncService.getPendingSyncCount();
});

// Sync state
class SyncState {
  final bool isSyncing;
  final String? message;
  final DateTime? lastSyncAt;

  SyncState({
    this.isSyncing = false,
    this.message,
    this.lastSyncAt,
  });

  SyncState copyWith({
    bool? isSyncing,
    String? message,
    DateTime? lastSyncAt,
  }) {
    return SyncState(
      isSyncing: isSyncing ?? this.isSyncing,
      message: message ?? this.message,
      lastSyncAt: lastSyncAt ?? this.lastSyncAt,
    );
  }
}

class SyncNotifier extends StateNotifier {
  final SyncService _syncService;

  SyncNotifier(this._syncService) : super(SyncState());

  Future sync() async {
    state = state.copyWith(isSyncing: true, message: null);

    final result = await _syncService.syncAll();

    state = state.copyWith(
      isSyncing: false,
      message: result.message,
      lastSyncAt: result.success ? DateTime.now() : null,
    );
  }
}

final syncProvider = StateNotifierProvider((ref) {
  final syncService = ref.watch(syncServiceProvider);
  return SyncNotifier(syncService);
});
```

4. `lib/presentation/widgets/sync_indicator.dart`:
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import '../providers/sync_provider.dart';

class SyncIndicator extends ConsumerWidget {
  const SyncIndicator({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final isOnline = ref.watch(isOnlineProvider);
    final pendingCount = ref.watch(pendingSyncCountProvider);
    final syncState = ref.watch(syncProvider);

    if (!isOnline && pendingCount == 0) {
      return const SizedBox.shrink();
    }

    return Container(
      margin: EdgeInsets.all(16.w),
      padding: EdgeInsets.all(12.w),
      decoration: BoxDecoration(
        color: isOnline ? Colors.green[50] : Colors.orange[50],
        borderRadius: BorderRadius.circular(8.r),
        border: Border.all(
          color: isOnline ? Colors.green[700]! : Colors.orange[700]!,
        ),
      ),
      child: Row(
        children: [
          Icon(
            isOnline ? Icons.cloud_done : Icons.cloud_off,
            color: isOnline ? Colors.green[700] : Colors.orange[700],
            size: 20.sp,
          ),
          SizedBox(width: 8.w),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  isOnline ? 'Online' : 'Offline',
                  style: TextStyle(
                    fontSize: 14.sp,
                    fontWeight: FontWeight.bold,
                    color: isOnline ? Colors.green[700] : Colors.orange[700],
                  ),
                ),
                if (pendingCount > 0) ...[
                  SizedBox(height: 2.h),
                  Text(
                    '$pendingCount data menunggu sinkronisasi',
                    style: TextStyle(
                      fontSize: 12.sp,
                      color: Colors.grey[700],
                    ),
                  ),
                ],
                if (syncState.lastSyncAt != null) ...[
                  SizedBox(height: 2.h),
                  Text(
                    'Terakhir sync: ${_formatTime(syncState.lastSyncAt!)}',
                    style: TextStyle(
                      fontSize: 10.sp,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ],
            ),
          ),
          if (isOnline && pendingCount > 0)
            syncState.isSyncing
                ? SizedBox(
                    width: 20.w,
                    height: 20.w,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      valueColor: AlwaysStoppedAnimation(Colors.green[700]),
                    ),
                  )
                : IconButton(
                    onPressed: () {
                      ref.read(syncProvider.notifier).sync();
                    },
                    icon: const Icon(Icons.sync),
                    iconSize: 20.sp,
                    padding: EdgeInsets.zero,
                    constraints: const BoxConstraints(),
                    color: Colors.green[700],
                  ),
        ],
      ),
    );
  }

  String _formatTime(DateTime time) {
    final now = DateTime.now();
    final diff = now.difference(time);

    if (diff.inMinutes < 1) {
      return 'Baru saja';
    } else if (diff.inMinutes < 60) {
      return '${diff.inMinutes} menit lalu';
    } else if (diff.inHours < 24) {
      return '${diff.inHours} jam lalu';
    } else {
      return '${diff.inDays} hari lalu';
    }
  }
}
```

5. `lib/core/utils/offline_helper.dart`:
```dart
import 'package:connectivity_plus/connectivity_plus.dart';

class OfflineHelper {
  static Future isOnline() async {
    final connectivityResult = await Connectivity().checkConnectivity();
    return connectivityResult.first != ConnectivityResult.none;
  }

  static Future executeWithFallback({
    required Future Function() online,
    required Future Function() offline,
  }) async {
    final isConnected = await isOnline();
    
    if (isConnected) {
      try {
        return await online();
      } catch (e) {
        // If online call fails, try offline
        return await offline();
      }
    } else {
      return await offline();
    }
  }

  static String generateLocalId() {
    return 'local_${DateTime.now().millisecondsSinceEpoch}';
  }
}
```

6. Update `lib/data/datasources/local/hive_service.dart`:
```dart
import 'package:hive_flutter/hive_flutter.dart';
import 'hive_models.dart';

class HiveService {
  static const String _authBox = 'auth_box';
  static const String _syncQueueBox = 'sync_queue_box';
  static const String _cacheBox = 'cache_box';
  static const String _offlineSalesBox = 'offline_sales_box';
  static const String _cachedProductsBox = 'cached_products_box';
  
  static Future init() async {
    // Register adapters
    Hive.registerAdapter(SyncQueueItemAdapter());
    Hive.registerAdapter(CachedProductAdapter());
    Hive.registerAdapter(OfflineSaleAdapter());
    Hive.registerAdapter(OfflineSaleItemAdapter());
    
    // Open boxes
    await Hive.openBox(_authBox);
    await Hive.openBox(_syncQueueBox);
    await Hive.openBox(_cacheBox);
    await Hive.openBox(_offlineSalesBox);
    await Hive.openBox(_cachedProductsBox);
  }
  
  static Box get authBox => Hive.box(_authBox);
  static Box get syncQueueBox => Hive.box(_syncQueueBox);
  static Box get cacheBox => Hive.box(_cacheBox);
  static Box get offlineSalesBox => Hive.box(_offlineSalesBox);
  static Box get cachedProductsBox => Hive.box(_cachedProductsBox);
}
```

USAGE IN POS:
```dart
// When creating sale offline
final isOnline = await OfflineHelper.isOnline();

if (!isOnline) {
  // Save to local database
  final offlineSale = OfflineSale(
    localId: OfflineHelper.generateLocalId(),
    warungId: currentUser.warungId!,
    items: cartItems,
    totalAmount: total,
    paymentMethod: paymentMethod.name,
    createdAt: DateTime.now(),
  );
  
  final localId = await ref.read(syncServiceProvider).saveOfflineSale(offlineSale);
  
  // Show success with offline notice
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(
      content: Text('Transaksi tersimpan (offline). Akan disinkronkan saat online.'),
      backgroundColor: Colors.orange,
    ),
  );
} else {
  // Normal online flow
  await ref.read(salesProvider.notifier).createSale(...);
}
```

AUTO-SYNC SETUP:
```dart
// In main.dart or app initialization
ref.listen(connectivityProvider, (previous, next) {
  next.whenData((connectivity) {
    if (connectivity != ConnectivityResult.none) {
      // Auto sync when back online
      final pendingCount = ref.read(pendingSyncCountProvider);
      if (pendingCount > 0) {
        ref.read(syncProvider.notifier).sync();
      }
    }
  });
});
```

DEPENDENCIES:
```yaml
dependencies:
  connectivity_plus: ^5.0.2
  uuid: ^4.2.2
```

Berikan implementasi lengkap dengan error handling dan retry mechanism!

ðŸ§ª PHASE 3: TESTING & QUALITY ASSURANCE
ðŸ”¹ PROMPT 3.1: Unit Testing (Backend)
markdownBuatkan comprehensive unit tests untuk NestJS backend BUMAS.

REQUIREMENTS:
1. Test untuk semua services
2. Test untuk authentication logic
3. Test untuk business logic (credit limit, stock management)
4. Mock database dengan Prisma
5. Test coverage minimal 80%

GENERATE FILES:

1. `backend/src/auth/auth.service.spec.ts`:
```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { AuthService } from './auth.service';
import { PrismaService } from '../prisma/prisma.service';
import { JwtService } from '@nestjs/jwt';
import { UnauthorizedException } from '@nestjs/common';
import * as bcrypt from 'bcrypt';

describe('AuthService', () => {
  let service: AuthService;
  let prisma: PrismaService;
  let jwtService: JwtService;

  const mockPrismaService = {
    user: {
      findUnique: jest.fn(),
      create: jest.fn(),
    },
  };

  const mockJwtService = {
    sign: jest.fn(),
    verify: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AuthService,
        {
          provide: PrismaService,
          useValue: mockPrismaService,
        },
        {
          provide: JwtService,
          useValue: mockJwtService,
        },
      ],
    }).compile();

    service = module.get(AuthService);
    prisma = module.get(PrismaService);
    jwtService = module.get(JwtService);
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('login', () => {
    it('should return tokens when credentials are valid', async () => {
      const mockUser = {
        id: '1',
        email: 'test@example.com',
        password: await bcrypt.hash('password123', 10),
        name: 'Test User',
        role: 'ADMIN',
      };

      mockPrismaService.user.findUnique.mockResolvedValue(mockUser);
      mockJwtService.sign.mockReturnValue('mock-token');

      const result = await service.login('test@example.com', 'password123');

      expect(result).toHaveProperty('accessToken');
      expect(result).toHaveProperty('refreshToken');
      expect(result).toHaveProperty('user');
      expect(result.user.email).toBe('test@example.com');
    });

    it('should throw UnauthorizedException when email not found', async () => {
      mockPrismaService.user.findUnique.mockResolvedValue(null);

      await expect(
        service.login('wrong@example.com', 'password123'),
      ).rejects.toThrow(UnauthorizedException);
    });

    it('should throw UnauthorizedException when password is wrong', async () => {
      const mockUser = {
        id: '1',
        email: 'test@example.com',
        password: await bcrypt.hash('password123', 10),
      };

      mockPrismaService.user.findUnique.mockResolvedValue(mockUser);

      await expect(
        service.login('test@example.com', 'wrongpassword'),
      ).rejects.toThrow(UnauthorizedException);
    });
  });

  describe('register', () => {
    it('should create a new user', async () => {
      const mockUser = {
        id: '1',
        email: 'new@example.com',
        name: 'New User',
        role: 'WARUNG',
      };

      mockPrismaService.user.findUnique.mockResolvedValue(null);
      mockPrismaService.user.create.mockResolvedValue(mockUser);

      const result = await service.register({
        email: 'new@example.com',
        password: 'password123',
        name: 'New User',
        role: 'WARUNG',
      });

      expect(result).toEqual(mockUser);
      expect(mockPrismaService.user.create).toHaveBeenCalled();
    });

    it('should throw error if email already exists', async () => {
      mockPrismaService.user.findUnique.mockResolvedValue({ id: '1' });

      await expect(
        service.register({
          email: 'existing@example.com',
          password: 'password123',
          name: 'User',
          role: 'WARUNG',
        }),
      ).rejects.toThrow();
    });
  });
});
```

2. `backend/src/finance/finance.service.spec.ts`:
```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { FinanceService } from './finance.service';
import { PrismaService } from '../prisma/prisma.service';
import { BadRequestException } from '@nestjs/common';

describe('FinanceService', () => {
  let service: FinanceService;
  let prisma: PrismaService;

  const mockPrismaService = {
    receivable: {
      findUnique: jest.fn(),
      findMany: jest.fn(),
      update: jest.fn(),
      create: jest.fn(),
    },
    payment: {
      create: jest.fn(),
    },
    warung: {
      findUnique: jest.fn(),
      update: jest.fn(),
    },
    $transaction: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        FinanceService,
        {
          provide: PrismaService,
          useValue: mockPrismaService,
        },
      ],
    }).compile();

    service = module.get(FinanceService);
    prisma = module.get(PrismaService);
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('recordPayment', () => {
    it('should record payment and update receivable', async () => {
      const mockReceivable = {
        id: '1',
        amount: 1000000,
        paid: 0,
        balance: 1000000,
        warungId: 'warung-1',
      };

      const mockPayment = {
        id: 'payment-1',
        receivableId: '1',
        amount: 500000,
      };

      mockPrismaService.$transaction.mockImplementation(async (callback) => {
        return callback({
          receivable: {
            findUnique: jest.fn().mockResolvedValue(mockReceivable),
            update: jest.fn().mockResolvedValue({
              ...mockReceivable,
              paid: 500000,
              balance: 500000,
            }),
          },
          payment: {
            create: jest.fn().mockResolvedValue(mockPayment),
          },
          warung: {
            update: jest.fn(),
          },
        });
      });

      const result = await service.recordPayment({
        receivableId: '1',
        amount: 500000,
        paymentMethod: 'CASH',
        userId: 'user-1',
      });

      expect(result).toBeDefined();
      expect(mockPrismaService.$transaction).toHaveBeenCalled();
    });

    it('should throw error if payment exceeds balance', async () => {
      const mockReceivable = {
        id: '1',
        amount: 1000000,
        paid: 0,
        balance: 1000000,
      };

      mockPrismaService.receivable.findUnique.mockResolvedValue(mockReceivable);

      await expect(
        service.recordPayment({
          receivableId: '1',
          amount: 1500000, // More than balance
          paymentMethod: 'CASH',
          userId: 'user-1',
        }),
      ).rejects.toThrow(BadRequestException);
    });
  });

  describe('checkAndBlockOverdue', () => {
    it('should block warung if overdue > 3 days', async () => {
      const today = new Date();
      const fourDaysAgo = new Date(today);
      fourDaysAgo.setDate(today.getDate() - 4);

      const mockOverdueReceivables = [
        {
          id: '1',
          warungId: 'warung-1',
          dueDate: fourDaysAgo,
          status: 'UNPAID',
          warung: { isBlocked: false },
        },
      ];

      mockPrismaService.receivable.findMany.mockResolvedValue(mockOverdueReceivables);

      await service.checkAndBlockOverdue();

      expect(mockPrismaService.warung.update).toHaveBeenCalledWith({
        where: { id: 'warung-1' },
        data: {
          isBlocked: true,
          blockedReason: expect.stringContaining('Overdue'),
        },
      });
    });

    it('should not block if overdue <= 3 days', async () => {
      const today = new Date();
      const twoDaysAgo = new Date(today);
      twoDaysAgo.setDate(today.getDate() - 2);

      const mockReceivables = [
        {
          id: '1',
          warungId: 'warung-1',
          dueDate: twoDaysAgo,
          status: 'UNPAID',
        },
      ];

      mockPrismaService.receivable.findMany.mockResolvedValue(mockReceivables);

      await service.checkAndBlockOverdue();

      expect(mockPrismaService.warung.update).not.toHaveBeenCalled();
    });
  });

  describe('getCreditStatus', () => {
    it('should calculate available credit correctly', async () => {
      const mockWarung = {
        id: 'warung-1',
        creditLimit: 5000000,
        currentDebt: 2000000,
      };

      mockPrismaService.warung.findUnique.mockResolvedValue(mockWarung);

      const result = await service.getCreditStatus('warung-1');

      expect(result.creditLimit).toBe(5000000);
      expect(result.currentDebt).toBe(2000000);
      expect(result.availableCredit).toBe(3000000);
      expect(result.usagePercentage).toBe(40);
    });
  });
});
```

3. `backend/src/stocks/stocks.service.spec.ts`:
```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { StocksService } from './stocks.service';
import { PrismaService } from '../prisma/prisma.service';
import { BadRequestException } from '@nestjs/common';

describe('StocksService', () => {
  let service: StocksService;
  let prisma: PrismaService;

  const mockPrismaService = {
    stock: {
      findFirst: jest.fn(),
      update: jest.fn(),
      upsert: jest.fn(),
    },
    stockMovement: {
      create: jest.fn(),
    },
    $transaction: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        StocksService,
        {
          provide: PrismaService,
          useValue: mockPrismaService,
        },
      ],
    }).compile();

    service = module.get(StocksService);
    prisma = module.get(PrismaService);
  });

  describe('recordMovement - OUT', () => {
    it('should decrease stock when movement is OUT', async () => {
      const mockStock = {
        id: 'stock-1',
        quantity: 100,
        productId: 'product-1',
        warehouseId: 'warehouse-1',
      };

      mockPrismaService.$transaction.mockImplementation(async (callback) => {
        return callback({
          stock: {
            findFirst: jest.fn().mockResolvedValue(mockStock),
            update: jest.fn().mockResolvedValue({
              ...mockStock,
              quantity: 90,
            }),
          },
          stockMovement: {
            create: jest.fn(),
          },
        });
      });

      await service.recordMovement({
        movementType: 'OUT',
        productId: 'product-1',
        toWarehouseId: 'warehouse-1',
        quantity: 10,
        userId: 'user-1',
      });

      expect(mockPrismaService.$transaction).toHaveBeenCalled();
    });

    it('should throw error if insufficient stock', async () => {
      const mockStock = {
        id: 'stock-1',
        quantity: 5, // Only 5 available
      };

      mockPrismaService.stock.findFirst.mockResolvedValue(mockStock);

      await expect(
        service.recordMovement({
          movementType: 'OUT',
          productId: 'product-1',
          toWarehouseId: 'warehouse-1',
          quantity: 10, // Trying to take 10
          userId: 'user-1',
        }),
      ).rejects.toThrow(BadRequestException);
    });
  });

  describe('recordMovement - TRANSFER', () => {
    it('should transfer stock between warehouses', async () => {
      const mockFromStock = { id: '1', quantity: 100 };
      const mockToStock = { id: '2', quantity: 50 };

      mockPrismaService.$transaction.mockImplementation(async (callback) => {
        return callback({
          stock: {
            findFirst: jest.fn()
              .mockResolvedValueOnce(mockFromStock)
              .mockResolvedValueOnce(mockToStock),
            update: jest.fn(),
          },
          stockMovement: {
            create: jest.fn(),
          },
        });
      });

      await service.recordMovement({
        movementType: 'TRANSFER',
        productId: 'product-1',
        fromWarehouseId: 'warehouse-1',
        toWarehouseId: 'warehouse-2',
        quantity: 20,
        userId: 'user-1',
      });

      expect(mockPrismaService.$transaction).toHaveBeenCalled();
    });
  });

  describe('getLowStockProducts', () => {
    it('should return products with quantity < minStock', async () => {
      const mockLowStockProducts = [
        {
          id: '1',
          productId: 'product-1',
          quantity: 5,
          minStock: 10,
          product: { name: 'Product A' },
        },
        {
          id: '2',
          productId: 'product-2',
          quantity: 2,
          minStock: 15,
          product: { name: 'Product B' },
        },
      ];

      mockPrismaService.stock.findMany = jest.fn().mockResolvedValue(mockLowStockProducts);

      const result = await service.getLowStockProducts();

      expect(result).toHaveLength(2);
      expect(result[0].quantity).toBeLessThan(result[0].minStock);
    });
  });
});
```

4. `backend/package.json` - add test scripts:
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand"
  },
  "jest": {
    "moduleFileExtensions": ["js", "json", "ts"],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s",
      "!**/*.spec.ts",
      "!**/node_modules/**",
      "!**/dist/**"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node",
    "coverageThreshold": {
      "global": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      }
    }
  }
}
```

5. Test utilities `backend/src/test/test-utils.ts`:
```typescript
import { PrismaClient } from '@prisma/client';

export class TestUtils {
  private prisma: PrismaClient;

  constructor() {
    this.prisma = new PrismaClient();
  }

  async cleanDatabase() {
    // Delete in correct order (respect foreign keys)
    await this.prisma.payment.deleteMany();
    await this.prisma.receivable.deleteMany();
    await this.prisma.saleItem.deleteMany();
    await this.prisma.sale.deleteMany();
    await this.prisma.dOItem.deleteMany();
    await this.prisma.deliveryOrder.deleteMany();
    await this.prisma.pOItem.deleteMany();
    await this.prisma.purchaseOrder.deleteMany();
    await this.prisma.stockMovement.deleteMany();
    await this.prisma.stockOpname.deleteMany();
    await this.prisma.stock.deleteMany();
    await this.prisma.product.deleteMany();
    await this.prisma.category.deleteMany();
    await this.prisma.warung.deleteMany();
    await this.prisma.supplier.deleteMany();
    await this.prisma.warehouse.deleteMany();
    await this.prisma.user.deleteMany();
  }

  async seedTestData() {
    // Create test users
    const admin = await this.prisma.user.create({
      data: {
        email: 'admin@test.com',
        password: 'hashed_password',
        name: 'Test Admin',
        role: 'ADMIN',
      },
    });

    // Create test warung
    const warung = await this.prisma.warung.create({
      data: {
        name: 'Test Warung',
        ownerName: 'Test Owner',
        phone: '08123456789',
        address: 'Test Address',
        creditLimit: 5000000,
        creditDays: 30,
      },
    });

    // Create test products
    const product = await this.prisma.product.create({
      data: {
        name: 'Test Product',
        barcode: 'TEST001',
        categoryId: 'cat-1',
        buyPrice: 5000,
        sellPrice: 7000,
        margin: 40,
        unit: 'pcs',
      },
    });

    return { admin, warung, product };
  }

  async disconnect() {
    await this.prisma.$disconnect();
  }
}
```

RUN TESTS:
```bash
# Run all tests
npm test

# Run with coverage
npm run test:cov

# Watch mode
npm run test:watch
```

Create similar test files for:
- sales.service.spec.ts
- distribution.service.spec.ts
- products.service.spec.ts
- reports.service.spec.ts

Berikan implementasi lengkap dengan edge cases dan error scenarios!

ðŸ”¹ PROMPT 3.2: Integration Testing (E2E)
markdownBuatkan End-to-End (E2E) tests untuk aplikasi BUMAS yang test complete user flows.

REQUIREMENTS:
1. Test complete workflows (order â†’ deliver â†’ sell â†’ pay)
2. Test API endpoints dengan real HTTP requests
3. Test database integration
4. Test authentication flow
5. Test error scenarios

GENERATE FILES:

1. `backend/test/auth.e2e-spec.ts`:
```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../src/app.module';
import { PrismaService } from '../src/prisma/prisma.service';

describe('Authentication (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(new ValidationPipe());
    
    prisma = app.get(PrismaService);
    
    await app.init();
  });

  afterAll(async () => {
    await prisma.$disconnect();
    await app.close();
  });

  beforeEach(async () => {
    // Clean database before each test
    await prisma.user.deleteMany();
  });

  describe('/auth/register (POST)', () => {
    it('should register a new user', () => {
      return request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'test@example.com',
          password: 'password123',
          name: 'Test User',
          role: 'WARUNG',
        })
        .expect(201)
        .expect((res) => {
          expect(res.body).toHaveProperty('id');
          expect(res.body.email).toBe('test@example.com');
          expect(res.body).not.toHaveProperty('password');
        });
    });

    it('should fail with invalid email', () => {
      return request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'invalid-email',
          password: 'password123',
          name: 'Test User',
          role: 'WARUNG',
        })
        .expect(400);
    });

    it('should fail with short password', () => {
      return request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'test@example.com',
          password: '12345',
          name: 'Test User',
          role: 'WARUNG',
        })
        .expect(400);
    });

    it('should fail if email already exists', async () => {
      // First registration
      await request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'test@example.com',
          password: 'password123',
          name: 'Test User',
          role: 'WARUNG',
        });

      // Second registration with same email
      return request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'test@example.com',
          password: 'password456',
          name: 'Another User',
          role: 'WARUNG',
        })
        .expect(409); // Conflict
    });
  });

  describe('/auth/login (POST)', () => {
    beforeEach(async () => {
      // Register a user for login tests
      await request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'test@example.com',
          password: 'password123',
          name: 'Test User',
          role: 'WARUNG',
        });
    });

    it('should login with valid credentials', () => {
      return request(app.getHttpServer())
        .post('/auth/login')
        .send({
          email: 'test@example.com',
          password: 'password123',
        })
        .expect(200)
        .expect((res) => {
          expect(res.body).toHaveProperty('accessToken');
          expect(res.body).toHaveProperty('refreshToken');
          expect(res.body).toHaveProperty('user');
          expect(res.body.user.email).toBe('test@example.com');
        });
    });

    it('should fail with wrong password', () => {
      return request(app.getHttpServer())
        .post('/auth/login')
        .send({
          email: 'test@example.com',
          password: 'wrongpassword',
        })
        .expect(401);
    });

    it('should fail with non-existent email', () => {
      return request(app.getHttpServer())
        .post('/auth/login')
        .send({
          email: 'nonexistent@example.com',
          password: 'password123',
        })
        .expect(401);
    });
  });

  describe('Protected routes', () => {
    let accessToken: string;

    beforeEach(async () => {
      // Register and login to get token
      await request(app.getHttpServer())
        .post('/auth/register')
        .send({
          email: 'test@example.com',
          password: 'password123',
          name: 'Test User',
          role: 'ADMIN',
        });

      const loginResponse = await request(app.getHttpServer())
        .post('/auth/login')
        .send({
          email: 'test@example.com',
          password: 'password123',
        });

      accessToken = loginResponse.body.accessToken;
    });

    it('should access protected route with valid token', () => {
      return request(app.getHttpServer())
        .get('/auth/me')
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200)
        .expect((res) => {
          expect(res.body.email).toBe('test@example.com');
        });
    });

    it('should fail without token', () => {
      return request(app.getHttpServer())
        .get('/auth/me')
        .expect(401);
    });

    it('should fail with invalid token', () => {
      return request(app.getHttpServer())
        .get('/auth/me')
        .set('Authorization', 'Bearer invalid-token')
        .expect(401);
    });
  });
});
```

2. `backend/test/complete-workflow.e2e-spec.ts`:
```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../src/app.module';
import { PrismaService } from '../src/prisma/prisma.service';

describe('Complete Workflow (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let adminToken: string;
  let warungToken: string;
  let warungId: string;
  let productId: string;
  let supplierId: string;
  let warehouseId: string;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    prisma = app.get(PrismaService);
    
    await app.init();
    
    // Setup: Create admin and warung users
    await setupUsers();
    await setupMasterData();
  });

  afterAll(async () => {
    await prisma.$disconnect();
    await app.close();
  });

  async function setupUsers() {
    // Create admin
    await request(app.getHttpServer())
      .post('/auth/register')
      .send({
        email: 'admin@test.com',
        password: 'admin123',
        name: 'Admin User',
        role: 'ADMIN',
      });

    const adminLogin = await request(app.getHttpServer())
      .post('/auth/login')
      .send({
        email: 'admin@test.com',
        password: 'admin123',
      });

    adminToken = adminLogin.body.accessToken;

    // Create warung user
    await request(app.getHttpServer())
      .post('/auth/register')
      .send({
        email: 'warung@test.com',
        password: 'warung123',
        name: 'Warung User',
        role: 'WARUNG',
      });

    const warungLogin = await request(app.getHttpServer())
      .post('/auth/login')
      .send({
        email: 'warung@test.com',
        password: 'warung123',
      });

    warungToken = warungLogin.body.accessToken;
  }

  async function setupMasterData() {
    // Create warehouse
    const warehouseRes = await request(app.getHttpServer())
      .post('/warehouses')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        name: 'Warehouse Pusat',
        location: 'Banyumas',
        phone: '0281123456',
      });
    
    warehouseId = warehouseRes.body.id;

    // Create supplier
    const supplierRes = await request(app.getHttpServer())
      .post('/suppliers')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        name: 'Supplier A',
        contact: 'John Doe',
        phone: '081234567890',
        address: 'Jakarta',
      });
    
    supplierId = supplierRes.body.id;

    // Create product
    const productRes = await request(app.getHttpServer())
      .post('/products')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        name: 'Indomie Goreng',
        barcode: 'INDO001',
        categoryId: 'cat-1',
        buyPrice: 2500,
        sellPrice: 3000,
        unit: 'pcs',
      });
    
    productId = productRes.body.id;

    // Create warung
    const warungRes = await request(app.getHttpServer())
      .post('/warungs')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        name: 'Warung Berkah',
        ownerName: 'Bu Siti',
        phone: '08567890123',
        address: 'Purwokerto',
        creditLimit: 5000000,
        creditDays: 30,
      });
    
    warungId = warungRes.body.id;
  }

  describe('Complete Flow: PO â†’ DO â†’ Sale â†’ Payment', () => {
    let poId: string;
    let doId: string;
    let saleId: string;
    let receivableId: string;

    it('Step 1: Admin creates Purchase Order', async () => {
      const response = await request(app.getHttpServer())
        .post('/purchase-orders')
        .set('Authorization', `Bearer ${adminToken}`)
        .send({
          supplierId,
          warehouseId,
          items: [
            {
              productId,
              quantity: 100,
              price: 2500,
            },
          ],
          notes: 'Test PO',
        })
        .expect(201);

      poId = response.body.id;
      expect(response.body).toHaveProperty('poNumber');
      expect(response.body.status).toBe('PENDING');
    });

    it('Step 2: Admin approves Purchase Order', async () => {
      const response = await request(app.getHttpServer())
        .put(`/purchase-orders/${poId}/approve`)
        .set('Authorization', `Bearer ${adminToken}`)
        .expect(200);

      expect(response.body.status).toBe('APPROVED');
    });

    it('Step 3: Gudang receives goods (update stock)', async () => {
      const response = await request(app.getHttpServer())
        .post(`/purchase-orders/${poId}/receive`)
        .set('Authorization', `Bearer ${adminToken}`)
        .send({
          receivedItems: [
            {
              productId,
              quantity: 100,
            },
          ],
        })
        .expect(200);

      expect(response.body.status).toBe('RECEIVED');

      // Check stock updated
      const stockRes = await request(app.getHttpServer())
        .get(`/stocks?warehouseId=${warehouseId}&productId=${productId}`)
        .set('Authorization', `Bearer ${adminToken}`);

      expect(stockRes.body[0].quantity).toBe(100);
    });

    it('Step 4: Admin creates Delivery Order to warung', async () => {
      const response = await request(app.getHttpServer())
        .post('/delivery-orders')
        .set('Authorization', `Bearer ${adminToken}`)
        .send({
          warungId,
          items: [
            {
              productId,
              quantity: 50,
              price: 3000,
            },
          ],
          creditDays: 30,
        })
        .expect(201);

      doId = response.body.id;
      expect(response.body).toHaveProperty('doNumber');
      expect(response.body.totalAmount).toBe(150000); // 50 * 3000
    });

    it('Step 5: Kurir confirms delivery', async () => {
      const response = await request(app.getHttpServer())
        .post(`/delivery-orders/${doId}/confirm`)
        .set('Authorization', `Bearer ${adminToken}`)
        .send({
          photoProof: 'base64_image_here',
        })
        .expect(200);

      expect(response.body.status).toBe('CONFIRMED');

      // Check receivable created
      const receivablesRes = await request(app.getHttpServer())
        .get(`/receivables?warungId=${warungId}`)
        .set('Authorization', `Bearer ${adminToken}`);

      expect(receivablesRes.body.length).toBeGreaterThan(0);
      receivableId = receivablesRes.body[0].id;
      expect(receivablesRes.body[0].amount).toBe(150000);
    });

    it('Step 6: Warung makes sales transaction', async () => {
      const response = await request(app.getHttpServer())
        .post('/sales')
        .set('Authorization', `Bearer ${warungToken}`)
        .send({
          warungId,
          items: [
            {
              productId,
              quantity: 10,
              price: 3000,
            },
          ],
          paymentMethod: 'CASH',
          cashReceived: 50000,
        })
        .expect(201);

      saleId = response.body.id;
      expect(response.body).toHaveProperty('saleNumber');
      expect(response.body.totalAmount).toBe(30000);
      expect(response.body.cashChange).toBe(20000);
    });

    it('Step 7: Warung pays receivable', async () => {
      const response = await request(app.getHttpServer())
        .post('/payments')
        .set('Authorization', `Bearer ${warungToken}`)
        .send({
          receivableId,
          amount: 150000,
          paymentMethod: 'TRANSFER',
          paymentProof: 'base64_proof_here',
        })
        .expect(201);

      expect(response.body).toHaveProperty('paymentNo');

      // Check receivable updated
      const receivableRes = await request(app.getHttpServer())
        .get(`/receivables/${receivableId}`)
        .set('Authorization', `Bearer ${adminToken}`);

      expect(receivableRes.body.paid).toBe(150000);
      expect(receivableRes.body.balance).toBe(0);
      expect(receivableRes.body.status).toBe('PAID');
    });

    it('Step 8: Check reports reflect all transactions', async () => {
      const dashboardRes = await request(app.getHttpServer())
        .get('/reports/dashboard')
        .set('Authorization', `Bearer ${adminToken}`)
        .expect(200);

      expect(dashboardRes.body.today.omzet).toBeGreaterThan(0);
      expect(dashboardRes.body.today.piutangBelumLunas).toBe(0); // Fully paid
    });
  });

  describe('Error Scenarios', () => {
    it('should fail to create DO if warung credit limit exceeded', async () => {
      // Create DO that exceeds credit limit
      return request(app.getHttpServer())
        .post('/delivery-orders')
        .set('Authorization', `Bearer ${adminToken}`)
        .send({
          warungId,
          items: [
            {
              productId,
              quantity: 2000, // Very large quantity
              price: 3000,
            },
          ],
          creditDays: 30,
        })
        .expect(400) // Bad Request
        .expect((res) => {
          expect(res.body.message).toContain('credit limit');
        });
    });

    it('should fail to sell if stock insufficient', async () => {
      return request(app.getHttpServer())
        .post('/sales')
        .set('Authorization', `Bearer ${warungToken}`)
        .send({
          warungId,
          items: [
            {
              productId,
              quantity: 10000, // More than available
              price: 3000,
            },
          ],
          paymentMethod: 'CASH',
          cashReceived: 50000000,
        })
        .expect(400)
        .expect((res) => {
          expect(res.body.message).toContain('insufficient stock');
        });
    });

    it('should fail payment if amount exceeds balance', async () => {
      // First create a receivable
      const doRes = await request(app.getHttpServer())
        .post('/delivery-orders')
        .set('Authorization', `Bearer ${adminToken}`)
        .send({
          warungId,
          items: [{ productId, quantity: 10, price: 3000 }],
          creditDays: 30,
        });

      await request(app.getHttpServer())
        .post(`/delivery-orders/${doRes.body.id}/confirm`)
        .set('Authorization', `Bearer ${adminToken}`)
        .send({ photoProof: 'test' });

      const receivablesRes = await request(app.getHttpServer())
        .get(`/receivables?warungId=${warungId}`)
        .set('Authorization', `Bearer ${adminToken}`);

      const receivableId = receivablesRes.body[0].id;

      // Try to pay more than balance
      return request(app.getHttpServer())
        .post('/payments')
        .set('Authorization', `Bearer ${warungToken}`)
        .send({
          receivableId,
          amount: 999999999, // Excessive amount
          paymentMethod: 'CASH',
        })
        .expect(400);
    });
  });
});
```

3. `backend/test/jest-e2e.json`:
```json
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  },
  "moduleNameMapper": {
    "^src/(.*)$": "/../src/$1"
  },
  "setupFilesAfterEnv": ["/setup.ts"]
}
```

4. `backend/test/setup.ts`:
```typescript
// Global setup for E2E tests
beforeAll(async () => {
  // Set test environment
  process.env.NODE_ENV = 'test';
  process.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/bumas_test';
});

afterAll(async () => {
  // Cleanup
});
```

RUN E2E TESTS:
```bash
# Run E2E tests
npm run test:e2e

# With specific test file
npm run test:e2e -- auth.e2e-spec.ts
```

Create additional E2E test files for:
- products.e2e-spec.ts
- stocks.e2e-spec.ts
- reports.e2e-spec.ts
- finance.e2e-spec.ts

Berikan implementasi lengkap dengan setup dan teardown!