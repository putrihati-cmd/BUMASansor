name: Flutter Build Artifacts

on:
  push:
    tags:
      - "mobile-v*"
  workflow_dispatch:

jobs:
  build-mobile:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: mobile_app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Test
        run: flutter test

      - name: Build dev APK
        run: flutter build apk --flavor dev --debug --dart-define=API_BASE_URL=http://10.0.2.2:3000/api

      - name: Decode keystore
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks

      - name: Build staging APK (release)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/mobile_app/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: flutter build apk --flavor staging --release --dart-define=API_BASE_URL=https://staging-api.bumasansor.com/api

      - name: Build prod AAB (release)
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/mobile_app/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: flutter build appbundle --flavor prod --release --dart-define=API_BASE_URL=https://api.bumasansor.com/api

      - name: Upload dev APK
        uses: actions/upload-artifact@v4
        with:
          name: app-dev-debug.apk
          path: mobile_app/build/app/outputs/flutter-apk/app-dev-debug.apk

      - name: Upload staging APK
        uses: actions/upload-artifact@v4
        with:
          name: app-staging-release.apk
          path: mobile_app/build/app/outputs/flutter-apk/app-staging-release.apk
          if-no-files-found: ignore

      - name: Upload prod AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-prod-release.aab
          path: mobile_app/build/app/outputs/bundle/prodRelease/app-prod-release.aab
          if-no-files-found: ignore

