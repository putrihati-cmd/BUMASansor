generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model activity_logs {
  id          String   @id
  user_id     String?
  action      String
  entity_type String
  entity_id   String
  metadata    Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())
}

model addresses {
  id             String   @id
  user_id        String
  label          String   @default("HOME")
  recipient_name String
  phone          String
  full_address   String
  province       String
  city           String
  district       String
  postal_code    String
  is_default     Boolean  @default(false)
  created_at     DateTime @default(now())
  users          users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  orders         orders[]
}

model affiliate_commissions {
  id                String           @id
  affiliate_id      String
  order_id          String
  order_amount      Decimal          @db.Decimal(12, 2)
  commission_rate   Decimal          @db.Decimal(5, 4)
  commission_amount Decimal          @db.Decimal(12, 2)
  status            CommissionStatus @default(PENDING)
  paid_at           DateTime?
  created_at        DateTime         @default(now())
  affiliates        affiliates       @relation(fields: [affiliate_id], references: [id], onDelete: Cascade)
  orders            orders           @relation(fields: [order_id], references: [id])
}

model affiliate_referrals {
  id               String     @id
  affiliate_id     String
  referred_user_id String
  referred_at      DateTime   @default(now())
  affiliates       affiliates @relation(fields: [affiliate_id], references: [id], onDelete: Cascade)
  users            users      @relation(fields: [referred_user_id], references: [id], onDelete: Cascade)

  @@unique([affiliate_id, referred_user_id])
}

model affiliate_withdrawals {
  id           String           @id
  affiliate_id String
  amount       Decimal          @db.Decimal(12, 2)
  status       WithdrawalStatus @default(PENDING)
  bank_account Json
  proof_url    String?
  notes        String?
  processed_by String?
  processed_at DateTime?
  created_at   DateTime         @default(now())
  affiliates   affiliates       @relation(fields: [affiliate_id], references: [id], onDelete: Cascade)
}

model affiliates {
  id                    String                  @id
  user_id               String                  @unique
  referral_code         String                  @unique
  commission_rate       Decimal                 @default(0.05) @db.Decimal(5, 4)
  tier                  AffiliateTier           @default(BRONZE)
  total_earnings        Decimal                 @default(0) @db.Decimal(12, 2)
  available_balance     Decimal                 @default(0) @db.Decimal(12, 2)
  total_referrals       Int                     @default(0)
  status                AffiliateStatus         @default(ACTIVE)
  bank_account          Json?
  created_at            DateTime                @default(now())
  updated_at            DateTime
  affiliate_commissions affiliate_commissions[]
  affiliate_referrals   affiliate_referrals[]
  affiliate_withdrawals affiliate_withdrawals[]
  users                 users                   @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model bundle_products {
  id         String   @id
  bundle_id  String
  product_id String
  quantity   Int      @default(1)
  created_at DateTime @default(now())
  bundles    bundles  @relation(fields: [bundle_id], references: [id], onDelete: Cascade)
  products   products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([bundle_id, product_id])
}

model bundles {
  id              String            @id
  name            String
  slug            String            @unique
  description     String?
  image_url       String?
  discount_type   DiscountType      @default(PERCENTAGE)
  discount_value  Decimal           @db.Decimal(12, 2)
  min_quantity    Int               @default(2)
  is_active       Boolean           @default(true)
  valid_from      DateTime?
  valid_until     DateTime?
  created_at      DateTime          @default(now())
  updated_at      DateTime
  bundle_products bundle_products[]
}

model carts {
  id               String            @id
  user_id          String?
  session_id       String?
  product_id       String
  variant_id       String?
  quantity         Int
  created_at       DateTime          @default(now())
  updated_at       DateTime
  products         products          @relation(fields: [product_id], references: [id], onDelete: Cascade)
  users            users?            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product_variants product_variants? @relation(fields: [variant_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id, variant_id])
}

model categories {
  id               String       @id
  name             String
  slug             String       @unique
  description      String?
  image_url        String?
  parent_id        String?
  created_at       DateTime     @default(now())
  categories       categories?  @relation("categoriesTocategories", fields: [parent_id], references: [id])
  other_categories categories[] @relation("categoriesTocategories")
  products         products[]
}

model chat_messages {
  id         String    @id
  order_id   String?
  user_id    String
  message    String
  image_url  String?
  is_admin   Boolean   @default(false)
  read_at    DateTime?
  created_at DateTime  @default(now())
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model contact_messages {
  id         String        @id
  name       String
  email      String
  phone      String?
  subject    String
  message    String
  status     ContactStatus @default(NEW)
  replied_at DateTime?
  created_at DateTime      @default(now())
}

model email_campaigns {
  id              String         @id
  subject         String
  content         String
  target          String
  recipient_count Int
  sent_count      Int            @default(0)
  failed_count    Int            @default(0)
  status          CampaignStatus @default(DRAFT)
  product_id      String?
  voucher_code    String?
  sent_by         String
  sent_at         DateTime?
  created_at      DateTime       @default(now())
  users           users          @relation(fields: [sent_by], references: [id])
}

model flash_sale_products {
  id            String      @id
  flash_sale_id String
  product_id    String
  sale_price    Decimal     @db.Decimal(12, 2)
  stock_limit   Int
  sold_count    Int         @default(0)
  created_at    DateTime    @default(now())
  flash_sales   flash_sales @relation(fields: [flash_sale_id], references: [id], onDelete: Cascade)
  products      products    @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([flash_sale_id, product_id])
}

model flash_sale_purchases {
  id                    String   @id
  flash_sale_product_id String
  user_id               String
  quantity              Int
  created_at            DateTime @default(now())

  @@unique([flash_sale_product_id, user_id])
}

model flash_sales {
  id                  String                @id
  name                String
  slug                String                @unique
  description         String?
  banner_url          String?
  start_time          DateTime
  end_time            DateTime
  status              FlashSaleStatus       @default(UPCOMING)
  created_at          DateTime              @default(now())
  updated_at          DateTime
  flash_sale_products flash_sale_products[]
}

model inventory_logs {
  id              String        @id
  product_id      String
  variant_id      String?
  type            InventoryType
  quantity        Int
  quantity_before Int
  quantity_after  Int
  order_id        String?
  user_id         String?
  notes           String?
  created_at      DateTime      @default(now())

  @@index([created_at])
  @@index([product_id])
}

model newsletter_subscribers {
  id              String           @id
  email           String           @unique
  name            String?
  status          SubscriberStatus @default(ACTIVE)
  subscribed_at   DateTime         @default(now())
  unsubscribed_at DateTime?
}

model notifications {
  id         String    @id
  user_id    String
  type       String
  title      String
  message    String
  data       Json?
  read_at    DateTime?
  created_at DateTime  @default(now())
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model order_items {
  id                String            @id
  order_id          String
  product_id        String
  variant_id        String?
  product_name      String
  variant_name      String?
  quantity          Int
  price_at_purchase Decimal           @db.Decimal(12, 2)
  subtotal          Decimal           @db.Decimal(12, 2)
  orders            orders            @relation(fields: [order_id], references: [id], onDelete: Cascade)
  products          products          @relation(fields: [product_id], references: [id])
  product_variants  product_variants? @relation(fields: [variant_id], references: [id])
}

model order_state_logs {
  id          String       @id
  order_id    String
  from_status OrderStatus?
  to_status   OrderStatus
  changed_by  String?
  reason      String?
  metadata    Json?
  created_at  DateTime     @default(now())

  @@index([created_at])
  @@index([order_id])
}

model orders {
  id                    String                  @id
  order_number          String                  @unique
  user_id               String?
  address_id            String?
  guest_email           String?
  guest_phone           String?
  guest_name            String?
  subtotal              Decimal                 @db.Decimal(12, 2)
  shipping_cost         Decimal                 @db.Decimal(12, 2)
  discount              Decimal                 @default(0) @db.Decimal(12, 2)
  tax                   Decimal                 @default(0) @db.Decimal(12, 2)
  total                 Decimal                 @db.Decimal(12, 2)
  payment_method        String?
  shipping_method       String?
  courier_service       String?
  notes                 String?
  idempotency_key       String?
  status                OrderStatus             @default(PENDING_PAYMENT)
  created_at            DateTime                @default(now())
  updated_at            DateTime
  affiliate_commissions affiliate_commissions[]
  order_items           order_items[]
  addresses             addresses?              @relation(fields: [address_id], references: [id])
  users                 users?                  @relation(fields: [user_id], references: [id])
  payments              payments?
  refund_requests       refund_requests[]
  shipments             shipments?
  stockReservations     stock_reservations[]
  disputes              disputes[]
  fraud_events          fraud_events[]
  invoice               invoices?

  @@index([created_at])
  @@index([guest_email])
  @@index([status])
  @@index([user_id, idempotency_key])
  @@index([user_id])
}

model otp_verifications {
  id         String   @id
  user_id    String?
  phone      String
  otp        String
  type       String
  attempts   Int      @default(0)
  verified   Boolean  @default(false)
  expires_at DateTime
  created_at DateTime @default(now())
  users      users?   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at])
  @@index([phone])
  @@index([user_id])
}

model payment_logs {
  id             String   @id
  order_id       String
  transaction_id String   @unique
  payment_type   String
  gross_amount   Decimal  @db.Decimal(12, 2)
  status         String
  fraud_status   String?
  signature_key  String?
  raw_response   Json
  processed_at   DateTime @default(now())

  @@index([order_id])
  @@index([transaction_id])
}

model payments {
  id                     String        @id
  order_id               String        @unique
  payment_method         String
  amount                 Decimal       @db.Decimal(12, 2)
  status                 PaymentStatus @default(PENDING)
  payment_proof_url      String?
  gateway_transaction_id String?       @unique
  gateway_order_id       String?
  gateway_response       Json?
  fraud_status           String?
  expires_at             DateTime?
  paid_at                DateTime?
  created_at             DateTime      @default(now())
  updated_at             DateTime
  orders                 orders        @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([gateway_transaction_id])
  @@index([status])
}

model point_transactions {
  id          String               @id
  user_id     String
  type        PointTransactionType
  amount      Int
  balance     Int
  description String
  order_id    String?
  expires_at  DateTime?
  created_at  DateTime             @default(now())
  users       users                @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model product_answers {
  id                String            @id
  question_id       String
  answer            String
  is_official       Boolean           @default(false)
  created_at        DateTime          @default(now())
  product_questions product_questions @relation(fields: [question_id], references: [id], onDelete: Cascade)
}

model product_questions {
  id              String            @id
  product_id      String
  user_id         String
  question        String
  status          QuestionStatus    @default(PENDING)
  created_at      DateTime          @default(now())
  product_answers product_answers[]
  products        products          @relation(fields: [product_id], references: [id], onDelete: Cascade)
  users           users             @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model product_variants {
  id               String        @id
  product_id       String
  name             String
  sku              String        @unique
  price_adjustment Decimal       @default(0) @db.Decimal(12, 2)
  stock            Int           @default(0)
  attributes       Json
  carts            carts[]
  order_items      order_items[]
  products         products      @relation(fields: [product_id], references: [id], onDelete: Cascade)
}

model products {
  id                  String                @id
  name                String
  slug                String                @unique
  description         String
  category_id         String
  base_price          Decimal               @db.Decimal(12, 2)
  sale_price          Decimal?              @db.Decimal(12, 2)
  stock               Int                   @default(0)
  weight              Int                   @default(0)
  dimensions          Json?
  images              Json
  seo_metadata        Json?
  status              ProductStatus         @default(ACTIVE)
  is_featured         Boolean               @default(false)
  created_at          DateTime              @default(now())
  updated_at          DateTime
  bundle_products     bundle_products[]
  carts               carts[]
  flash_sale_products flash_sale_products[]
  order_items         order_items[]
  product_questions   product_questions[]
  product_variants    product_variants[]
  categories          categories            @relation(fields: [category_id], references: [id])
  reviews             reviews[]
  wishlists           wishlists[]
  stockReservations   stock_reservations[]
  stock_movements     stock_movements[]
  product_reviews     product_reviews[]

  @@index([category_id])
  @@index([created_at])
  @@index([is_featured])
  @@index([status])
}

model refund_requests {
  id              String       @id
  order_id        String
  user_id         String
  reason          String
  refund_type     RefundType   @default(FULL)
  amount          Decimal      @db.Decimal(12, 2)
  status          RefundStatus @default(PENDING)
  evidence        Json?
  admin_notes     String?
  resolved_by     String?
  resolved_at     DateTime?
  rejected_reason String?
  created_at      DateTime     @default(now())
  updated_at      DateTime
  orders          orders       @relation(fields: [order_id], references: [id])
  users           users        @relation(fields: [user_id], references: [id])
}

model review_helpfuls {
  id         String   @id
  review_id  String
  user_id    String
  created_at DateTime @default(now())
  reviews    reviews  @relation(fields: [review_id], references: [id], onDelete: Cascade)

  @@unique([review_id, user_id])
}

model reviews {
  id              String            @id
  product_id      String
  user_id         String
  rating          Int
  title           String?
  comment         String
  images          Json?
  helpful_count   Int               @default(0)
  status          ReviewStatus      @default(PENDING)
  created_at      DateTime          @default(now())
  review_helpfuls review_helpfuls[]
  products        products          @relation(fields: [product_id], references: [id], onDelete: Cascade)
  users           users             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([product_id, user_id])
}

model settings {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  is_public   Boolean  @default(false)
  updated_at  DateTime
}

model shipments {
  id              String         @id
  order_id        String         @unique
  courier         String
  service_type    String
  tracking_number String?
  estimated_days  Int?
  status          ShipmentStatus @default(PENDING)
  shipped_at      DateTime?
  delivered_at    DateTime?
  created_at      DateTime       @default(now())
  orders          orders         @relation(fields: [order_id], references: [id], onDelete: Cascade)
}

model stock_notifications {
  id           String    @id
  email        String
  product_id   String
  product_name String?
  notified_at  DateTime?
  created_at   DateTime  @default(now())

  @@unique([email, product_id])
}

model user_points {
  id         String   @id
  user_id    String   @unique
  balance    Int      @default(0)
  lifetime   Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model users {
  id                         String                @id
  email                      String?               @unique
  password_hash              String
  name                       String
  phone                      String?
  avatar_url                 String?
  google_id                  String?               @unique
  role                       UserRole              @default(CUSTOMER)
  status                     UserStatus            @default(ACTIVE)
  email_verified_at          DateTime?
  verification_token         String?
  verification_token_expires DateTime?
  reset_password_token       String?
  reset_password_expires     DateTime?
  created_at                 DateTime              @default(now())
  updated_at                 DateTime
  addresses                  addresses[]
  affiliate_referrals        affiliate_referrals[]
  affiliates                 affiliates?
  carts                      carts[]
  chat_messages              chat_messages[]
  email_campaigns            email_campaigns[]
  notifications              notifications[]
  orders                     orders[]
  otp_verifications          otp_verifications[]
  point_transactions         point_transactions[]
  product_questions          product_questions[]
  refund_requests            refund_requests[]
  reviews                    reviews[]
  user_points                user_points?
  wishlists                  wishlists[]
  walletTransactions         wallet_transactions[]
  product_reviews            product_reviews[]
  user_risk_profiles         user_risk_profiles?
  fraud_events               fraud_events[]
  invoices                   invoices[]
  disputeMessages            dispute_messages[]
}

model vouchers {
  id           String        @id
  code         String        @unique
  type         VoucherType
  value        Decimal       @db.Decimal(12, 2)
  min_purchase Decimal       @default(0) @db.Decimal(12, 2)
  max_discount Decimal?      @db.Decimal(12, 2)
  usage_limit  Int?
  used_count   Int           @default(0)
  valid_from   DateTime
  valid_until  DateTime
  status       VoucherStatus @default(ACTIVE)
  created_at   DateTime      @default(now())
}

model wishlists {
  id         String   @id
  user_id    String
  product_id String
  created_at DateTime @default(now())
  products   products @relation(fields: [product_id], references: [id], onDelete: Cascade)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id])
}

enum AffiliateStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum AffiliateTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum CampaignStatus {
  DRAFT
  SENDING
  COMPLETED
  FAILED
}

enum CommissionStatus {
  PENDING
  CONFIRMED
  PAID
  CANCELLED
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum FlashSaleStatus {
  UPCOMING
  ACTIVE
  ENDED
}

enum InventoryType {
  SALE
  SALE_CANCELLED
  RESTOCK
  ADJUSTMENT
  RETURN
  DAMAGED
}

enum OrderStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  FAILED
  REFUNDED
}

enum PaymentStatus {
  INIT
  PENDING
  SUCCESS
  FAILED
  EXPIRED
  REFUNDED
}

enum PointTransactionType {
  EARN_PURCHASE
  EARN_REVIEW
  EARN_DAILY
  EARN_MISSION
  EARN_REFERRAL
  REDEEM
  EXPIRE
  ADMIN_ADJUST
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  SOLD_OUT
  ARCHIVED
}

enum QuestionStatus {
  PENDING
  ANSWERED
  HIDDEN
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum RefundType {
  FULL
  PARTIAL
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
}

enum SubscriberStatus {
  ACTIVE
  UNSUBSCRIBED
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  UNVERIFIED
}

enum VoucherStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

enum VoucherType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

// ===================================================================
// WEEK 2-3 PRODUCTION MODELS
// Added: 2024-12-28 01:49
// ===================================================================

// Stock Reservation - Prevent race conditions
model stock_reservations {
  id          String             @id @default(uuid())
  order_id    String
  product_id  String
  variant_id  String?
  quantity    Int
  status      reservation_status @default(PENDING)
  expires_at  DateTime
  released_at DateTime?
  created_at  DateTime           @default(now())

  orders   orders   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  products products @relation(fields: [product_id], references: [id])

  @@index([order_id])
  @@index([product_id])
  @@index([expires_at])
  @@index([status])
}

enum reservation_status {
  PENDING
  CONFIRMED
  RELEASED
}

// Dispute System
model disputes {
  id               String         @id @default(uuid())
  dispute_number   String         @unique
  order_id         String
  type             dispute_type
  status           dispute_status @default(OPENED)
  description      String
  requested_amount Decimal?       @db.Decimal(12, 2)
  requested_action String
  buyer_evidence   Json?
  seller_evidence  Json?
  resolution       String?
  resolved_by      String?
  resolved_at      DateTime?
  refund_amount    Decimal?       @db.Decimal(12, 2)
  opened_at        DateTime       @default(now())
  respond_by       DateTime
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  orders           orders             @relation(fields: [order_id], references: [id])
  dispute_messages dispute_messages[]

  @@index([order_id])
  @@index([status])
}

enum dispute_type {
  ITEM_NOT_RECEIVED
  ITEM_DAMAGED
  ITEM_NOT_AS_DESCRIBED
  WRONG_ITEM
  INCOMPLETE_ORDER
  OTHER
}

enum dispute_status {
  OPENED
  SELLER_RESPONDED
  ADMIN_REVIEWING
  AWAITING_EVIDENCE
  RESOLVED_BUYER_FAVOR
  RESOLVED_SELLER_FAVOR
  RESOLVED_COMPROMISE
  CLOSED_NO_RESPONSE
}

model dispute_messages {
  id          String   @id @default(uuid())
  dispute_id  String
  sender_id   String
  role        String
  message     String
  attachments Json?
  created_at  DateTime @default(now())

  dispute disputes @relation(fields: [dispute_id], references: [id], onDelete: Cascade)
  sender  users    @relation(fields: [sender_id], references: [id])

  @@index([dispute_id, created_at])
}

// Webhook Logging
model webhook_logs {
  id           String   @id @default(uuid())
  provider     String
  event        String
  payload      Json
  error        String?
  stack_trace  String?
  status       String
  processed_at DateTime @default(now())

  @@index([provider])
  @@index([event])
  @@index([processed_at])
}

// Wallet & Escrow System
model wallet_transactions {
  id             String   @id @default(uuid())
  user_id        String
  type           String
  amount         Decimal  @db.Decimal(12, 2)
  description    String
  reference_type String?
  reference_id   String?
  status         String
  created_at     DateTime @default(now())

  users users @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([reference_type, reference_id])
  @@index([created_at])
}

model platform_revenues {
  id         String   @id @default(uuid())
  order_id   String
  amount     Decimal  @db.Decimal(12, 2)
  type       String
  created_at DateTime @default(now())

  @@index([order_id])
  @@index([created_at])
}

// Enhanced Audit Logging (in addition to activity_logs)
model audit_logs {
  id         String   @id @default(uuid())
  user_id    String
  action     String
  resource   String
  ip_address String?
  user_agent String?
  metadata   Json?
  created_at DateTime @default(now())

  @@index([user_id])
  @@index([action])
  @@index([created_at])
}

// ===================================================================
// ADVANCED MODELS - Stock Movement & Courier Webhooks Only
// ===================================================================

// Stock Movement Tracking
model stock_movements {
  id           String  @id @default(uuid())
  product_id   String
  type         String // 'reservation' | 'release' | 'sale' | 'restock' | 'adjustment'
  quantity     Int // Positive or negative
  reference    String? // orderId, purchaseOrderId, etc
  reason       String?
  performed_by String? // userId or 'system'

  // Snapshot for audit
  stock_before Int
  stock_after  Int

  created_at DateTime @default(now())

  products products @relation(fields: [product_id], references: [id])

  @@index([product_id, created_at])
}

// Courier Webhook Logs
model courier_webhooks {
  id              String    @id @default(uuid())
  courier         String
  tracking_number String
  event           String // 'picked_up' | 'in_transit' | 'delivered'
  raw_payload     Json
  processed       Boolean   @default(false)
  processed_at    DateTime?
  created_at      DateTime  @default(now())

  @@index([courier, tracking_number])
  @@index([processed])
}

// ===================================================================
// ENHANCED MODELS - Reviews, Email Queue, Search
// ===================================================================

// ENHANCED REVIEWS
model product_reviews {
  id         String  @id @default(uuid())
  product_id String
  user_id    String
  order_id   String? // Verified purchase if present

  rating  Int // 1-5
  comment String? @db.Text
  photos  Json? // Array of photo URLs

  is_verified   Boolean @default(false)
  is_with_photo Boolean @default(false)
  status        String  @default("APPROVED") // PENDING | APPROVED | REJECTED

  helpful_count Int @default(0)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product products @relation(fields: [product_id], references: [id])
  user    users    @relation(fields: [user_id], references: [id])

  @@index([product_id, rating])
  @@index([user_id])
}

// EMAIL QUEUE SYSTEM
model email_queue {
  id        String @id @default(uuid())
  recipient String
  template  String // 'order_confirmed', 'payment_reminder', etc
  data      Json

  status          String    @default("PENDING") // PENDING | SENT | FAILED
  attempts        Int       @default(0)
  last_attempt_at DateTime?
  sent_at         DateTime?
  error_log       String?

  priority Int @default(0) // Higher = sent first

  created_at DateTime @default(now())

  @@index([status, priority])
}

// SEARCH HISTORY (Optional analytics)
model search_history {
  id           String   @id @default(uuid())
  user_id      String?
  query        String
  filters      Json?
  result_count Int
  created_at   DateTime @default(now())

  @@index([created_at])
}

// ==========================================
// FRAUD DETECTION SYSTEM
// Added during Audit & Recovery
// ==========================================

model blacklists {
  id         String    @id @default(uuid())
  type       String // 'IP' | 'DEVICE' | 'EMAIL'
  value      String // Hashed value
  reason     String?
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  expires_at DateTime?

  @@index([type, value])
  @@map("blacklists")
}

model user_risk_profiles {
  id                String    @id @default(uuid())
  user_id           String    @unique
  risk_score        Int       @default(0)
  risk_level        String    @default("LOW")
  is_blacklisted    Boolean   @default(false)
  blacklist_reason  String?
  blacklisted_at    DateTime?
  last_login_ip     String?
  last_login_device String?
  updated_at        DateTime  @updatedAt

  user users @relation(fields: [user_id], references: [id])

  @@map("user_risk_profiles")
}

model fraud_events {
  id                 String    @id @default(uuid())
  event_type         String // ORDER_CHECK, PAYMENT_CHECK
  event_category     String // ORDER, PAYMENT, REVIEW
  user_id            String?
  order_id           String?
  payment_id         String?
  risk_score         Int
  triggers           Json?
  decision           String // BLOCK, REVIEW, ALLOW
  ip_address         String?
  device_fingerprint String?
  metadata           Json?
  notes              String?
  is_reviewed        Boolean   @default(false)
  reviewed_by        String?
  reviewed_at        DateTime?
  created_at         DateTime  @default(now())

  user  users?  @relation(fields: [user_id], references: [id])
  order orders? @relation(fields: [order_id], references: [id])

  @@map("fraud_events")
}

// =========================
// INVOICE & TAX SYSTEM
// =========================

model invoice_sequences {
  id            String @id @default(uuid())
  year          Int
  month         Int
  last_sequence Int    @default(0)

  @@unique([year, month])
  @@map("invoice_sequences")
}

model invoices {
  id             String @id @default(uuid())
  invoice_number String @unique
  order_id       String @unique
  user_id        String

  // Company Info Snapshot
  company_name    String
  company_npwp    String
  company_address String

  // Buyer Info Snapshot
  buyer_name    String
  buyer_email   String
  buyer_address String
  buyer_npwp    String?

  // Amounts
  subtotal          Decimal @db.Decimal(12, 2)
  taxable_amount    Decimal @db.Decimal(12, 2)
  tax_exempt_amount Decimal @db.Decimal(12, 2)
  total_tax         Decimal @db.Decimal(12, 2)
  shipping_cost     Decimal @db.Decimal(12, 2)
  total_amount      Decimal @db.Decimal(12, 2)

  // Status
  status              String    @default("ACTIVE") // ACTIVE, CANCELLED
  cancellation_reason String?
  cancelled_at        DateTime?

  // Replacement Chain
  replaces    String?
  replaced_by String?

  issued_at  DateTime @default(now())
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user  users  @relation(fields: [user_id], references: [id])
  order orders @relation(fields: [order_id], references: [id])

  @@map("invoices")
}


model banners {
  id          String   @id @default(uuid())
  title       String
  subtitle    String?
  image_url   String
  link        String?
  alt_text    String?
  order       Int      @default(0)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}
