generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  WARUNG
  KURIR
  GUDANG
}

enum MovementType {
  IN
  OUT
  TRANSFER
  ADJUSTMENT
}

enum OrderStatus {
  PENDING
  APPROVED
  PREPARING
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  QRIS
  EDC
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
}

model User {
  id                 String          @id @default(uuid())
  email              String          @unique
  password           String
  name               String
  role               Role            @default(WARUNG)
  phone              String?
  warungId           String?
  warung             Warung?         @relation(fields: [warungId], references: [id], onDelete: SetNull)
  refreshTokens      RefreshToken[]
  stockMovements     StockMovement[]
  stockOpnames       StockOpname[]   @relation("stock_opname_user")
  createdOrders      Order[]         @relation("order_creator")
  assignedDeliveries DeliveryTask[]  @relation("delivery_kurir")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  deletedAt          DateTime?

  @@index([role])
  @@index([warungId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Warung {
  id          String  @id @default(uuid())
  name        String
  ownerName   String
  phone       String?
  address     String?
  region      String?
  latitude    Float?
  longitude   Float?
  creditLimit Decimal @default(0) @db.Decimal(12, 2)
  currentDebt Decimal @default(0) @db.Decimal(12, 2)

  users         User[]
  inventory     WarungProduct[]
  sales         Sale[] // Sales to customers
  restockOrders Order[] // Orders to BUMAS
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?

  @@index([region])
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String   @unique
  location  String
  phone     String?
  stocks    Stock[] // Central stocks
  orders    Order[] // Outbound to warungs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id             String   @id @default(uuid())
  name           String
  barcode        String   @unique
  sku            String?  @unique
  categoryId     String
  category       Category @relation(fields: [categoryId], references: [id])
  basePrice      Decimal  @db.Decimal(10, 2) // BUMAS wholesale price
  suggestedPrice Decimal? @db.Decimal(10, 2)
  unit           String
  description    String?
  imageUrl       String?
  isActive       Boolean  @default(true)

  stocks         Stock[] // Central stocks
  warungProducts WarungProduct[] // Warung inventories
  orderItems     OrderItem[]
  stockMovements StockMovement[]
  stockOpnames   StockOpname[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

// Central Warehouse Stock
model Stock {
  id          String    @id @default(uuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  quantity    Int       @default(0)
  minStock    Int       @default(10)
  updatedAt   DateTime  @updatedAt

  @@unique([warehouseId, productId])
}

// Local Warung Inventory
model WarungProduct {
  id        String  @id @default(uuid())
  warungId  String
  warung    Warung  @relation(fields: [warungId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])

  sellingPrice Decimal @db.Decimal(10, 2)
  stockQty     Int     @default(0)
  minStock     Int     @default(5)

  saleItems SaleItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([warungId, productId])
}

model Order {
  id            String         @id @default(uuid())
  orderNumber   String         @unique
  warungId      String
  warung        Warung         @relation(fields: [warungId], references: [id])
  warehouseId   String
  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id])
  status        OrderStatus    @default(PENDING)
  totalAmount   Decimal        @db.Decimal(12, 2)
  paymentStatus PaymentStatus  @default(UNPAID)
  paymentMethod PaymentMethod?

  items        OrderItem[]
  deliveryTask DeliveryTask?
  createdBy    String
  creator      User          @relation("order_creator", fields: [createdBy], references: [id])

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(12, 2)
}

model Sale {
  id            String @id @default(uuid())
  invoiceNumber String @unique
  warungId      String
  warung        Warung @relation(fields: [warungId], references: [id])

  items         SaleItem[]
  totalAmount   Decimal       @db.Decimal(12, 2)
  paidAmount    Decimal       @default(0) @db.Decimal(12, 2)
  paymentMethod PaymentMethod

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SaleItem {
  id              String        @id @default(uuid())
  saleId          String
  sale            Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  warungProductId String
  warungProduct   WarungProduct @relation(fields: [warungProductId], references: [id])

  quantity Int
  price    Decimal @db.Decimal(10, 2)
  subtotal Decimal @db.Decimal(12, 2)
}

model DeliveryTask {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])
  kurirId String
  kurir   User   @relation("delivery_kurir", fields: [kurirId], references: [id])

  status        OrderStatus @default(PENDING)
  pickupPhoto   String?
  deliveryPhoto String?
  signature     String?

  assignedAt  DateTime  @default(now())
  pickedUpAt  DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model StockMovement {
  id           String       @id @default(uuid())
  movementType MovementType
  productId    String
  product      Product      @relation(fields: [productId], references: [id])
  quantity     Int

  // Could be from central or warung inventory
  referenceType String? // "ORDER", "SALE", "ADJUSTMENT"
  referenceId   String?

  createdBy String
  user      User     @relation(fields: [createdBy], references: [id])
  createdAt DateTime @default(now())
}

model StockOpname {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  systemQty   Int
  actualQty   Int
  difference  Int
  reason      String
  performedBy String
  user        User     @relation("stock_opname_user", fields: [performedBy], references: [id])
  createdAt   DateTime @default(now())
}
