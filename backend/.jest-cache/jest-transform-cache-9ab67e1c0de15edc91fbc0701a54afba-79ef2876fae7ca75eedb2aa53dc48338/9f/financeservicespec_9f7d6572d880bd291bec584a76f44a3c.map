{"file":"/Users/macm4/Documents/Projek/BUMASansor/backend/src/finance/finance.service.spec.ts","mappings":";;AAAA,2CAAwE;AACxE,uDAAmD;AAEnD,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;IAC9B,IAAI,OAAuB,CAAC;IAC5B,IAAI,MAAW,CAAC;IAChB,IAAI,QAAa,CAAC;IAElB,UAAU,CAAC,GAAG,EAAE;QACd,MAAM,GAAG;YACP,UAAU,EAAE;gBACV,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;gBACpB,QAAQ,EAAE,IAAI,CAAC,EAAE,EAAE;gBACnB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;gBACjB,UAAU,EAAE,IAAI,CAAC,EAAE,EAAE;gBACrB,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;gBACpB,KAAK,EAAE,IAAI,CAAC,EAAE,EAAE;aACjB;YACD,OAAO,EAAE;gBACP,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;gBACjB,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;aACrB;YACD,MAAM,EAAE;gBACN,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;gBACpB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;gBACjB,UAAU,EAAE,IAAI,CAAC,EAAE,EAAE;aACtB;YACD,YAAY,EAAE,IAAI,CAAC,EAAE,EAAE;SACxB,CAAC;QAEF,MAAM,CAAC,YAAY,CAAC,kBAAkB,CAAC,KAAK,EAAE,GAAQ,EAAE,EAAE;YACxD,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;gBACvB,OAAO,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAC1B,CAAC;YACD,OAAO,GAAG,CAAC,MAAM,CAAC,CAAC;QACrB,CAAC,CAAC,CAAC;QAEH,QAAQ,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,CAAC;QAC/B,OAAO,GAAG,IAAI,gCAAc,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;IACjD,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;QAC7B,EAAE,CAAC,oDAAoD,EAAE,KAAK,IAAI,EAAE;YAClE,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;YAEpD,MAAM,MAAM,CACV,OAAO,CAAC,aAAa,CAAC,SAAS,EAAE;gBAC/B,YAAY,EAAE,OAAO;gBACrB,MAAM,EAAE,GAAG;gBACX,MAAM,EAAE,MAAM;aACR,CAAC,CACV,CAAC,OAAO,CAAC,cAAc,CAAC,0BAAiB,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACtE,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC;gBAC5C,EAAE,EAAE,OAAO;gBACX,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,GAAG;gBACZ,UAAU,EAAE,CAAC;gBACb,OAAO,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;gBAC/B,MAAM,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE;aACtB,CAAC,CAAC;YAEH,MAAM,MAAM,CACV,OAAO,CAAC,aAAa,CAAC,SAAS,EAAE;gBAC/B,YAAY,EAAE,OAAO;gBACrB,MAAM,EAAE,GAAG;gBACX,MAAM,EAAE,UAAU;aACZ,CAAC,CACV,CAAC,OAAO,CAAC,cAAc,CAAC,4BAAmB,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE;YAC7D,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC;gBAC5C,EAAE,EAAE,OAAO;gBACX,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,GAAG;gBACZ,UAAU,EAAE,CAAC;gBACb,OAAO,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;gBAC/B,MAAM,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE;aACtB,CAAC,CAAC;YAEH,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,iBAAiB,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YACzD,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,iBAAiB,CAAC;gBACzC,EAAE,EAAE,OAAO;gBACX,OAAO,EAAE,CAAC;gBACV,UAAU,EAAE,GAAG;gBACf,MAAM,EAAE,MAAM;aACf,CAAC,CAAC;YACH,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,iBAAiB,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;YAEtD,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAC;YACjD,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,iBAAiB,CAAC,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC;YAEzD,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,aAAa,CAAC,SAAS,EAAE;gBACpD,YAAY,EAAE,OAAO;gBACrB,MAAM,EAAE,GAAG;gBACX,MAAM,EAAE,UAAU;aACZ,CAAC,CAAC;YAEV,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,oBAAoB,CAChD,MAAM,CAAC,gBAAgB,CAAC;gBACtB,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC;oBAC5B,YAAY,EAAE,OAAO;oBACrB,MAAM,EAAE,GAAG;oBACX,MAAM,EAAE,UAAU;oBAClB,UAAU,EAAE,SAAS;iBACtB,CAAC;aACH,CAAC,CACH,CAAC;YAEF,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,oBAAoB,CAC/C,MAAM,CAAC,gBAAgB,CAAC;gBACtB,KAAK,EAAE,EAAE,EAAE,EAAE,KAAK,EAAE;gBACpB,IAAI,EAAE,EAAE,WAAW,EAAE,EAAE,SAAS,EAAE,GAAG,EAAE,EAAE;aAC1C,CAAC,CACH,CAAC;YAEF,MAAM,CAAC,MAAM,CAAC,CAAC,cAAc,CAAC,SAAS,CAAC,CAAC;YACzC,MAAM,CAAC,MAAM,CAAC,CAAC,cAAc,CAAC,YAAY,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/Users/macm4/Documents/Projek/BUMASansor/backend/src/finance/finance.service.spec.ts"],"sourcesContent":["import { BadRequestException, NotFoundException } from '@nestjs/common';\nimport { FinanceService } from './finance.service';\n\ndescribe('FinanceService', () => {\n  let service: FinanceService;\n  let prisma: any;\n  let realtime: any;\n\n  beforeEach(() => {\n    prisma = {\n      receivable: {\n        findFirst: jest.fn(),\n        findMany: jest.fn(),\n        update: jest.fn(),\n        updateMany: jest.fn(),\n        aggregate: jest.fn(),\n        count: jest.fn(),\n      },\n      payment: {\n        create: jest.fn(),\n        aggregate: jest.fn(),\n      },\n      warung: {\n        findFirst: jest.fn(),\n        update: jest.fn(),\n        updateMany: jest.fn(),\n      },\n      $transaction: jest.fn(),\n    };\n\n    prisma.$transaction.mockImplementation(async (arg: any) => {\n      if (Array.isArray(arg)) {\n        return Promise.all(arg);\n      }\n      return arg(prisma);\n    });\n\n    realtime = { emit: jest.fn() };\n    service = new FinanceService(prisma, realtime);\n  });\n\n  describe('createPayment', () => {\n    it('throws NotFoundException when receivable not found', async () => {\n      prisma.receivable.findFirst.mockResolvedValue(null);\n\n      await expect(\n        service.createPayment('admin-1', {\n          receivableId: 'rec-1',\n          amount: 100,\n          method: 'CASH',\n        } as any),\n      ).rejects.toBeInstanceOf(NotFoundException);\n    });\n\n    it('throws BadRequestException when amount exceeds balance', async () => {\n      prisma.receivable.findFirst.mockResolvedValue({\n        id: 'rec-1',\n        warungId: 'w-1',\n        balance: 100,\n        paidAmount: 0,\n        dueDate: new Date('2026-01-01'),\n        warung: { id: 'w-1' },\n      });\n\n      await expect(\n        service.createPayment('admin-1', {\n          receivableId: 'rec-1',\n          amount: 200,\n          method: 'TRANSFER',\n        } as any),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n\n    it('updates receivable and warung debt on success', async () => {\n      prisma.receivable.findFirst.mockResolvedValue({\n        id: 'rec-1',\n        warungId: 'w-1',\n        balance: 100,\n        paidAmount: 0,\n        dueDate: new Date('2026-01-01'),\n        warung: { id: 'w-1' },\n      });\n\n      prisma.payment.create.mockResolvedValue({ id: 'pay-1' });\n      prisma.receivable.update.mockResolvedValue({\n        id: 'rec-1',\n        balance: 0,\n        paidAmount: 100,\n        status: 'PAID',\n      });\n      prisma.warung.update.mockResolvedValue({ id: 'w-1' });\n\n      prisma.receivable.findMany.mockResolvedValue([]);\n      prisma.warung.updateMany.mockResolvedValue({ count: 0 });\n\n      const result = await service.createPayment('admin-1', {\n        receivableId: 'rec-1',\n        amount: 100,\n        method: 'TRANSFER',\n      } as any);\n\n      expect(prisma.payment.create).toHaveBeenCalledWith(\n        expect.objectContaining({\n          data: expect.objectContaining({\n            receivableId: 'rec-1',\n            amount: 100,\n            method: 'TRANSFER',\n            verifiedBy: 'admin-1',\n          }),\n        }),\n      );\n\n      expect(prisma.warung.update).toHaveBeenCalledWith(\n        expect.objectContaining({\n          where: { id: 'w-1' },\n          data: { currentDebt: { decrement: 100 } },\n        }),\n      );\n\n      expect(result).toHaveProperty('payment');\n      expect(result).toHaveProperty('receivable');\n    });\n  });\n});\n"],"version":3}