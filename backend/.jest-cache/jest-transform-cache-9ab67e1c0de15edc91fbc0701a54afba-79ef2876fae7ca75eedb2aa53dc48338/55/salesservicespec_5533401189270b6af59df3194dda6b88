314b80b58a4e3387ead81f578f5ddcd2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const sales_service_1 = require("./sales.service");
describe('SalesService', () => {
    let service;
    let prisma;
    let realtime;
    beforeEach(() => {
        prisma = {
            warung: {
                findFirst: jest.fn(),
                update: jest.fn(),
            },
            warehouse: {
                findFirst: jest.fn(),
            },
            product: {
                findMany: jest.fn(),
            },
            stock: {
                findUnique: jest.fn(),
                update: jest.fn(),
            },
            stockMovement: {
                create: jest.fn(),
            },
            sale: {
                create: jest.fn(),
                count: jest.fn(),
            },
            receivable: {
                create: jest.fn(),
            },
            $transaction: jest.fn(),
        };
        prisma.$transaction.mockImplementation(async (cb) => cb(prisma));
        realtime = { emit: jest.fn() };
        service = new sales_service_1.SalesService(prisma, realtime);
    });
    describe('create', () => {
        it('throws when warung is blocked', async () => {
            prisma.warung.findFirst.mockResolvedValue({
                id: 'w-1',
                isBlocked: true,
                blockedReason: 'overdue',
            });
            await expect(service.create('u-1', {
                warungId: 'w-1',
                warehouseId: 'wh-1',
                paymentMethod: 'CASH',
                items: [{ productId: 'p-1', quantity: 1 }],
            })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
        it('throws when paidAmount > totalAmount', async () => {
            prisma.warung.findFirst.mockResolvedValue({ id: 'w-1', isBlocked: false, creditDays: 14 });
            prisma.warehouse.findFirst.mockResolvedValue({ id: 'wh-1' });
            prisma.product.findMany.mockResolvedValue([{ id: 'p-1', sellPrice: 100, deletedAt: null }]);
            await expect(service.create('u-1', {
                warungId: 'w-1',
                warehouseId: 'wh-1',
                paymentMethod: 'CASH',
                paidAmount: 999,
                items: [{ productId: 'p-1', quantity: 1 }],
            })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
        it('throws when stock insufficient', async () => {
            prisma.warung.findFirst.mockResolvedValue({ id: 'w-1', isBlocked: false, creditDays: 14 });
            prisma.warehouse.findFirst.mockResolvedValue({ id: 'wh-1' });
            prisma.product.findMany.mockResolvedValue([{ id: 'p-1', sellPrice: 100, deletedAt: null }]);
            prisma.stock.findUnique.mockResolvedValue({ quantity: 0 });
            await expect(service.create('u-1', {
                warungId: 'w-1',
                warehouseId: 'wh-1',
                paymentMethod: 'CASH',
                items: [{ productId: 'p-1', quantity: 1 }],
            })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY200L0RvY3VtZW50cy9Qcm9qZWsvQlVNQVNhbnNvci9iYWNrZW5kL3NyYy9zYWxlcy9zYWxlcy5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBcUQ7QUFDckQsbURBQStDO0FBRS9DLFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO0lBQzVCLElBQUksT0FBcUIsQ0FBQztJQUMxQixJQUFJLE1BQVcsQ0FBQztJQUNoQixJQUFJLFFBQWEsQ0FBQztJQUVsQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsTUFBTSxHQUFHO1lBQ1AsTUFBTSxFQUFFO2dCQUNOLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNwQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNsQjtZQUNELFNBQVMsRUFBRTtnQkFDVCxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNyQjtZQUNELE9BQU8sRUFBRTtnQkFDUCxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNwQjtZQUNELEtBQUssRUFBRTtnQkFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDbEI7WUFDRCxhQUFhLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDbEI7WUFDRCxJQUFJLEVBQUU7Z0JBQ0osTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ2pCO1lBQ0QsVUFBVSxFQUFFO2dCQUNWLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ2xCO1lBQ0QsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDeEIsQ0FBQztRQUVGLE1BQU0sQ0FBQyxZQUFZLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLEVBQU8sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFFdEUsUUFBUSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQy9CLE9BQU8sR0FBRyxJQUFJLDRCQUFZLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7UUFDdEIsRUFBRSxDQUFDLCtCQUErQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzdDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDO2dCQUN4QyxFQUFFLEVBQUUsS0FBSztnQkFDVCxTQUFTLEVBQUUsSUFBSTtnQkFDZixhQUFhLEVBQUUsU0FBUzthQUN6QixDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sQ0FDVixPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRTtnQkFDcEIsUUFBUSxFQUFFLEtBQUs7Z0JBQ2YsV0FBVyxFQUFFLE1BQU07Z0JBQ25CLGFBQWEsRUFBRSxNQUFNO2dCQUNyQixLQUFLLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDO2FBQ3BDLENBQUMsQ0FDVixDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsNEJBQW1CLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNwRCxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMzRixNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQzdELE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUU1RixNQUFNLE1BQU0sQ0FDVixPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRTtnQkFDcEIsUUFBUSxFQUFFLEtBQUs7Z0JBQ2YsV0FBVyxFQUFFLE1BQU07Z0JBQ25CLGFBQWEsRUFBRSxNQUFNO2dCQUNyQixVQUFVLEVBQUUsR0FBRztnQkFDZixLQUFLLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDO2FBQ3BDLENBQUMsQ0FDVixDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsNEJBQW1CLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM5QyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMzRixNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQzdELE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUU1RixNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRTNELE1BQU0sTUFBTSxDQUNWLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFO2dCQUNwQixRQUFRLEVBQUUsS0FBSztnQkFDZixXQUFXLEVBQUUsTUFBTTtnQkFDbkIsYUFBYSxFQUFFLE1BQU07Z0JBQ3JCLEtBQUssRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUM7YUFDcEMsQ0FBQyxDQUNWLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyw0QkFBbUIsQ0FBQyxDQUFDO1FBQ2hELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWFjbTQvRG9jdW1lbnRzL1Byb2play9CVU1BU2Fuc29yL2JhY2tlbmQvc3JjL3NhbGVzL3NhbGVzLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgU2FsZXNTZXJ2aWNlIH0gZnJvbSAnLi9zYWxlcy5zZXJ2aWNlJztcblxuZGVzY3JpYmUoJ1NhbGVzU2VydmljZScsICgpID0+IHtcbiAgbGV0IHNlcnZpY2U6IFNhbGVzU2VydmljZTtcbiAgbGV0IHByaXNtYTogYW55O1xuICBsZXQgcmVhbHRpbWU6IGFueTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBwcmlzbWEgPSB7XG4gICAgICB3YXJ1bmc6IHtcbiAgICAgICAgZmluZEZpcnN0OiBqZXN0LmZuKCksXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHdhcmVob3VzZToge1xuICAgICAgICBmaW5kRmlyc3Q6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICBwcm9kdWN0OiB7XG4gICAgICAgIGZpbmRNYW55OiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgc3RvY2s6IHtcbiAgICAgICAgZmluZFVuaXF1ZTogamVzdC5mbigpLFxuICAgICAgICB1cGRhdGU6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICBzdG9ja01vdmVtZW50OiB7XG4gICAgICAgIGNyZWF0ZTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHNhbGU6IHtcbiAgICAgICAgY3JlYXRlOiBqZXN0LmZuKCksXG4gICAgICAgIGNvdW50OiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgcmVjZWl2YWJsZToge1xuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICAkdHJhbnNhY3Rpb246IGplc3QuZm4oKSxcbiAgICB9O1xuXG4gICAgcHJpc21hLiR0cmFuc2FjdGlvbi5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGNiOiBhbnkpID0+IGNiKHByaXNtYSkpO1xuXG4gICAgcmVhbHRpbWUgPSB7IGVtaXQ6IGplc3QuZm4oKSB9O1xuICAgIHNlcnZpY2UgPSBuZXcgU2FsZXNTZXJ2aWNlKHByaXNtYSwgcmVhbHRpbWUpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlJywgKCkgPT4ge1xuICAgIGl0KCd0aHJvd3Mgd2hlbiB3YXJ1bmcgaXMgYmxvY2tlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHByaXNtYS53YXJ1bmcuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgaWQ6ICd3LTEnLFxuICAgICAgICBpc0Jsb2NrZWQ6IHRydWUsXG4gICAgICAgIGJsb2NrZWRSZWFzb246ICdvdmVyZHVlJyxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIHNlcnZpY2UuY3JlYXRlKCd1LTEnLCB7XG4gICAgICAgICAgd2FydW5nSWQ6ICd3LTEnLFxuICAgICAgICAgIHdhcmVob3VzZUlkOiAnd2gtMScsXG4gICAgICAgICAgcGF5bWVudE1ldGhvZDogJ0NBU0gnLFxuICAgICAgICAgIGl0ZW1zOiBbeyBwcm9kdWN0SWQ6ICdwLTEnLCBxdWFudGl0eTogMSB9XSxcbiAgICAgICAgfSBhcyBhbnkpLFxuICAgICAgKS5yZWplY3RzLnRvQmVJbnN0YW5jZU9mKEJhZFJlcXVlc3RFeGNlcHRpb24pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Rocm93cyB3aGVuIHBhaWRBbW91bnQgPiB0b3RhbEFtb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHByaXNtYS53YXJ1bmcuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICd3LTEnLCBpc0Jsb2NrZWQ6IGZhbHNlLCBjcmVkaXREYXlzOiAxNCB9KTtcbiAgICAgIHByaXNtYS53YXJlaG91c2UuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICd3aC0xJyB9KTtcbiAgICAgIHByaXNtYS5wcm9kdWN0LmZpbmRNYW55Lm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAncC0xJywgc2VsbFByaWNlOiAxMDAsIGRlbGV0ZWRBdDogbnVsbCB9XSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgc2VydmljZS5jcmVhdGUoJ3UtMScsIHtcbiAgICAgICAgICB3YXJ1bmdJZDogJ3ctMScsXG4gICAgICAgICAgd2FyZWhvdXNlSWQ6ICd3aC0xJyxcbiAgICAgICAgICBwYXltZW50TWV0aG9kOiAnQ0FTSCcsXG4gICAgICAgICAgcGFpZEFtb3VudDogOTk5LFxuICAgICAgICAgIGl0ZW1zOiBbeyBwcm9kdWN0SWQ6ICdwLTEnLCBxdWFudGl0eTogMSB9XSxcbiAgICAgICAgfSBhcyBhbnkpLFxuICAgICAgKS5yZWplY3RzLnRvQmVJbnN0YW5jZU9mKEJhZFJlcXVlc3RFeGNlcHRpb24pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Rocm93cyB3aGVuIHN0b2NrIGluc3VmZmljaWVudCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHByaXNtYS53YXJ1bmcuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICd3LTEnLCBpc0Jsb2NrZWQ6IGZhbHNlLCBjcmVkaXREYXlzOiAxNCB9KTtcbiAgICAgIHByaXNtYS53YXJlaG91c2UuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICd3aC0xJyB9KTtcbiAgICAgIHByaXNtYS5wcm9kdWN0LmZpbmRNYW55Lm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAncC0xJywgc2VsbFByaWNlOiAxMDAsIGRlbGV0ZWRBdDogbnVsbCB9XSk7XG5cbiAgICAgIHByaXNtYS5zdG9jay5maW5kVW5pcXVlLm1vY2tSZXNvbHZlZFZhbHVlKHsgcXVhbnRpdHk6IDAgfSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgc2VydmljZS5jcmVhdGUoJ3UtMScsIHtcbiAgICAgICAgICB3YXJ1bmdJZDogJ3ctMScsXG4gICAgICAgICAgd2FyZWhvdXNlSWQ6ICd3aC0xJyxcbiAgICAgICAgICBwYXltZW50TWV0aG9kOiAnQ0FTSCcsXG4gICAgICAgICAgaXRlbXM6IFt7IHByb2R1Y3RJZDogJ3AtMScsIHF1YW50aXR5OiAxIH1dLFxuICAgICAgICB9IGFzIGFueSksXG4gICAgICApLnJlamVjdHMudG9CZUluc3RhbmNlT2YoQmFkUmVxdWVzdEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=