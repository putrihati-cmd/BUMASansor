5790d310c072c2e3ec7a4d30d25cb25e
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const products_service_1 = require("./products.service");
describe('ProductsService', () => {
    let service;
    let prisma;
    beforeEach(() => {
        prisma = {
            product: {
                findMany: jest.fn(),
                count: jest.fn(),
                findFirst: jest.fn(),
                create: jest.fn(),
                update: jest.fn(),
            },
            category: {
                findFirst: jest.fn(),
            },
            $transaction: jest.fn(),
        };
        prisma.$transaction.mockImplementation(async (arr) => Promise.all(arr));
        service = new products_service_1.ProductsService(prisma);
    });
    describe('create', () => {
        it('throws when category not found', async () => {
            prisma.category.findFirst.mockResolvedValue(null);
            await expect(service.create({
                name: 'P',
                categoryId: 'cat-1',
                buyPrice: 100,
                sellPrice: 150,
                unit: 'pcs',
            })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
        it('calculates margin and uses provided barcode', async () => {
            prisma.category.findFirst.mockResolvedValue({ id: 'cat-1' });
            prisma.product.create.mockResolvedValue({ id: 'p-1' });
            await service.create({
                name: 'P',
                barcode: 'B-1',
                categoryId: 'cat-1',
                buyPrice: 100,
                sellPrice: 150,
                unit: 'pcs',
            });
            expect(prisma.product.create).toHaveBeenCalledWith(expect.objectContaining({
                data: expect.objectContaining({ barcode: 'B-1', margin: 50 }),
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY200L0RvY3VtZW50cy9Qcm9qZWsvQlVNQVNhbnNvci9iYWNrZW5kL3NyYy9wcm9kdWN0cy9wcm9kdWN0cy5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBcUQ7QUFDckQseURBQXFEO0FBRXJELFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxPQUF3QixDQUFDO0lBQzdCLElBQUksTUFBVyxDQUFDO0lBRWhCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxNQUFNLEdBQUc7WUFDUCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ25CLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNoQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDcEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2pCLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ2xCO1lBQ0QsUUFBUSxFQUFFO2dCQUNSLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ3JCO1lBQ0QsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDeEIsQ0FBQztRQUVGLE1BQU0sQ0FBQyxZQUFZLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLEdBQVUsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRS9FLE9BQU8sR0FBRyxJQUFJLGtDQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtRQUN0QixFQUFFLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDOUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFbEQsTUFBTSxNQUFNLENBQ1YsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDYixJQUFJLEVBQUUsR0FBRztnQkFDVCxVQUFVLEVBQUUsT0FBTztnQkFDbkIsUUFBUSxFQUFFLEdBQUc7Z0JBQ2IsU0FBUyxFQUFFLEdBQUc7Z0JBQ2QsSUFBSSxFQUFFLEtBQUs7YUFDTCxDQUFDLENBQ1YsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLDRCQUFtQixDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNkNBQTZDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDM0QsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUM3RCxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBRXZELE1BQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDbkIsSUFBSSxFQUFFLEdBQUc7Z0JBQ1QsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsVUFBVSxFQUFFLE9BQU87Z0JBQ25CLFFBQVEsRUFBRSxHQUFHO2dCQUNiLFNBQVMsRUFBRSxHQUFHO2dCQUNkLElBQUksRUFBRSxLQUFLO2FBQ0wsQ0FBQyxDQUFDO1lBRVYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQ2hELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDO2FBQzlELENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNtNC9Eb2N1bWVudHMvUHJvamVrL0JVTUFTYW5zb3IvYmFja2VuZC9zcmMvcHJvZHVjdHMvcHJvZHVjdHMuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQcm9kdWN0c1NlcnZpY2UgfSBmcm9tICcuL3Byb2R1Y3RzLnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnUHJvZHVjdHNTZXJ2aWNlJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogUHJvZHVjdHNTZXJ2aWNlO1xuICBsZXQgcHJpc21hOiBhbnk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgcHJpc21hID0ge1xuICAgICAgcHJvZHVjdDoge1xuICAgICAgICBmaW5kTWFueTogamVzdC5mbigpLFxuICAgICAgICBjb3VudDogamVzdC5mbigpLFxuICAgICAgICBmaW5kRmlyc3Q6IGplc3QuZm4oKSxcbiAgICAgICAgY3JlYXRlOiBqZXN0LmZuKCksXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIGNhdGVnb3J5OiB7XG4gICAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgICR0cmFuc2FjdGlvbjogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBwcmlzbWEuJHRyYW5zYWN0aW9uLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAoYXJyOiBhbnlbXSkgPT4gUHJvbWlzZS5hbGwoYXJyKSk7XG5cbiAgICBzZXJ2aWNlID0gbmV3IFByb2R1Y3RzU2VydmljZShwcmlzbWEpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlJywgKCkgPT4ge1xuICAgIGl0KCd0aHJvd3Mgd2hlbiBjYXRlZ29yeSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcmlzbWEuY2F0ZWdvcnkuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIHNlcnZpY2UuY3JlYXRlKHtcbiAgICAgICAgICBuYW1lOiAnUCcsXG4gICAgICAgICAgY2F0ZWdvcnlJZDogJ2NhdC0xJyxcbiAgICAgICAgICBidXlQcmljZTogMTAwLFxuICAgICAgICAgIHNlbGxQcmljZTogMTUwLFxuICAgICAgICAgIHVuaXQ6ICdwY3MnLFxuICAgICAgICB9IGFzIGFueSksXG4gICAgICApLnJlamVjdHMudG9CZUluc3RhbmNlT2YoQmFkUmVxdWVzdEV4Y2VwdGlvbik7XG4gICAgfSk7XG5cbiAgICBpdCgnY2FsY3VsYXRlcyBtYXJnaW4gYW5kIHVzZXMgcHJvdmlkZWQgYmFyY29kZScsIGFzeW5jICgpID0+IHtcbiAgICAgIHByaXNtYS5jYXRlZ29yeS5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUoeyBpZDogJ2NhdC0xJyB9KTtcbiAgICAgIHByaXNtYS5wcm9kdWN0LmNyZWF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IGlkOiAncC0xJyB9KTtcblxuICAgICAgYXdhaXQgc2VydmljZS5jcmVhdGUoe1xuICAgICAgICBuYW1lOiAnUCcsXG4gICAgICAgIGJhcmNvZGU6ICdCLTEnLFxuICAgICAgICBjYXRlZ29yeUlkOiAnY2F0LTEnLFxuICAgICAgICBidXlQcmljZTogMTAwLFxuICAgICAgICBzZWxsUHJpY2U6IDE1MCxcbiAgICAgICAgdW5pdDogJ3BjcycsXG4gICAgICB9IGFzIGFueSk7XG5cbiAgICAgIGV4cGVjdChwcmlzbWEucHJvZHVjdC5jcmVhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZGF0YTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoeyBiYXJjb2RlOiAnQi0xJywgbWFyZ2luOiA1MCB9KSxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9