{"file":"/Users/macm4/Documents/Projek/BUMASansor/backend/src/distribution/distribution.service.spec.ts","mappings":";;AAAA,2CAAqD;AACrD,iEAA6D;AAE7D,QAAQ,CAAC,qBAAqB,EAAE,GAAG,EAAE;IACnC,IAAI,OAA4B,CAAC;IACjC,IAAI,MAAW,CAAC;IAChB,IAAI,QAAa,CAAC;IAElB,UAAU,CAAC,GAAG,EAAE;QACd,MAAM,GAAG;YACP,MAAM,EAAE;gBACN,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;gBACpB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;aAClB;YACD,SAAS,EAAE;gBACT,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;aACrB;YACD,OAAO,EAAE;gBACP,QAAQ,EAAE,IAAI,CAAC,EAAE,EAAE;gBACnB,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;aACrB;YACD,aAAa,EAAE;gBACb,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;gBACjB,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;gBACpB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;gBACjB,KAAK,EAAE,IAAI,CAAC,EAAE,EAAE;aACjB;YACD,UAAU,EAAE;gBACV,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;gBACpB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;aAClB;YACD,KAAK,EAAE;gBACL,UAAU,EAAE,IAAI,CAAC,EAAE,EAAE;gBACrB,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;aAClB;YACD,aAAa,EAAE;gBACb,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE;aAClB;YACD,IAAI,EAAE;gBACJ,SAAS,EAAE,IAAI,CAAC,EAAE,EAAE;aACrB;YACD,aAAa,EAAE;gBACb,KAAK,EAAE,IAAI,CAAC,EAAE,EAAE;aACjB;YACD,YAAY,EAAE,IAAI,CAAC,EAAE,EAAE;SACxB,CAAC;QAEF,MAAM,CAAC,YAAY,CAAC,kBAAkB,CAAC,KAAK,EAAE,GAAQ,EAAE,EAAE;YACxD,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;gBACvB,OAAO,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAC1B,CAAC;YACD,OAAO,GAAG,CAAC,MAAM,CAAC,CAAC;QACrB,CAAC,CAAC,CAAC;QAEH,QAAQ,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,CAAC;QAC/B,OAAO,GAAG,IAAI,0CAAmB,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;IACtD,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,qBAAqB,EAAE,GAAG,EAAE;QACnC,EAAE,CAAC,+BAA+B,EAAE,KAAK,IAAI,EAAE;YAC7C,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,iBAAiB,CAAC;gBACxC,EAAE,EAAE,KAAK;gBACT,SAAS,EAAE,IAAI;gBACf,aAAa,EAAE,SAAS;gBACxB,WAAW,EAAE,IAAI;gBACjB,WAAW,EAAE,CAAC;gBACd,UAAU,EAAE,EAAE;aACf,CAAC,CAAC;YAEH,MAAM,MAAM,CACV,OAAO,CAAC,mBAAmB,CAAC,SAAS,EAAE;gBACrC,QAAQ,EAAE,KAAK;gBACf,WAAW,EAAE,MAAM;gBACnB,KAAK,EAAE,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC;aAC/C,CAAC,CACV,CAAC,OAAO,CAAC,cAAc,CAAC,4BAAmB,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,mCAAmC,EAAE,KAAK,IAAI,EAAE;YACjD,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,iBAAiB,CAAC;gBACxC,EAAE,EAAE,KAAK;gBACT,SAAS,EAAE,KAAK;gBAChB,WAAW,EAAE,GAAG;gBAChB,WAAW,EAAE,EAAE;gBACf,UAAU,EAAE,EAAE;aACf,CAAC,CAAC;YACH,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,iBAAiB,CAAC,EAAE,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;YAC7D,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,iBAAiB,CAAC,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC;YAE3D,MAAM,MAAM,CACV,OAAO,CAAC,mBAAmB,CAAC,SAAS,EAAE;gBACrC,QAAQ,EAAE,KAAK;gBACf,WAAW,EAAE,MAAM;gBACnB,KAAK,EAAE,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC;aAC/C,CAAC,CACV,CAAC,OAAO,CAAC,cAAc,CAAC,4BAAmB,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;QAC/B,EAAE,CAAC,mDAAmD,EAAE,KAAK,IAAI,EAAE;YACjE,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC,iBAAiB,CAAC;gBAC/C,EAAE,EAAE,MAAM;gBACV,MAAM,EAAE,WAAW;gBACnB,WAAW,EAAE,MAAM;gBACnB,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;gBAC/B,WAAW,EAAE,GAAG;gBAChB,QAAQ,EAAE,MAAM;gBAChB,KAAK,EAAE,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,EAAE,CAAC;aAC3C,CAAC,CAAC;YACH,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC;YAE/D,MAAM,MAAM,CACV,OAAO,CAAC,eAAe,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,UAAU,EAAE,GAAG,EAAS,CAAC,CACvE,CAAC,OAAO,CAAC,cAAc,CAAC,4BAAmB,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,gCAAgC,EAAE,KAAK,IAAI,EAAE;YAC9C,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC,iBAAiB,CAAC;gBAC/C,EAAE,EAAE,MAAM;gBACV,MAAM,EAAE,WAAW;gBACnB,WAAW,EAAE,MAAM;gBACnB,QAAQ,EAAE,KAAK;gBACf,OAAO,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;gBAC/B,WAAW,EAAE,GAAG;gBAChB,QAAQ,EAAE,MAAM;gBAChB,KAAK,EAAE,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,QAAQ,EAAE,CAAC,EAAE,CAAC;aAC3C,CAAC,CAAC;YACH,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;YAEpD,MAAM,CAAC,KAAK,CAAC,UAAU,CAAC,iBAAiB,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,CAAC,CAAC;YAE3D,MAAM,MAAM,CACV,OAAO,CAAC,eAAe,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,UAAU,EAAE,GAAG,EAAS,CAAC,CACvE,CAAC,OAAO,CAAC,cAAc,CAAC,4BAAmB,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,aAAa,EAAE,GAAG,EAAE;QAC3B,EAAE,CAAC,6BAA6B,EAAE,KAAK,IAAI,EAAE;YAC3C,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC,iBAAiB,CAAC,EAAE,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;YACpF,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;YAE9C,MAAM,MAAM,CAAC,OAAO,CAAC,WAAW,CAAC,MAAM,EAAE,EAAE,OAAO,EAAE,KAAK,EAAS,CAAC,CAAC,CAAC,OAAO,CAAC,cAAc,CACzF,4BAAmB,CACpB,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/Users/macm4/Documents/Projek/BUMASansor/backend/src/distribution/distribution.service.spec.ts"],"sourcesContent":["import { BadRequestException } from '@nestjs/common';\nimport { DistributionService } from './distribution.service';\n\ndescribe('DistributionService', () => {\n  let service: DistributionService;\n  let prisma: any;\n  let realtime: any;\n\n  beforeEach(() => {\n    prisma = {\n      warung: {\n        findFirst: jest.fn(),\n        update: jest.fn(),\n      },\n      warehouse: {\n        findFirst: jest.fn(),\n      },\n      product: {\n        findMany: jest.fn(),\n        findFirst: jest.fn(),\n      },\n      deliveryOrder: {\n        create: jest.fn(),\n        findFirst: jest.fn(),\n        update: jest.fn(),\n        count: jest.fn(),\n      },\n      receivable: {\n        findFirst: jest.fn(),\n        create: jest.fn(),\n      },\n      stock: {\n        findUnique: jest.fn(),\n        update: jest.fn(),\n      },\n      stockMovement: {\n        create: jest.fn(),\n      },\n      user: {\n        findFirst: jest.fn(),\n      },\n      purchaseOrder: {\n        count: jest.fn(),\n      },\n      $transaction: jest.fn(),\n    };\n\n    prisma.$transaction.mockImplementation(async (arg: any) => {\n      if (Array.isArray(arg)) {\n        return Promise.all(arg);\n      }\n      return arg(prisma);\n    });\n\n    realtime = { emit: jest.fn() };\n    service = new DistributionService(prisma, realtime);\n  });\n\n  describe('createDeliveryOrder', () => {\n    it('throws when warung is blocked', async () => {\n      prisma.warung.findFirst.mockResolvedValue({\n        id: 'w-1',\n        isBlocked: true,\n        blockedReason: 'overdue',\n        creditLimit: 1000,\n        currentDebt: 0,\n        creditDays: 14,\n      });\n\n      await expect(\n        service.createDeliveryOrder('admin-1', {\n          warungId: 'w-1',\n          warehouseId: 'wh-1',\n          items: [{ productId: 'p-1', quantity: 1, price: 10 }],\n        } as any),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n\n    it('throws when credit limit exceeded', async () => {\n      prisma.warung.findFirst.mockResolvedValue({\n        id: 'w-1',\n        isBlocked: false,\n        creditLimit: 100,\n        currentDebt: 90,\n        creditDays: 14,\n      });\n      prisma.warehouse.findFirst.mockResolvedValue({ id: 'wh-1' });\n      prisma.product.findMany.mockResolvedValue([{ id: 'p-1' }]);\n\n      await expect(\n        service.createDeliveryOrder('admin-1', {\n          warungId: 'w-1',\n          warehouseId: 'wh-1',\n          items: [{ productId: 'p-1', quantity: 2, price: 10 }],\n        } as any),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n  });\n\n  describe('confirmDelivery', () => {\n    it('throws when already confirmed (receivable exists)', async () => {\n      prisma.deliveryOrder.findFirst.mockResolvedValue({\n        id: 'do-1',\n        status: 'DELIVERED',\n        warehouseId: 'wh-1',\n        warungId: 'w-1',\n        dueDate: new Date('2026-01-01'),\n        totalAmount: 100,\n        doNumber: 'DO-1',\n        items: [{ productId: 'p-1', quantity: 1 }],\n      });\n      prisma.receivable.findFirst.mockResolvedValue({ id: 'rec-1' });\n\n      await expect(\n        service.confirmDelivery('do-1', 'admin-1', { photoProof: 'x' } as any),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n\n    it('throws when stock insufficient', async () => {\n      prisma.deliveryOrder.findFirst.mockResolvedValue({\n        id: 'do-1',\n        status: 'DELIVERED',\n        warehouseId: 'wh-1',\n        warungId: 'w-1',\n        dueDate: new Date('2026-01-01'),\n        totalAmount: 100,\n        doNumber: 'DO-1',\n        items: [{ productId: 'p-1', quantity: 5 }],\n      });\n      prisma.receivable.findFirst.mockResolvedValue(null);\n\n      prisma.stock.findUnique.mockResolvedValue({ quantity: 1 });\n\n      await expect(\n        service.confirmDelivery('do-1', 'admin-1', { photoProof: 'x' } as any),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n  });\n\n  describe('assignKurir', () => {\n    it('throws when kurir not found', async () => {\n      prisma.deliveryOrder.findFirst.mockResolvedValue({ id: 'do-1', status: 'PENDING' });\n      prisma.user.findFirst.mockResolvedValue(null);\n\n      await expect(service.assignKurir('do-1', { kurirId: 'k-1' } as any)).rejects.toBeInstanceOf(\n        BadRequestException,\n      );\n    });\n  });\n});\n"],"version":3}