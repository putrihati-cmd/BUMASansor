1b2b37787cc8ac8f6407474c226645d4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const distribution_service_1 = require("./distribution.service");
describe('DistributionService', () => {
    let service;
    let prisma;
    let realtime;
    beforeEach(() => {
        prisma = {
            warung: {
                findFirst: jest.fn(),
                update: jest.fn(),
            },
            warehouse: {
                findFirst: jest.fn(),
            },
            product: {
                findMany: jest.fn(),
                findFirst: jest.fn(),
            },
            deliveryOrder: {
                create: jest.fn(),
                findFirst: jest.fn(),
                update: jest.fn(),
                count: jest.fn(),
            },
            receivable: {
                findFirst: jest.fn(),
                create: jest.fn(),
            },
            stock: {
                findUnique: jest.fn(),
                update: jest.fn(),
            },
            stockMovement: {
                create: jest.fn(),
            },
            user: {
                findFirst: jest.fn(),
            },
            purchaseOrder: {
                count: jest.fn(),
            },
            $transaction: jest.fn(),
        };
        prisma.$transaction.mockImplementation(async (arg) => {
            if (Array.isArray(arg)) {
                return Promise.all(arg);
            }
            return arg(prisma);
        });
        realtime = { emit: jest.fn() };
        service = new distribution_service_1.DistributionService(prisma, realtime);
    });
    describe('createDeliveryOrder', () => {
        it('throws when warung is blocked', async () => {
            prisma.warung.findFirst.mockResolvedValue({
                id: 'w-1',
                isBlocked: true,
                blockedReason: 'overdue',
                creditLimit: 1000,
                currentDebt: 0,
                creditDays: 14,
            });
            await expect(service.createDeliveryOrder('admin-1', {
                warungId: 'w-1',
                warehouseId: 'wh-1',
                items: [{ productId: 'p-1', quantity: 1, price: 10 }],
            })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
        it('throws when credit limit exceeded', async () => {
            prisma.warung.findFirst.mockResolvedValue({
                id: 'w-1',
                isBlocked: false,
                creditLimit: 100,
                currentDebt: 90,
                creditDays: 14,
            });
            prisma.warehouse.findFirst.mockResolvedValue({ id: 'wh-1' });
            prisma.product.findMany.mockResolvedValue([{ id: 'p-1' }]);
            await expect(service.createDeliveryOrder('admin-1', {
                warungId: 'w-1',
                warehouseId: 'wh-1',
                items: [{ productId: 'p-1', quantity: 2, price: 10 }],
            })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
    });
    describe('confirmDelivery', () => {
        it('throws when already confirmed (receivable exists)', async () => {
            prisma.deliveryOrder.findFirst.mockResolvedValue({
                id: 'do-1',
                status: 'DELIVERED',
                warehouseId: 'wh-1',
                warungId: 'w-1',
                dueDate: new Date('2026-01-01'),
                totalAmount: 100,
                doNumber: 'DO-1',
                items: [{ productId: 'p-1', quantity: 1 }],
            });
            prisma.receivable.findFirst.mockResolvedValue({ id: 'rec-1' });
            await expect(service.confirmDelivery('do-1', 'admin-1', { photoProof: 'x' })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
        it('throws when stock insufficient', async () => {
            prisma.deliveryOrder.findFirst.mockResolvedValue({
                id: 'do-1',
                status: 'DELIVERED',
                warehouseId: 'wh-1',
                warungId: 'w-1',
                dueDate: new Date('2026-01-01'),
                totalAmount: 100,
                doNumber: 'DO-1',
                items: [{ productId: 'p-1', quantity: 5 }],
            });
            prisma.receivable.findFirst.mockResolvedValue(null);
            prisma.stock.findUnique.mockResolvedValue({ quantity: 1 });
            await expect(service.confirmDelivery('do-1', 'admin-1', { photoProof: 'x' })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
    });
    describe('assignKurir', () => {
        it('throws when kurir not found', async () => {
            prisma.deliveryOrder.findFirst.mockResolvedValue({ id: 'do-1', status: 'PENDING' });
            prisma.user.findFirst.mockResolvedValue(null);
            await expect(service.assignKurir('do-1', { kurirId: 'k-1' })).rejects.toBeInstanceOf(common_1.BadRequestException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY200L0RvY3VtZW50cy9Qcm9qZWsvQlVNQVNhbnNvci9iYWNrZW5kL3NyYy9kaXN0cmlidXRpb24vZGlzdHJpYnV0aW9uLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDJDQUFxRDtBQUNyRCxpRUFBNkQ7QUFFN0QsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtJQUNuQyxJQUFJLE9BQTRCLENBQUM7SUFDakMsSUFBSSxNQUFXLENBQUM7SUFDaEIsSUFBSSxRQUFhLENBQUM7SUFFbEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE1BQU0sR0FBRztZQUNQLE1BQU0sRUFBRTtnQkFDTixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDcEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDbEI7WUFDRCxTQUFTLEVBQUU7Z0JBQ1QsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDckI7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ25CLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ3JCO1lBQ0QsYUFBYSxFQUFFO2dCQUNiLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNqQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDcEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ2pCO1lBQ0QsVUFBVSxFQUFFO2dCQUNWLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNwQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNsQjtZQUNELEtBQUssRUFBRTtnQkFDTCxVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDbEI7WUFDRCxhQUFhLEVB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QUUsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUM7YUFDM0MsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFcEQsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUUzRCxNQUFNLE1BQU0sQ0FDVixPQUFPLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFTLENBQUMsQ0FDdkUsQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLDRCQUFtQixDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQzNCLEVBQUUsQ0FBQyw2QkFBNkIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUMzQyxNQUFNLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7WUFDcEYsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFOUMsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQ3pGLDRCQUFtQixDQUNwQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNtNC9Eb2N1bWVudHMvUHJvamVrL0JVTUFTYW5zb3IvYmFja2VuZC9zcmMvZGlzdHJpYnV0aW9uL2Rpc3RyaWJ1dGlvbi5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IERpc3RyaWJ1dGlvblNlcnZpY2UgfSBmcm9tICcuL2Rpc3RyaWJ1dGlvbi5zZXJ2aWNlJztcblxuZGVzY3JpYmUoJ0Rpc3RyaWJ1dGlvblNlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBEaXN0cmlidXRpb25TZXJ2aWNlO1xuICBsZXQgcHJpc21hOiBhbnk7XG4gIGxldCByZWFsdGltZTogYW55O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHByaXNtYSA9IHtcbiAgICAgIHdhcnVuZzoge1xuICAgICAgICBmaW5kRmlyc3Q6IGplc3QuZm4oKSxcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgd2FyZWhvdXNlOiB7XG4gICAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHByb2R1Y3Q6IHtcbiAgICAgICAgZmluZE1hbnk6IGplc3QuZm4oKSxcbiAgICAgICAgZmluZEZpcnN0OiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgZGVsaXZlcnlPcmRlcjoge1xuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgICAgICAgZmluZEZpcnN0OiBqZXN0LmZuKCksXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLFxuICAgICAgICBjb3VudDogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHJlY2VpdmFibGU6IHtcbiAgICAgICAgZmluZEZpcnN0OiBqZXN0LmZuKCksXG4gICAgICAgIGNyZWF0ZTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHN0b2NrOiB7XG4gICAgICAgIGZpbmRVbmlxdWU6IGplc3QuZm4oKSxcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgc3RvY2tNb3ZlbWVudDoge1xuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICB1c2VyOiB7XG4gICAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHB1cmNoYXNlT3JkZXI6IHtcbiAgICAgICAgY291bnQ6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICAkdHJhbnNhY3Rpb246IGplc3QuZm4oKSxcbiAgICB9O1xuXG4gICAgcHJpc21hLiR0cmFuc2FjdGlvbi5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGFyZzogYW55KSA9PiB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcpKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChhcmcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFyZyhwcmlzbWEpO1xuICAgIH0pO1xuXG4gICAgcmVhbHRpbWUgPSB7IGVtaXQ6IGplc3QuZm4oKSB9O1xuICAgIHNlcnZpY2UgPSBuZXcgRGlzdHJpYnV0aW9uU2VydmljZShwcmlzbWEsIHJlYWx0aW1lKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZURlbGl2ZXJ5T3JkZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Rocm93cyB3aGVuIHdhcnVuZyBpcyBibG9ja2VkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcHJpc21hLndhcnVuZy5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBpZDogJ3ctMScsXG4gICAgICAgIGlzQmxvY2tlZDogdHJ1ZSxcbiAgICAgICAgYmxvY2tlZFJlYXNvbjogJ292ZXJkdWUnLFxuICAgICAgICBjcmVkaXRMaW1pdDogMTAwMCxcbiAgICAgICAgY3VycmVudERlYnQ6IDAsXG4gICAgICAgIGNyZWRpdERheXM6IDE0LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgc2VydmljZS5jcmVhdGVEZWxpdmVyeU9yZGVyKCdhZG1pbi0xJywge1xuICAgICAgICAgIHdhcnVuZ0lkOiAndy0xJyxcbiAgICAgICAgICB3YXJlaG91c2VJZDogJ3doLTEnLFxuICAgICAgICAgIGl0ZW1zOiBbeyBwcm9kdWN0SWQ6ICdwLTEnLCBxdWFudGl0eTogMSwgcHJpY2U6IDEwIH1dLFxuICAgICAgICB9IGFzIGFueSksXG4gICAgICApLnJlamVjdHMudG9CZUluc3RhbmNlT2YoQmFkUmVxdWVzdEV4Y2VwdGlvbik7XG4gICAgfSk7XG5cbiAgICBpdCgndGhyb3dzIHdoZW4gY3JlZGl0IGxpbWl0IGV4Y2VlZGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcHJpc21hLndhcnVuZy5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBpZDogJ3ctMScsXG4gICAgICAgIGlzQmxvY2tlZDogZmFsc2UsXG4gICAgICAgIGNyZWRpdExpbWl0OiAxMDAsXG4gICAgICAgIGN1cnJlbnREZWJ0OiA5MCxcbiAgICAgICAgY3JlZGl0RGF5czogMTQsXG4gICAgICB9KTtcbiAgICAgIHByaXNtYS53YXJlaG91c2UuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICd3aC0xJyB9KTtcbiAgICAgIHByaXNtYS5wcm9kdWN0LmZpbmRNYW55Lm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAncC0xJyB9XSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgc2VydmljZS5jcmVhdGVEZWxpdmVyeU9yZGVyKCdhZG1pbi0xJywge1xuICAgICAgICAgIHdhcnVuZ0lkOiAndy0xJyxcbiAgICAgICAgICB3YXJlaG91c2VJZDogJ3doLTEnLFxuICAgICAgICAgIGl0ZW1zOiBbeyBwcm9kdWN0SWQ6ICdwLTEnLCBxdWFudGl0eTogMiwgcHJpY2U6IDEwIH1dLFxuICAgICAgICB9IGFzIGFueSksXG4gICAgICApLnJlamVjdHMudG9CZUluc3RhbmNlT2YoQmFkUmVxdWVzdEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjb25maXJtRGVsaXZlcnknLCAoKSA9PiB7XG4gICAgaXQoJ3Rocm93cyB3aGVuIGFscmVhZHkgY29uZmlybWVkIChyZWNlaXZhYmxlIGV4aXN0cyknLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcmlzbWEuZGVsaXZlcnlPcmRlci5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBpZDogJ2RvLTEnLFxuICAgICAgICBzdGF0dXM6ICdERUxJVkVSRUQnLFxuICAgICAgICB3YXJlaG91c2VJZDogJ3doLTEnLFxuICAgICAgICB3YXJ1bmdJZDogJ3ctMScsXG4gICAgICAgIGR1ZURhdGU6IG5ldyBEYXRlKCcyMDI2LTAxLTAxJyksXG4gICAgICAgIHRvdGFsQW1vdW50OiAxMDAsXG4gICAgICAgIGRvTnVtYmVyOiAnRE8tMScsXG4gICAgICAgIGl0ZW1zOiBbeyBwcm9kdWN0SWQ6ICdwLTEnLCBxdWFudGl0eTogMSB9XSxcbiAgICAgIH0pO1xuICAgICAgcHJpc21hLnJlY2VpdmFibGUuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICdyZWMtMScgfSk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChcbiAgICAgICAgc2VydmljZS5jb25maXJtRGVsaXZlcnkoJ2RvLTEnLCAnYWRtaW4tMScsIHsgcGhvdG9Qcm9vZjogJ3gnIH0gYXMgYW55KSxcbiAgICAgICkucmVqZWN0cy50b0JlSW5zdGFuY2VPZihCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcbiAgICB9KTtcblxuICAgIGl0KCd0aHJvd3Mgd2hlbiBzdG9jayBpbnN1ZmZpY2llbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcmlzbWEuZGVsaXZlcnlPcmRlci5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBpZDogJ2RvLTEnLFxuICAgICAgICBzdGF0dXM6ICdERUxJVkVSRUQnLFxuICAgICAgICB3YXJlaG91c2VJZDogJ3doLTEnLFxuICAgICAgICB3YXJ1bmdJZDogJ3ctMScsXG4gICAgICAgIGR1ZURhdGU6IG5ldyBEYXRlKCcyMDI2LTAxLTAxJyksXG4gICAgICAgIHRvdGFsQW1vdW50OiAxMDAsXG4gICAgICAgIGRvTnVtYmVyOiAnRE8tMScsXG4gICAgICAgIGl0ZW1zOiBbeyBwcm9kdWN0SWQ6ICdwLTEnLCBxdWFudGl0eTogNSB9XSxcbiAgICAgIH0pO1xuICAgICAgcHJpc21hLnJlY2VpdmFibGUuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICBwcmlzbWEuc3RvY2suZmluZFVuaXF1ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IHF1YW50aXR5OiAxIH0pO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIHNlcnZpY2UuY29uZmlybURlbGl2ZXJ5KCdkby0xJywgJ2FkbWluLTEnLCB7IHBob3RvUHJvb2Y6ICd4JyB9IGFzIGFueSksXG4gICAgICApLnJlamVjdHMudG9CZUluc3RhbmNlT2YoQmFkUmVxdWVzdEV4Y2VwdGlvbik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdhc3NpZ25LdXJpcicsICgpID0+IHtcbiAgICBpdCgndGhyb3dzIHdoZW4ga3VyaXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcHJpc21hLmRlbGl2ZXJ5T3JkZXIuZmluZEZpcnN0Lm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6ICdkby0xJywgc3RhdHVzOiAnUEVORElORycgfSk7XG4gICAgICBwcmlzbWEudXNlci5maW5kRmlyc3QubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG5cbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLmFzc2lnbkt1cmlyKCdkby0xJywgeyBrdXJpcklkOiAnay0xJyB9IGFzIGFueSkpLnJlamVjdHMudG9CZUluc3RhbmNlT2YoXG4gICAgICAgIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9