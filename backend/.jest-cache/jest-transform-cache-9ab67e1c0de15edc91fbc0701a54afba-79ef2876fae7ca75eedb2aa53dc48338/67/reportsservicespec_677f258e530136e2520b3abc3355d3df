273562dce47ceafd0a85454e9d259810
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const reports_service_1 = require("./reports.service");
describe('ReportsService', () => {
    let service;
    let prisma;
    beforeEach(() => {
        prisma = {
            sale: {
                aggregate: jest.fn(),
            },
            receivable: {
                aggregate: jest.fn(),
                findMany: jest.fn(),
            },
            warung: {
                count: jest.fn(),
                findMany: jest.fn(),
            },
            stock: {
                findMany: jest.fn(),
            },
            saleItem: {
                groupBy: jest.fn(),
                findMany: jest.fn(),
            },
            product: {
                findMany: jest.fn(),
            },
            payment: {
                aggregate: jest.fn(),
            },
            purchaseOrder: {
                aggregate: jest.fn(),
            },
        };
        service = new reports_service_1.ReportsService(prisma);
    });
    describe('dashboard', () => {
        it('returns expected dashboard shape', async () => {
            prisma.sale.aggregate.mockResolvedValue({
                _sum: { totalAmount: 1000, paidAmount: 800 },
                _count: 2,
            });
            prisma.receivable.aggregate.mockResolvedValue({ _sum: { balance: 200 } });
            prisma.warung.count.mockResolvedValueOnce(5).mockResolvedValueOnce(1);
            prisma.stock.findMany.mockResolvedValue([
                { quantity: 1, minStock: 10, product: { buyPrice: 100 } },
                { quantity: 20, minStock: 10, product: { buyPrice: 50 } },
            ]);
            prisma.saleItem.groupBy.mockResolvedValue([
                { productId: 'p-1', _sum: { quantity: 10, subtotal: 500 } },
            ]);
            prisma.product.findMany.mockResolvedValue([{ id: 'p-1', name: 'P1', barcode: 'B1' }]);
            prisma.saleItem.findMany.mockResolvedValue([
                { quantity: 2, price: 10, product: { buyPrice: 7 } },
            ]);
            prisma.payment.aggregate.mockResolvedValue({ _sum: { amount: 50 }, _count: 1 });
            prisma.purchaseOrder.aggregate.mockResolvedValue({ _sum: { totalAmount: 0 } });
            const result = await service.dashboard();
            expect(result).toHaveProperty('today');
            expect(result).toHaveProperty('receivables');
            expect(result).toHaveProperty('warungs');
            expect(result).toHaveProperty('stocks');
            expect(result).toHaveProperty('topProducts');
            expect(result.today.omzet).toBe(1000);
            expect(result.today.cashIn).toBe(800);
            expect(result.today.profitEstimate).toBe(6);
            expect(result.receivables.outstanding).toBe(200);
            expect(result.warungs.active).toBe(5);
            expect(result.warungs.blocked).toBe(1);
            expect(result.stocks.lowStockCount).toBe(1);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY200L0RvY3VtZW50cy9Qcm9qZWsvQlVNQVNhbnNvci9iYWNrZW5kL3NyYy9yZXBvcnRzL3JlcG9ydHMuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsdURBQW1EO0FBRW5ELFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxPQUF1QixDQUFDO0lBQzVCLElBQUksTUFBVyxDQUFDO0lBRWhCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxNQUFNLEdBQUc7WUFDUCxJQUFJLEVBQUU7Z0JBQ0osU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDckI7WUFDRCxVQUFVLEVBQUU7Z0JBQ1YsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ3BCLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQ3BCO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNoQixRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNwQjtZQUNELEtBQUssRUFBRTtnQkFDTCxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNwQjtZQUNELFFBQVEsRUFBRTtnQkFDUixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDbEIsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDcEI7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDcEI7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDckI7WUFDRCxhQUFhLEVBQUU7Z0JBQ2IsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDckI7U0FDRixDQUFDO1FBRUYsT0FBTyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2QyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FB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QUM7WUFDdEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqRCxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hY200L0RvY3VtZW50cy9Qcm9qZWsvQlVNQVNhbnNvci9iYWNrZW5kL3NyYy9yZXBvcnRzL3JlcG9ydHMuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcG9ydHNTZXJ2aWNlIH0gZnJvbSAnLi9yZXBvcnRzLnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnUmVwb3J0c1NlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBSZXBvcnRzU2VydmljZTtcbiAgbGV0IHByaXNtYTogYW55O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHByaXNtYSA9IHtcbiAgICAgIHNhbGU6IHtcbiAgICAgICAgYWdncmVnYXRlOiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgcmVjZWl2YWJsZToge1xuICAgICAgICBhZ2dyZWdhdGU6IGplc3QuZm4oKSxcbiAgICAgICAgZmluZE1hbnk6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICB3YXJ1bmc6IHtcbiAgICAgICAgY291bnQ6IGplc3QuZm4oKSxcbiAgICAgICAgZmluZE1hbnk6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICBzdG9jazoge1xuICAgICAgICBmaW5kTWFueTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICAgIHNhbGVJdGVtOiB7XG4gICAgICAgIGdyb3VwQnk6IGplc3QuZm4oKSxcbiAgICAgICAgZmluZE1hbnk6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICBwcm9kdWN0OiB7XG4gICAgICAgIGZpbmRNYW55OiBqZXN0LmZuKCksXG4gICAgICB9LFxuICAgICAgcGF5bWVudDoge1xuICAgICAgICBhZ2dyZWdhdGU6IGplc3QuZm4oKSxcbiAgICAgIH0sXG4gICAgICBwdXJjaGFzZU9yZGVyOiB7XG4gICAgICAgIGFnZ3JlZ2F0ZTogamVzdC5mbigpLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgc2VydmljZSA9IG5ldyBSZXBvcnRzU2VydmljZShwcmlzbWEpO1xuICB9KTtcblxuICBkZXNjcmliZSgnZGFzaGJvYXJkJywgKCkgPT4ge1xuICAgIGl0KCdyZXR1cm5zIGV4cGVjdGVkIGRhc2hib2FyZCBzaGFwZScsIGFzeW5jICgpID0+IHtcbiAgICAgIHByaXNtYS5zYWxlLmFnZ3JlZ2F0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIF9zdW06IHsgdG90YWxBbW91bnQ6IDEwMDAsIHBhaWRBbW91bnQ6IDgwMCB9LFxuICAgICAgICBfY291bnQ6IDIsXG4gICAgICB9KTtcbiAgICAgIHByaXNtYS5yZWNlaXZhYmxlLmFnZ3JlZ2F0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7IF9zdW06IHsgYmFsYW5jZTogMjAwIH0gfSk7XG4gICAgICBwcmlzbWEud2FydW5nLmNvdW50Lm1vY2tSZXNvbHZlZFZhbHVlT25jZSg1KS5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2UoMSk7XG5cbiAgICAgIHByaXNtYS5zdG9jay5maW5kTWFueS5tb2NrUmVzb2x2ZWRWYWx1ZShbXG4gICAgICAgIHsgcXVhbnRpdHk6IDEsIG1pblN0b2NrOiAxMCwgcHJvZHVjdDogeyBidXlQcmljZTogMTAwIH0gfSxcbiAgICAgICAgeyBxdWFudGl0eTogMjAsIG1pblN0b2NrOiAxMCwgcHJvZHVjdDogeyBidXlQcmljZTogNTAgfSB9LFxuICAgICAgXSk7XG5cbiAgICAgIHByaXNtYS5zYWxlSXRlbS5ncm91cEJ5Lm1vY2tSZXNvbHZlZFZhbHVlKFtcbiAgICAgICAgeyBwcm9kdWN0SWQ6ICdwLTEnLCBfc3VtOiB7IHF1YW50aXR5OiAxMCwgc3VidG90YWw6IDUwMCB9IH0sXG4gICAgICBdKTtcbiAgICAgIHByaXNtYS5wcm9kdWN0LmZpbmRNYW55Lm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAncC0xJywgbmFtZTogJ1AxJywgYmFyY29kZTogJ0IxJyB9XSk7XG4gICAgICBwcmlzbWEuc2FsZUl0ZW0uZmluZE1hbnkubW9ja1Jlc29sdmVkVmFsdWUoW1xuICAgICAgICB7IHF1YW50aXR5OiAyLCBwcmljZTogMTAsIHByb2R1Y3Q6IHsgYnV5UHJpY2U6IDcgfSB9LFxuICAgICAgXSk7XG4gICAgICBwcmlzbWEucGF5bWVudC5hZ2dyZWdhdGUubW9ja1Jlc29sdmVkVmFsdWUoeyBfc3VtOiB7IGFtb3VudDogNTAgfSwgX2NvdW50OiAxIH0pO1xuICAgICAgcHJpc21hLnB1cmNoYXNlT3JkZXIuYWdncmVnYXRlLm1vY2tSZXNvbHZlZFZhbHVlKHsgX3N1bTogeyB0b3RhbEFtb3VudDogMCB9IH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmRhc2hib2FyZCgpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgndG9kYXknKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdyZWNlaXZhYmxlcycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3dhcnVuZ3MnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdzdG9ja3MnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCd0b3BQcm9kdWN0cycpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnRvZGF5Lm9temV0KS50b0JlKDEwMDApO1xuICAgICAgZXhwZWN0KHJlc3VsdC50b2RheS5jYXNoSW4pLnRvQmUoODAwKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudG9kYXkucHJvZml0RXN0aW1hdGUpLnRvQmUoNik7XG4gICAgICBleHBlY3QocmVzdWx0LnJlY2VpdmFibGVzLm91dHN0YW5kaW5nKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QocmVzdWx0LndhcnVuZ3MuYWN0aXZlKS50b0JlKDUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC53YXJ1bmdzLmJsb2NrZWQpLnRvQmUoMSk7XG4gICAgICBleHBlY3QocmVzdWx0LnN0b2Nrcy5sb3dTdG9ja0NvdW50KS50b0JlKDEpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9