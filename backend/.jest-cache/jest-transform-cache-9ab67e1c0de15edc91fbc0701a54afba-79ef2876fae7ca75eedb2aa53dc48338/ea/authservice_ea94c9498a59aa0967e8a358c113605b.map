{"file":"/Users/macm4/Documents/Projek/BUMASansor/backend/src/auth/auth.service.ts","mappings":";;;;;;;;;;;;AAAA,2CAAwF;AACxF,2CAA+C;AAC/C,qCAAyC;AACzC,iCAAiC;AACjC,6DAAyD;AACzD,0DAAsD;AACtD,yDAAiD;AAO1C,IAAM,WAAW,GAAjB,MAAM,WAAW;IACtB,YACmB,YAA0B,EAC1B,UAAsB,EACtB,MAAqB,EACrB,aAA4B;QAH5B,iBAAY,GAAZ,YAAY,CAAc;QAC1B,eAAU,GAAV,UAAU,CAAY;QACtB,WAAM,GAAN,MAAM,CAAe;QACrB,kBAAa,GAAb,aAAa,CAAe;IAC5C,CAAC;IAEJ,KAAK,CAAC,QAAQ,CAAC,GAAgB;QAC7B,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAChE,IAAI,QAAQ,EAAE,CAAC;YACb,MAAM,IAAI,4BAAmB,CAAC,0BAA0B,CAAC,CAAC;QAC5D,CAAC;QAED,IAAI,GAAG,CAAC,IAAI,KAAK,gBAAI,CAAC,MAAM,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC;YAC9C,MAAM,IAAI,4BAAmB,CAAC,sCAAsC,CAAC,CAAC;QACxE,CAAC;QAED,MAAM,gBAAgB,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAkB,oBAAoB,EAAE,EAAE,CAAC,CAAC;QAC3F,MAAM,gBAAgB,GACpB,OAAO,gBAAgB,KAAK,QAAQ;YAClC,CAAC,CAAC,gBAAgB;YAClB,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,gBAAgB,EAAE,EAAE,CAAC,CAAC;QAC5C,MAAM,UAAU,GACd,MAAM,CAAC,QAAQ,CAAC,gBAAgB,CAAC,IAAI,gBAAgB,GAAG,CAAC,CAAC,CAAC,CAAC,gBAAgB,CAAC,CAAC,CAAC,EAAE,CAAC;QACpF,MAAM,cAAc,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,UAAU,CAAC,CAAC;QAEnE,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC;YAC1C,KAAK,EAAE,GAAG,CAAC,KAAK;YAChB,QAAQ,EAAE,cAAc;YACxB,IAAI,EAAE,GAAG,CAAC,IAAI;YACd,IAAI,EAAE,GAAG,CAAC,IAAI;YACd,MAAM,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE,EAAE,EAAE,GAAG,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS;SACrE,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;IACjC,CAAC;IAED,KAAK,CAAC,KAAK,CAAC,GAAa;QACvB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAC5D,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,8BAAqB,CAAC,qBAAqB,CAAC,CAAC;QACzD,CAAC;QAED,MAAM,KAAK,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;QAChE,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,MAAM,IAAI,8BAAqB,CAAC,qBAAqB,CAAC,CAAC;QACzD,CAAC;QAED,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,IAAY,CAAC,CAAC;QACnF,OAAO;YACL,GAAG,QAAQ;YACX,IAAI,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;SAC9B,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,GAAoB;QAChC,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAChE,MAAM,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC;QAE3B,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;QACtD,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,8BAAqB,CAAC,eAAe,CAAC,CAAC;QACnD,CAAC;QAED,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,QAAQ,CAAC;YAC3D,KAAK,EAAE;gBACL,MAAM;gBACN,SAAS,EAAE,IAAI;gBACf,SAAS,EAAE,EAAE,EAAE,EAAE,IAAI,IAAI,EAAE,EAAE;aAC9B;SACF,CAAC,CAAC;QAEH,IAAI,eAAe,GAAkB,IAAI,CAAC;QAC1C,KAAK,MAAM,QAAQ,IAAI,YAAY,EAAE,CAAC;YACpC,MAAM,KAAK,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,QAAQ,CAAC,SAAS,CAAC,CAAC;YACzE,IAAI,KAAK,EAAE,CAAC;gBACV,eAAe,GAAG,QAAQ,CAAC,EAAE,CAAC;gBAC9B,MAAM;YACR,CAAC;QACH,CAAC;QAED,IAAI,CAAC,eAAe,EAAE,CAAC;YACrB,MAAM,IAAI,8BAAqB,CAAC,8BAA8B,CAAC,CAAC;QAClE,CAAC;QAED,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC;YACpC,KAAK,EAAE,EAAE,EAAE,EAAE,eAAe,EAAE;YAC9B,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;SAChC,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,IAAY,CAAC,CAAC;IACrE,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,MAAc,EAAE,YAAqB;QAChD,IAAI,CAAC,YAAY,EAAE,CAAC;YAClB,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,UAAU,CAAC;gBACxC,KAAK,EAAE,EAAE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE;gBAClC,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;aAChC,CAAC,CAAC;YACH,OAAO,EAAE,OAAO,EAAE,8BAA8B,EAAE,CAAC;QACrD,CAAC;QAED,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,QAAQ,CAAC;YAC3D,KAAK,EAAE,EAAE,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE;SACnC,CAAC,CAAC;QAEH,IAAI,OAAO,GAAkB,IAAI,CAAC;QAClC,KAAK,MAAM,QAAQ,IAAI,YAAY,EAAE,CAAC;YACpC,MAAM,KAAK,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,YAAY,EAAE,QAAQ,CAAC,SAAS,CAAC,CAAC;YACrE,IAAI,KAAK,EAAE,CAAC;gBACV,OAAO,GAAG,QAAQ,CAAC,EAAE,CAAC;gBACtB,MAAM;YACR,CAAC;QACH,CAAC;QAED,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,IAAI,8BAAqB,CAAC,yBAAyB,CAAC,CAAC;QAC7D,CAAC;QAED,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC;YACpC,KAAK,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE;YACtB,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;SAChC,CAAC,CAAC;QAEH,OAAO,EAAE,OAAO,EAAE,YAAY,EAAE,CAAC;IACnC,CAAC;IAED,KAAK,CAAC,EAAE,CAAC,MAAc;QACrB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC;QACzD,OAAO,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;IACjC,CAAC;IAEO,KAAK,CAAC,cAAc,CAAC,MAAc,EAAE,KAAa,EAAE,IAAU;QACpE,MAAM,OAAO,GAAe,EAAE,GAAG,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC;QAEzD,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,OAAO,EAAE;YAC3D,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,GAAG,CAAS,mBAAmB,EAAE,eAAe,CAAC;YAC5E,SAAS,EAAE,IAAI,CAAC,aAAa,CAAC,GAAG,CAAS,uBAAuB,EAAE,KAAK,CAAQ;SACjF,CAAC,CAAC;QAEH,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,OAAO,EAAE;YAC5D,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,GAAG,CAAS,oBAAoB,EAAE,gBAAgB,CAAC;YAC9E,SAAS,EAAE,IAAI,CAAC,aAAa,CAAC,GAAG,CAAS,wBAAwB,EAAE,IAAI,CAAQ;SACjF,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,YAAY,CAAqB,CAAC;QACzE,MAAM,SAAS,GAAG,OAAO,EAAE,GAAG;YAC5B,CAAC,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,GAAG,IAAI,CAAC;YAC9B,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,QAAQ,CAAC,CAAC;QAExC,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,YAAY,EAAE,EAAE,CAAC,CAAC;QACtD,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC;YACpC,IAAI,EAAE;gBACJ,MAAM;gBACN,SAAS;gBACT,SAAS;aACV;SACF,CAAC,CAAC;QAEH,OAAO,EAAE,WAAW,EAAE,YAAY,EAAE,CAAC;IACvC,CAAC;IAEO,KAAK,CAAC,kBAAkB,CAAC,KAAa;QAC5C,IAAI,CAAC;YACH,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,WAAW,CAAa,KAAK,EAAE;gBAC1D,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,GAAG,CAAS,oBAAoB,EAAE,gBAAgB,CAAC;aAC/E,CAAC,CAAC;QACL,CAAC;QAAC,MAAM,CAAC;YACP,MAAM,IAAI,8BAAqB,CAAC,uBAAuB,CAAC,CAAC;QAC3D,CAAC;IACH,CAAC;IAEO,YAAY,CAAC,IAQpB;QACC,OAAO;YACL,EAAE,EAAE,IAAI,CAAC,EAAE;YACX,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,SAAS,EAAE,IAAI,CAAC,SAAS;SAC1B,CAAC;IACJ,CAAC;CACF,CAAA;AAhMY,kCAAW;sBAAX,WAAW;IADvB,IAAA,mBAAU,GAAE;qCAGsB,4BAAY;QACd,gBAAU;QACd,8BAAa;QACN,sBAAa;GALpC,WAAW,CAgMvB","names":[],"sources":["/Users/macm4/Documents/Projek/BUMASansor/backend/src/auth/auth.service.ts"],"sourcesContent":["import { BadRequestException, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcrypt';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { UsersService } from '../users/users.service';\nimport { Role } from '../common/enums/role.enum';\nimport { JwtPayload } from '../common/interfaces/jwt-payload.interface';\nimport { LoginDto } from './dto/login.dto';\nimport { RefreshTokenDto } from './dto/refresh-token.dto';\nimport { RegisterDto } from './dto/register.dto';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly usersService: UsersService,\n    private readonly jwtService: JwtService,\n    private readonly prisma: PrismaService,\n    private readonly configService: ConfigService,\n  ) {}\n\n  async register(dto: RegisterDto) {\n    const existing = await this.usersService.findByEmail(dto.email);\n    if (existing) {\n      throw new BadRequestException('Email already registered');\n    }\n\n    if (dto.role === Role.WARUNG && !dto.warungId) {\n      throw new BadRequestException('warungId is required for WARUNG role');\n    }\n\n    const saltRoundsConfig = this.configService.get<string | number>('BCRYPT_SALT_ROUNDS', 10);\n    const parsedSaltRounds =\n      typeof saltRoundsConfig === 'number'\n        ? saltRoundsConfig\n        : Number.parseInt(saltRoundsConfig, 10);\n    const saltRounds =\n      Number.isFinite(parsedSaltRounds) && parsedSaltRounds > 0 ? parsedSaltRounds : 10;\n    const hashedPassword = await bcrypt.hash(dto.password, saltRounds);\n\n    const user = await this.usersService.create({\n      email: dto.email,\n      password: hashedPassword,\n      name: dto.name,\n      role: dto.role,\n      warung: dto.warungId ? { connect: { id: dto.warungId } } : undefined,\n    });\n\n    return this.sanitizeUser(user);\n  }\n\n  async login(dto: LoginDto) {\n    const user = await this.usersService.findByEmail(dto.email);\n    if (!user) {\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    const valid = await bcrypt.compare(dto.password, user.password);\n    if (!valid) {\n      throw new UnauthorizedException('Invalid credentials');\n    }\n\n    const tokenSet = await this.issueTokenPair(user.id, user.email, user.role as Role);\n    return {\n      ...tokenSet,\n      user: this.sanitizeUser(user),\n    };\n  }\n\n  async refresh(dto: RefreshTokenDto) {\n    const payload = await this.verifyRefreshToken(dto.refreshToken);\n    const userId = payload.sub;\n\n    const user = await this.usersService.findById(userId);\n    if (!user) {\n      throw new UnauthorizedException('Invalid token');\n    }\n\n    const activeTokens = await this.prisma.refreshToken.findMany({\n      where: {\n        userId,\n        revokedAt: null,\n        expiresAt: { gt: new Date() },\n      },\n    });\n\n    let matchingTokenId: string | null = null;\n    for (const tokenRow of activeTokens) {\n      const match = await bcrypt.compare(dto.refreshToken, tokenRow.tokenHash);\n      if (match) {\n        matchingTokenId = tokenRow.id;\n        break;\n      }\n    }\n\n    if (!matchingTokenId) {\n      throw new UnauthorizedException('Refresh token not recognized');\n    }\n\n    await this.prisma.refreshToken.update({\n      where: { id: matchingTokenId },\n      data: { revokedAt: new Date() },\n    });\n\n    return this.issueTokenPair(user.id, user.email, user.role as Role);\n  }\n\n  async logout(userId: string, refreshToken?: string) {\n    if (!refreshToken) {\n      await this.prisma.refreshToken.updateMany({\n        where: { userId, revokedAt: null },\n        data: { revokedAt: new Date() },\n      });\n      return { message: 'Logged out from all sessions' };\n    }\n\n    const activeTokens = await this.prisma.refreshToken.findMany({\n      where: { userId, revokedAt: null },\n    });\n\n    let tokenId: string | null = null;\n    for (const tokenRow of activeTokens) {\n      const match = await bcrypt.compare(refreshToken, tokenRow.tokenHash);\n      if (match) {\n        tokenId = tokenRow.id;\n        break;\n      }\n    }\n\n    if (!tokenId) {\n      throw new UnauthorizedException('Refresh token not found');\n    }\n\n    await this.prisma.refreshToken.update({\n      where: { id: tokenId },\n      data: { revokedAt: new Date() },\n    });\n\n    return { message: 'Logged out' };\n  }\n\n  async me(userId: string) {\n    const user = await this.usersService.findOrThrow(userId);\n    return this.sanitizeUser(user);\n  }\n\n  private async issueTokenPair(userId: string, email: string, role: Role) {\n    const payload: JwtPayload = { sub: userId, email, role };\n\n    const accessToken = await this.jwtService.signAsync(payload, {\n      secret: this.configService.get<string>('JWT_ACCESS_SECRET', 'access-secret'),\n      expiresIn: this.configService.get<string>('JWT_ACCESS_EXPIRES_IN', '15m') as any,\n    });\n\n    const refreshToken = await this.jwtService.signAsync(payload, {\n      secret: this.configService.get<string>('JWT_REFRESH_SECRET', 'refresh-secret'),\n      expiresIn: this.configService.get<string>('JWT_REFRESH_EXPIRES_IN', '7d') as any,\n    });\n\n    const decoded = this.jwtService.decode(refreshToken) as { exp?: number };\n    const expiresAt = decoded?.exp\n      ? new Date(decoded.exp * 1000)\n      : new Date(Date.now() + 7 * 86400000);\n\n    const tokenHash = await bcrypt.hash(refreshToken, 10);\n    await this.prisma.refreshToken.create({\n      data: {\n        userId,\n        tokenHash,\n        expiresAt,\n      },\n    });\n\n    return { accessToken, refreshToken };\n  }\n\n  private async verifyRefreshToken(token: string): Promise<JwtPayload> {\n    try {\n      return await this.jwtService.verifyAsync<JwtPayload>(token, {\n        secret: this.configService.get<string>('JWT_REFRESH_SECRET', 'refresh-secret'),\n      });\n    } catch {\n      throw new UnauthorizedException('Invalid refresh token');\n    }\n  }\n\n  private sanitizeUser(user: {\n    id: string;\n    email: string;\n    name: string;\n    role: string;\n    warungId: string | null;\n    createdAt: Date;\n    updatedAt: Date;\n  }) {\n    return {\n      id: user.id,\n      email: user.email,\n      name: user.name,\n      role: user.role,\n      warungId: user.warungId,\n      createdAt: user.createdAt,\n      updatedAt: user.updatedAt,\n    };\n  }\n}\n"],"version":3}