{"file":"/Users/macm4/Documents/Projek/BUMASansor/backend/src/stocks/stocks.service.spec.ts","mappings":"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","names":[],"sources":["/Users/macm4/Documents/Projek/BUMASansor/backend/src/stocks/stocks.service.spec.ts"],"sourcesContent":["import { BadRequestException } from '@nestjs/common';\nimport { StocksService } from './stocks.service';\n\ndescribe('StocksService', () => {\n  let service: StocksService;\n  let prisma: any;\n  let realtime: any;\n\n  beforeEach(() => {\n    prisma = {\n      product: {\n        findFirst: jest.fn(),\n      },\n      stock: {\n        findUnique: jest.fn(),\n        upsert: jest.fn(),\n        update: jest.fn(),\n        findMany: jest.fn(),\n      },\n      warehouse: {\n        findFirst: jest.fn(),\n      },\n      stockMovement: {\n        create: jest.fn(),\n        findMany: jest.fn(),\n      },\n      stockOpname: {\n        create: jest.fn(),\n      },\n      $transaction: jest.fn(),\n    };\n\n    prisma.$transaction.mockImplementation(async (cb: any) => cb(prisma));\n\n    realtime = { emit: jest.fn() };\n    service = new StocksService(prisma, realtime);\n  });\n\n  describe('recordMovement', () => {\n    it('throws when IN movement missing toWarehouseId', async () => {\n      prisma.product.findFirst.mockResolvedValue({ id: 'p-1' });\n\n      await expect(\n        service.recordMovement(\n          {\n            movementType: 'IN',\n            productId: 'p-1',\n            quantity: 1,\n          } as any,\n          'u-1',\n        ),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n\n    it('throws when OUT movement insufficient stock', async () => {\n      prisma.product.findFirst.mockResolvedValue({ id: 'p-1' });\n      prisma.warehouse.findFirst.mockResolvedValue({ id: 'wh-1' });\n      prisma.stock.findUnique.mockResolvedValue({ quantity: 0 });\n\n      await expect(\n        service.recordMovement(\n          {\n            movementType: 'OUT',\n            productId: 'p-1',\n            fromWarehouseId: 'wh-1',\n            quantity: 10,\n          } as any,\n          'u-1',\n        ),\n      ).rejects.toBeInstanceOf(BadRequestException);\n    });\n  });\n\n  describe('performOpname', () => {\n    it('records opname and adjustment movement', async () => {\n      prisma.product.findFirst.mockResolvedValue({ id: 'p-1' });\n      prisma.warehouse.findFirst.mockResolvedValue({ id: 'wh-1' });\n\n      prisma.stock.upsert.mockResolvedValue({ warehouseId: 'wh-1', productId: 'p-1', quantity: 5 });\n      prisma.stock.update.mockResolvedValue({ warehouseId: 'wh-1', productId: 'p-1', quantity: 8 });\n      prisma.stockOpname.create.mockResolvedValue({ id: 'op-1' });\n      prisma.stockMovement.create.mockResolvedValue({ id: 'mv-1' });\n\n      const result = await service.performOpname(\n        {\n          warehouseId: 'wh-1',\n          productId: 'p-1',\n          actualQty: 8,\n          reason: 'count',\n        } as any,\n        'u-1',\n      );\n\n      expect(prisma.stock.update).toHaveBeenCalledWith(\n        expect.objectContaining({\n          data: { quantity: 8 },\n        }),\n      );\n\n      expect(prisma.stockOpname.create).toHaveBeenCalledWith(\n        expect.objectContaining({\n          data: expect.objectContaining({\n            systemQty: 5,\n            actualQty: 8,\n            difference: 3,\n            reason: 'count',\n            performedBy: 'u-1',\n          }),\n        }),\n      );\n\n      expect(prisma.stockMovement.create).toHaveBeenCalledWith(\n        expect.objectContaining({\n          data: expect.objectContaining({\n            movementType: 'ADJUSTMENT',\n            quantity: 3,\n            referenceType: 'OPNAME',\n            referenceId: 'op-1',\n          }),\n        }),\n      );\n\n      expect(result).toHaveProperty('opname');\n      expect(result).toHaveProperty('stock');\n    });\n  });\n});\n"],"version":3}