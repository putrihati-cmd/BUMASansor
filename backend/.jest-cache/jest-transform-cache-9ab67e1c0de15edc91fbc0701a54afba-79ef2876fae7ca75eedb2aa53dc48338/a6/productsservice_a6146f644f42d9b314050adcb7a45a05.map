{"file":"/Users/macm4/Documents/Projek/BUMASansor/backend/src/products/products.service.ts","mappings":"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","names":[],"sources":["/Users/macm4/Documents/Projek/BUMASansor/backend/src/products/products.service.ts"],"sourcesContent":["import { BadRequestException, Injectable, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '../prisma/prisma.service';\nimport { CreateProductDto } from './dto/create-product.dto';\nimport { QueryProductDto } from './dto/query-product.dto';\nimport { UpdateProductDto } from './dto/update-product.dto';\n\n@Injectable()\nexport class ProductsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async list(query: QueryProductDto) {\n    const page = query.page ?? 1;\n    const limit = query.limit ?? 10;\n\n    const where = {\n      deletedAt: null,\n      ...(query.search\n        ? {\n            OR: [\n              { name: { contains: query.search, mode: 'insensitive' as const } },\n              { barcode: { contains: query.search, mode: 'insensitive' as const } },\n            ],\n          }\n        : {}),\n      ...(query.categoryId ? { categoryId: query.categoryId } : {}),\n      ...(query.isActive !== undefined ? { isActive: query.isActive } : {}),\n    };\n\n    const [items, total] = await this.prisma.$transaction([\n      this.prisma.product.findMany({\n        where,\n        include: { category: true },\n        orderBy: { createdAt: 'desc' },\n        skip: (page - 1) * limit,\n        take: limit,\n      }),\n      this.prisma.product.count({ where }),\n    ]);\n\n    return {\n      items,\n      meta: {\n        page,\n        limit,\n        total,\n        totalPages: Math.ceil(total / limit),\n      },\n    };\n  }\n\n  async findOne(id: string) {\n    const product = await this.prisma.product.findFirst({\n      where: { id, deletedAt: null },\n      include: { category: true },\n    });\n\n    if (!product) {\n      throw new NotFoundException('Product not found');\n    }\n\n    return product;\n  }\n\n  async findByBarcode(barcode: string) {\n    const product = await this.prisma.product.findFirst({\n      where: { barcode, deletedAt: null },\n      include: { category: true },\n    });\n\n    if (!product) {\n      throw new NotFoundException('Product not found');\n    }\n\n    return product;\n  }\n\n  async create(dto: CreateProductDto) {\n    const category = await this.prisma.category.findFirst({\n      where: { id: dto.categoryId, deletedAt: null },\n    });\n\n    if (!category) {\n      throw new BadRequestException('Category not found');\n    }\n\n    const barcode = dto.barcode ?? (await this.generateBarcode());\n    const margin = this.calculateMargin(dto.buyPrice, dto.sellPrice);\n\n    return this.prisma.product.create({\n      data: {\n        ...dto,\n        barcode,\n        margin,\n      },\n      include: { category: true },\n    });\n  }\n\n  async update(id: string, dto: UpdateProductDto) {\n    const existing = await this.findOne(id);\n\n    const buyPrice = dto.buyPrice ?? Number(existing.buyPrice);\n    const sellPrice = dto.sellPrice ?? Number(existing.sellPrice);\n\n    return this.prisma.product.update({\n      where: { id },\n      data: {\n        ...dto,\n        margin: this.calculateMargin(buyPrice, sellPrice),\n      },\n      include: { category: true },\n    });\n  }\n\n  async remove(id: string) {\n    await this.findOne(id);\n    return this.prisma.product.update({\n      where: { id },\n      data: { deletedAt: new Date() },\n    });\n  }\n\n  async bulkImport(rows: CreateProductDto[]) {\n    const created = [];\n    for (const row of rows) {\n      created.push(await this.create(row));\n    }\n    return {\n      total: created.length,\n      items: created,\n    };\n  }\n\n  export() {\n    return this.prisma.product.findMany({\n      where: { deletedAt: null },\n      include: { category: true },\n      orderBy: { name: 'asc' },\n    });\n  }\n\n  private calculateMargin(buyPrice: number, sellPrice: number): number {\n    if (buyPrice <= 0) {\n      return 0;\n    }\n    return Number((((sellPrice - buyPrice) / buyPrice) * 100).toFixed(2));\n  }\n\n  private async generateBarcode(): Promise<string> {\n    for (let i = 0; i < 10; i += 1) {\n      const digits = Math.floor(10000 + Math.random() * 90000).toString();\n      const barcode = `BM${digits}`;\n      const exists = await this.prisma.product.findFirst({ where: { barcode } });\n      if (!exists) {\n        return barcode;\n      }\n    }\n    throw new BadRequestException('Failed to generate barcode');\n  }\n}\n"],"version":3}